---
id: 827
title: æç®€v2rayæµé‡ç»Ÿè®¡é¢æ¿
date: 2025-08-26 00:12:13+00:00
author: coffeecat
layout: post
categories:
- ç§‘å­¦ä¸Šç½‘
tags:
- python
- html
- nginx
---

v2rayè‡ªå¸¦æµé‡ç»Ÿè®¡åŠŸèƒ½ï¼Œæ‰§è¡Œå¦‚ä¸‹è¯­å¥å°±èƒ½è·å¾—å®æ—¶ç´¯è®¡æµé‡ï¼š
```bash

/usr/bin/v2ray/v2ray api stats --server=127.0.0.1:10085

    Value       Name
1   22.62KB     inbound>>>api>>>traffic>>>downlink
2   13.01KB     inbound>>>api>>>traffic>>>uplink
3   26.40MB     inbound>>>main>>>traffic>>>downlink
4   11.36MB     inbound>>>main>>>traffic>>>uplink
5   10.92MB     user>>>home>>>traffic>>>downlink
6   4.51MB      user>>>home>>>traffic>>>uplink
7   15.47MB     user>>>mobile>>>traffic>>>downlink
8   6.76MB      user>>>mobile>>>traffic>>>uplink

Total: 75.45MB

```
ä½†æ˜¯é‡å¯æœåŠ¡ä»¥åï¼Œæµé‡å°±æ¸…é›¶äº†ï¼Œä¸ºäº†æŒä¹…åŒ–ï¼Œæˆ‘åšäº†ä¸€ä¸ªæç®€çš„ç»Ÿè®¡v2rayæµé‡çš„webé¢æ¿ï¼Œæ”¯æŒæŒ‰ç”¨æˆ·ç»Ÿè®¡ï¼Œæ¯æœˆåˆæ¸…é›¶ï¼Œå¹¶é€šè¿‡å£ä»¤æ§åˆ¶è®¿é—®æƒé™ã€‚

çº¯é™æ€é¡µé¢ï¼åªéœ€è¦å®‰è£…python3å’Œä»»ä¸€ä¸€ä¸ªwebæœåŠ¡ç«¯å³å¯ï¼Œæˆ‘è¿™é‡Œç”¨çš„æ˜¯nginxã€‚

æ­¥éª¤å¦‚ä¸‹ï¼š

1. ä¿®æ”¹v2rayé…ç½®æ–‡ä»¶ï¼Œå¢åŠ æµé‡ç»Ÿè®¡ï¼ˆæ³¨æ„ï¼šé…ç½®æ–‡ä»¶ä¸­çš„emailæ˜¯å¿…é¡»çš„ï¼Œç”¨äºåŒºåˆ†ä¸åŒç”¨æˆ·çš„æµé‡ï¼‰ï¼š
```vim
{
  "stats": {},
  "api": {
    "tag": "api",
    "services": [
      "StatsService"
    ]
  },
  "policy": {
    "levels": {
      "0": {
        "statsUserUplink": true,
        "statsUserDownlink": true
      }
    },
    "system": {
      "statsInboundUplink": true,
      "statsInboundDownlink": true
    }
  },
  "inbounds": [
    {
      "port": 23456,
      "listen":"127.0.0.1",
      "protocol": "vless",
      "settings": {
        "clients": [
          {
            "email": "user1",
            "id": "****************uuid1****************"
          },
          {
            "email": "user2",
            "id": "****************uuid2****************"
          },
	        {
            "email": "user3",
	          "id": "****************uuid3****************"
	        }
	      ],
        "decryption": "none"
      },
      "streamSettings": {
        "network": "ws",
        "wsSettings": {
        "path": "/mypath"
        }
      },
      "tag": "main"
    },
    {
      "tag": "api",
      "protocol": "dokodemo-door",
      "listen": "127.0.0.1",
      "port": 10085,
      "settings": {
        "address": "127.0.0.1"
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "socks",
      "settings": {
        "servers": [
          {
            "address": "127.0.0.1",
            "port": 40000
          }
        ]
      },
      "tag": "warp"
    },
    {
      "protocol": "freedom",
      "tag": "direct"
    }
  ],
  "routing": {
    "domainStrategy": "AsIs",
    "rules": [
      {
        "type": "field",
        "inboundTag":["main"],
        "outboundTag": "direct",
        "domain": [
          "geosite:netflix",
          "geosite:youtube",
	        "openai.com",
	        "*.openai.com",
	        "chatgpt.com",
	        "*.chatgpt.com"
        ]
      },
      {
        "type": "field",
        "inboundTag":["main"],
        "outboundTag": "direct",
        "ip": [
            "127.0.0.1", 
            "::1",
            "8.8.8.8",
            "8.8.4.4",
            "1.1.1.1"
        ]
      },
      {
	      "type":"field",
        "inboundTag":["main"],
	      "outboundTag":"warp",
	      "network":"tcp,udp"
      },
      {
        "type": "field",
        "inboundTag": [
          "api"
        ],
        "outboundTag": "api"
      }
    ]
  }
}
```

2. åœ¨nginxé¡µé¢æ ¹ç›®å½•ä¸‹åˆ›å»ºindex.htmlï¼Œæˆ‘è¿™é‡Œæ˜¯ubuntuï¼Œè·¯å¾„æ˜¯ï¼š/usr/share/nginx/html/ ï¼Œå†…å®¹å¦‚ä¸‹ï¼š
```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç™»å½•</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
* { box-sizing: border-box; }
body {
    font-family: 'Arial', sans-serif;
    background: linear-gradient(135deg, #6fb1fc, #4364f7);
    margin: 0;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
}
.login-container, .stats-container {
    background: #fff;
    padding: 40px 30px;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    width: 100%;
    max-width: 600px;
    text-align: center;
}
h2 {
    margin-bottom: 25px;
    color: #4364f7;
    font-size: 24px;
}
.input-group {
    position: relative;
    margin-bottom: 20px;
    width: 100%;
}
.input-group i {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #888;
    pointer-events: none;
}
input[type="password"] {
    width: 100%;
    padding: 12px 12px 12px 36px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 16px;
    transition: border 0.3s, box-shadow 0.3s;
}
input[type="password"]:focus {
    outline: none;
    border-color: #4364f7;
    box-shadow: 0 0 5px rgba(67,100,247,0.5);
}
button {
    width: 100%;
    padding: 12px;
    background-color: #4364f7;
    border: none;
    border-radius: 6px;
    color: #fff;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s;
}
button:hover {
    background-color: #6fb1fc;
    transform: translateY(-2px);
}
.footer {
    margin-top: 15px;
    font-size: 13px;
    color: #888;
}
.stats-content {
    text-align: left;
    max-height: 70vh;
    overflow: auto;
}
.stats-content table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}
.stats-content th, .stats-content td {
    border: 1px solid #ddd;
    padding: 8px;
}
.stats-content th {
    background: #4364f7;
    color: white;
}
.stats-content tr:nth-child(even) { background: #f9f9f9; }
.stats-content tr:hover { background: #e9f5ff; }
</style>
</head>
<body>
<div class="login-container" id="loginBox">
    <h2><i class="fas fa-shield-alt"></i> ç™»å½•</h2>
    <div class="input-group">
        <i class="fas fa-key"></i>
        <input type="password" id="key" placeholder="è¯·è¾“å…¥å£ä»¤">
    </div>
    <button onclick="decrypt()">éªŒè¯</button>
    <div class="footer">è¯·è¾“å…¥å£ä»¤</div>
</div>

<div class="stats-container" id="statsBox" style="display:none;">
    <div class="stats-content" id="statsContent">
        <!-- è§£å¯†åçš„å†…å®¹ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script>
document.getElementById("key").addEventListener("keyup", function(event) {
    if (event.key === "Enter") {
        decrypt();
    }
});

async function decrypt() {
    const keyInput = document.getElementById("key").value;
    if (!keyInput) return alert("è¯·è¾“å…¥å£ä»¤");

    try {
        const resp = await fetch("encrypt.txt");
        const b64 = await resp.text();
        const raw = CryptoJS.enc.Base64.parse(b64);
        const rawHex = raw.toString(CryptoJS.enc.Hex);

        const iv = CryptoJS.enc.Hex.parse(rawHex.slice(0, 32));
        const ct = CryptoJS.enc.Hex.parse(rawHex.slice(32));

        const keyStr = keyInput.padEnd(16, "\0").slice(0,16);
        const key = CryptoJS.enc.Utf8.parse(keyStr);

        const decrypted = CryptoJS.AES.decrypt({ciphertext: ct}, key, {
            iv: iv,
            mode: CryptoJS.mode.CBC,
            padding: CryptoJS.pad.Pkcs7
        });
        const decoded = decrypted.toString(CryptoJS.enc.Utf8);
        if (!decoded) throw "éªŒè¯å¤±è´¥";

        // éšè—ç™»å½•æ¡†ï¼Œæ˜¾ç¤ºç»Ÿè®¡å®¹å™¨
        document.getElementById("loginBox").style.display = "none";
        const statsBox = document.getElementById("statsBox");
        statsBox.style.display = "block";

        // è§£æè§£å¯†åçš„ HTMLï¼Œåªå– body å†…éƒ¨å†…å®¹ï¼Œé˜²æ­¢è¦†ç›–èƒŒæ™¯
        const parser = new DOMParser();
        const doc = parser.parseFromString(decoded, "text/html");
        const inner = doc.body ? doc.body.innerHTML : decoded;
        document.getElementById("statsContent").innerHTML = inner;

    } catch(e) {
        alert("éªŒè¯å¤±è´¥ï¼Œå£ä»¤é”™è¯¯");
    }
}
</script>
</body>
</html>
```

3. åˆ›å»ºpythonæ–‡ä»¶v2ray-stats.pyï¼Œæ”¾åœ¨/rootä¸‹ï¼Œæ–‡ä»¶ä¸­çš„keyå°±æ˜¯è®¿é—®å£ä»¤ï¼ˆé»˜è®¤123456ï¼‰ï¼Œå¯ä»¥æ”¹æˆè‡ªå·±çš„ï¼š
```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from Cryptodome.Cipher import AES
from Cryptodome.Util.Padding import pad, unpad
from Cryptodome.Random import get_random_bytes
import base64
import subprocess
import datetime
import os

API_CMD = ["/usr/bin/v2ray/v2ray", "api", "stats", "--server=127.0.0.1:10085"]
DATA_FILE = "/var/lib/v2ray-stats/data.db"
HTML_FILE = "/root/plaintext.html"
OUTPUT_FILE = "/usr/share/nginx/html/encrypt.txt"
#ç™»å½•å¯†é’¥
key = b"123456"

os.makedirs(os.path.dirname(DATA_FILE), exist_ok=True)
now = datetime.datetime.now()

# æ¯æœˆ1æ—¥0ç‚¹æ¸…é›¶ data.db
if now.day == 1 and now.hour == 0:
    open(DATA_FILE, "w").close()
    subprocess.run(["systemctl", "restart", "v2ray"], check=True)

# è¯»å–æ—§æ•°æ®
OLD = {}  # name -> (total_bytes, last_api_bytes)
if os.path.exists(DATA_FILE):
    with open(DATA_FILE, "r") as f:
        for line in f:
            parts = line.strip().split()
            if len(parts) == 3:
                name, total_str, last_str = parts
                try:
                    OLD[name] = (int(total_str), int(last_str))
                except:
                    OLD[name] = (0, 0)

# è°ƒç”¨ V2Ray API è·å–æœ¬æ¬¡ç´¯è®¡æµé‡
result = subprocess.run(API_CMD, capture_output=True, text=True)
lines = result.stdout.strip().splitlines()
stats_lines = lines[1:]  # è·³è¿‡æ ‡é¢˜

for line in stats_lines:
    line = line.strip()
    if line.startswith("Total:"):
        continue
    parts = line.split()
    if len(parts) < 2:
        continue
    value = parts[1]
    name = " ".join(parts[2:]) if len(parts) > 2 else ""
    name = name.replace(">", "-")

    # è½¬æ¢ä¸ºå­—èŠ‚
    try:
        num = float(value[:-2])
        unit = value[-2:]
    except:
        continue

    if unit == "B":
        current_bytes = int(num)
    elif unit == "KB":
        current_bytes = int(num * 1024)
    elif unit == "MB":
        current_bytes = int(num * 1024 * 1024)
    elif unit == "GB":
        current_bytes = int(num * 1024 * 1024 * 1024)
    else:
        current_bytes = 0

    total_prev, last_api_prev = OLD.get(name, (0, 0))
    delta = current_bytes - last_api_prev
    if delta < 0:  # V2Ray é‡å¯ï¼ŒAPI ç´¯è®¡ä»0å¼€å§‹
        delta = current_bytes
    total_new = total_prev + delta
    OLD[name] = (total_new, current_bytes)

# ä¿å­˜æœ€æ–°ç´¯è®¡åˆ° data.db
with open(DATA_FILE, "w") as f:
    for name, (total_bytes, last_api_bytes) in OLD.items():
        f.write(f"{name} {total_bytes} {last_api_bytes}\n")

# è‡ªåŠ¨å•ä½æ˜¾ç¤ºå‡½æ•°
def format_bytes(b):
    if b < 102.4:  # å°äº0.1 KB
        return f"{b:.2f} B"
    elif b < 1024*102.4:  # å°äº0.1 MB
        return f"{b/1024:.2f} KB"
    elif b < 1024*1024*102.4:  # å°äº0.1 GB
        return f"{b/1024/1024:.2f} MB"
    else:
        return f"{b/1024/1024/1024:.2f} GB"

# ç”Ÿæˆ HTML
html = '''<html>
<head>
<meta charset="utf-8">
<title>æœ¬æœˆæµé‡ç»Ÿè®¡</title>
<style>
body { font-family: Arial, sans-serif; background:#f4f6f9; color:#333; margin:40px; }
h2 { color:#007BFF; }
table { border-collapse: collapse; width: 60%; margin-top:20px; background:#fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
th { background:#007BFF; color:white; }
tr:nth-child(even) { background:#f9f9f9; }
tr:hover { background:#e9f5ff; }
.footer { margin-top:20px; font-size: 0.9em; color:#666; }
</style>
<meta http-equiv="refresh" content="60">
</head>
<body>
<h2>ğŸ“Š æœ¬æœˆæµé‡ç»Ÿè®¡</h2>
<table>
<tr><th>åç§°</th><th>ç´¯è®¡æµé‡</th></tr>
'''

total_all = 0
for name in sorted(OLD.keys()):
    total_bytes, _ = OLD[name]
    html += f"<tr><td>{name}</td><td>{format_bytes(total_bytes)}</td></tr>\n"
    total_all += total_bytes

html += f"<tr><td>æ€»è®¡</td><td>{format_bytes(total_all)}</td></tr>\n"
html += f'''</table>
<div class="footer">æ›´æ–°æ—¶é—´ï¼ˆUTCï¼‰: {now.strftime('%Y-%m-%d %H:%M:%S')} ï¼ˆé¡µé¢æ¯60ç§’è‡ªåŠ¨åˆ·æ–°ï¼‰</div>
</body>
</html>'''

with open(HTML_FILE, "w", encoding="utf-8") as f:
    f.write(html)

# è¾“å‡ºå¯†æ–‡
ENC_FILE = OUTPUT_FILE

# ----------------------
# AES-CBC åŠ å¯†
# ----------------------
# key é•¿åº¦ 16 å­—èŠ‚ï¼Œä¸è¶³è¡¥é›¶
key_bytes = key.ljust(16, b'\0')
iv = get_random_bytes(16)
cipher = AES.new(key_bytes, AES.MODE_CBC, iv)
ct = cipher.encrypt(pad(html.encode("utf-8"), AES.block_size))

# IV + å¯†æ–‡ Base64 ä¿å­˜
with open(ENC_FILE, "w") as f:
    f.write(base64.b64encode(iv + ct).decode())

print("ç”Ÿæˆå¹¶åŠ å¯†å®Œæˆ -> encrypt.txt")
```
5. å®‰è£…åŠé…ç½®è‡ªåŠ¨è¿è¡Œï¼Œä»¥ubuntuä¸ºä¾‹
```bash
touch /var/lib/v2ray-stats/data.db
sudo apt-get update
sudo apt-get install python3 python3-pycryptodome
```
å¦å¤–æ‰§è¡Œcrontab -eï¼Œæœ€åä¸€è¡Œæ·»åŠ è‡ªåŠ¨è¿è¡Œï¼š
```vim
* * * * * python3 /root/v2ray-stats.py
```
æœ€åæ‰“å¼€ç½‘é¡µå°±æ˜¯è¿™æ ·äº†ï¼š

ç™»é™†å‰ï¼š

<img src="https://jibenfa.github.io/uploads/2025/09/web1.png" width="1369" height="776" alt="ç™»å½•é¡µé¢" />

ç™»å½•åï¼š

<img src="https://jibenfa.github.io/uploads/2025/09/web2.png" width="1368" height="933" alt="ç»Ÿè®¡é¡µé¢" />


