

 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
    
    
    
    
    <title>Debian 7 下搭建纯IPSEC XAUTH PSK/IKEv1/IKEv2 同时向下兼容L2TP VPN | Welcome to Coffeecat‘s Blog</title>


    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Coffeecat">
    

    
    <!--<%- open_graph({twitter_id: theme.author.twitter, google_plus: theme.author.google_plus}) %>-->

    <meta name="description" content="page.description">
    
    <meta property="og:type" content="article">
    
    <meta property="og:title" content="Debian 7 下搭建纯IPSEC XAUTH PSK/IKEv1/IKEv2 同时向下兼容L2TP VPN">
    <meta property="og:url" content="/linux/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/2015/02/22/debian-7e4b88be690ade5bbbae7baafipsec-xauth-pskikev1ikev2-e5908ce697b6e59091e4b88be585bce5aeb9l2tp-vpn/">
    <meta property="og:site_name" content="Welcome to Coffeecat‘s Blog">
    <meta property="og:description" content="">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Debian 7 下搭建纯IPSEC XAUTH PSK/IKEv1/IKEv2 同时向下兼容L2TP VPN">
    <meta name="twitter:description" content="page.description">
    <meta name="twitter:creator" content="@">
    <link rel="publisher" href="">

    
    <link rel="alternative" href="/atom.xml" title="Welcome to Coffeecat‘s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/assets/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/assets/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/assets/img/jacman.jpg">
    

    <link rel="stylesheet" href="/assets/css/style.css" type="text/css">
    <link rel="stylesheet" href="/assets/css/dirtysea.css" type="text/css">

    
    
<script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".article-content pre").forEach(pre => {
    const btn = document.createElement("button");
    btn.className = "copy-btn";
    btn.type = "button";
    btn.setAttribute("data-tooltip", "Click to copy");

    btn.addEventListener("click", () => {
      navigator.clipboard.writeText(pre.innerText).then(() => {
        btn.setAttribute("data-tooltip", "Copied!");
        btn.classList.add("copied");
        setTimeout(() => {
          btn.setAttribute("data-tooltip", "Click to copy");
          btn.classList.remove("copied");
        }, 1500);
      }).catch(() => {
        btn.setAttribute("data-tooltip", "Copy failed!");
        setTimeout(() => {
          btn.setAttribute("data-tooltip", "Click to copy");
        }, 1500);
      });
    });

    pre.appendChild(btn);
  });
});
</script>
</head>

  <body>
    <header>
        <div>
		    
			<div id="imglogo">
				<a href="/"><img src="/assets/img/logo.png" alt="Welcome to Coffeecat‘s Blog" title="Welcome to Coffeecat‘s Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Welcome to Coffeecat‘s Blog">Welcome to Coffeecat‘s Blog</a></h1>
				<h2 class="blog-motto">一个不务正业的CISSP</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="/search" method="get" accept-charset="utf-8">
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
					</form>
					
					</li>
				</ul>
			</nav>
</div>

    </header>
    <div id="container">
      



<div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
	<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/linux/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/2015/02/22/debian-7e4b88be690ade5bbbae7baafipsec-xauth-pskikev1ikev2-e5908ce697b6e59091e4b88be585bce5aeb9l2tp-vpn/" title="Debian 7 下搭建纯IPSEC XAUTH PSK/IKEv1/IKEv2 同时向下兼容L2TP VPN" itemprop="url">Debian 7 下搭建纯IPSEC XAUTH PSK/IKEv1/IKEv2 同时向下兼容L2TP VPN</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Coffeecat" target="_blank" itemprop="author">Coffeecat</a>
		
  <p class="article-time">
    <time datetime="2015-02-22 22:58:59 +0000" itemprop="datePublished"> 发表于 2015-02-22</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article toc-content" style="display: none;">
		
			<!--<%- toc(item.content) %>-->
		
		</div>
		
		<p>由于debian上最终版本的openswan对iOS系统自带的VPN兼容性不好，另外openswan已经被strongswan所替代且debian也宣布不再支持它，加之openswan不支持IKEv2这种高级货，因此打算用strongswan 5.2.2搭一个ipsec服务，搞一个纯IPSEC的VPN，本来想彻底抛弃L2TP的，无奈现有的openwrt/ddwrt路由器均不支持IKEv2（只有少数企业级的路由器例如思科和华为的才支持IKEv2），所以还是保留一下l2tp。<br />
先说说StrongSwan和IKEv2的优点吧：<br />
StrongSwan是一个完整的在Linux的 2.6和3.x内核下实现的的IPsec，支持x509等证书和智能卡认证。StrongSwan支持IKEv1并完全实现了IKEv2协议。</p>

<p><strong>Internet Key Exchange</strong> (<strong>IKEv1</strong> or <strong>IKEv2</strong>)<span class="goog-text-highlight">是一个用于建立安全协作的IPSEC</span><span class="goog-text-highlight">协议套件</span>,<strong>IKEv2</strong>支持多并发，集群化，并被工业化VPN网关所支持，是被广大跨国企业采纳的VPN方案（路由器支持）。IKEv2在v1的基础上增强了抗中间人攻击（并不是完全防止）、DDOS攻击，重放攻击等特性，并可以支持多种方法对称的认证，我的理解是：皆可以选择用证书认证，或者一方用证书，一方用共享密钥，甚至双方使用共享密钥。<br />
由于IKEv2是基于UDP协议的，所以它具有天然的对移动性（MOBIKE）的支持，更能适应不断变化的、不稳定的网络连接，甚至可以在有线和无线连接之间无缝切换。所以特别适合移动设备使用。<br />
由于PPTP确认可以被NSA破解，L2TP/IPSEC标准也有被NSA削弱的迹象，而OPEN-VPN和SSTP使用具有很大局限性（参考文档4），因此我认为IKEv2是目前最好的VPN解决方案（最安全的广泛认为仍然是OPEN-VPN，需搭配合适的加密算法）。</p>

<p>下面是安装流程：</p>

<h1 id="1卸载openswan删除etcinitdipsec卸载ipsec-service">1.卸载openswan，删除/etc/init.d/ipsec，卸载ipsec service</h1>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get remove openswan
service ipsec stop
update-rc.d <span class="nt">-f</span> ipsec remove
<span class="nb">rm</span> /etc/init.d/ipsec
</code></pre></div></div>

<h1 id="2下载编译安装strongswan">2.下载编译安装strongswan</h1>

<!--more-->

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get update
apt-get <span class="nb">install </span>build-essential     <span class="c">#编译环境</span>
aptitude <span class="nb">install </span>libgmp3-dev libssl-dev pkg-config libpcsclite-dev libpam0g-dev     <span class="c">#编译所需要的软件</span>
<span class="nb">mkdir </span>tmp
<span class="nb">cd </span>tmp
wget http://download.strongswan.org/strongswan.tar.gz
<span class="nb">tar </span>zxvf strongswan.tar.gz
<span class="nb">cd </span>strongswan-5.2.2
./configure <span class="nt">--prefix</span><span class="o">=</span>/usr <span class="nt">--sysconfdir</span><span class="o">=</span>/etc <span class="nt">--enable-cisco-quirks</span> <span class="nt">--enable-openssl</span> <span class="nt">--enable-nat-transport</span> <span class="nt">--disable-mysql</span> <span class="nt">--disable-ldap</span> <span class="nt">--disable-static</span> <span class="nt">--enable-shared</span> <span class="nt">--enable-md4</span> <span class="nt">--enable-eap-mschapv2</span> <span class="nt">--enable-eap-aka</span> <span class="nt">--enable-eap-aka-3gpp2</span> <span class="nt">--enable-eap-gtc</span> <span class="nt">--enable-eap-identity</span> <span class="nt">--enable-eap-md5</span> <span class="nt">--enable-eap-peap</span> <span class="nt">--enable-eap-radius</span> <span class="nt">--enable-eap-sim</span> <span class="nt">--enable-eap-sim-file</span> <span class="nt">--enable-eap-sim-pcsc</span> <span class="nt">--enable-eap-simaka-pseudonym</span> <span class="nt">--enable-eap-simaka-reauth</span> <span class="nt">--enable-eap-simaka-sql</span> <span class="nt">--enable-eap-tls</span> <span class="nt">--enable-eap-tnc</span> <span class="nt">--enable-eap-ttls</span>
apt-get <span class="nb">install </span>sysv-rc-conf
</code></pre></div></div>

<p>然后编译安装，时间会比较长。。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make
make <span class="nb">install</span>
</code></pre></div></div>

<h1 id="3编辑ipsec配置文件ipsecconf和ipsecsecrets和strongswanconf">3.编辑ipsec配置文件ipsec.conf和ipsec.secrets和strongswan.conf</h1>

<h3 id="a先看看大牛解释的各os对ike的支持情况吧参考文档1">a.先看看大牛解释的各os对IKE的支持情况吧（参考文档1）：</h3>

<p><strong>linux：</strong> 借助strongswan完整支持ikev1和ikev2。<br />
<strong>ios 6+：</strong> 仅支持ikev1，且支持得有bug，例如无法从一个3级证书（同时包含客户端、服务器端、CA端证书的证书）里面读取CA证书。。所以需要2个证书。。。而且优先使用不加密的积极模式，还好strongswan不支持积极模式。另外ios 6还有fragmentation bug导致只能使用小于1024位的证书，而且Mac OS X 10.7以后也不支持小证书了，真是一塌糊涂。。。。苹果的staff是这么回答的：</p>

<p><em><strong>ios 6 has a bad bug in udp packet fragmentation handling. Large UDP packets will cause IPSec connections to fail. We’re fighting through this as well and the only solution we found was to lower the size of the root and device certificates, far less than ideal.</strong></em></p>

<p><strong>android：</strong> 仅支持ikev1，其他和linux一样，4.x以后可以用strongswan client实现ikev2支持。<br />
<strong>windows xp</strong>和<strong>vista</strong>完全不支持ikev2，<strong>win7</strong>和<strong>2008v2</strong>开始支持，但是DH协商密钥仅支持mod 1024，导致安全性大大降低。而且有rekey的bug，只好把rekey关闭。</p>

<h3 id="b修改ipsecconf">b.修改ipsec.conf</h3>

<p>注意：每个参数前面都是tab，不是空格，否则会报错，这也是开源软件的bug么。。。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/ipsec.conf
</code></pre></div></div>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config setup
	uniqueids<span class="p">=</span>never 
	#上面这个表示允许一个id多个登陆
conn iOS_cert
	keyexchange<span class="p">=</span>ikev1
	# strongswan <span class="k">version</span> <span class="p">&gt;=</span> <span class="m">5</span><span class="p">.</span><span class="m">0</span><span class="p">.</span><span class="m">2</span><span class="p">,</span> <span class="nb">compatible</span> with iOS <span class="m">6</span><span class="p">.</span><span class="m">0</span><span class="p">,</span><span class="m">6</span><span class="p">.</span><span class="m">0</span><span class="p">.</span><span class="m">1</span>
	fragmentation<span class="p">=</span>yes
	<span class="k">left</span><span class="p">=</span>%defaultroute
	leftauth<span class="p">=</span>pubkey
	leftsubnet<span class="p">=</span><span class="m">0</span><span class="p">.</span><span class="m">0</span><span class="p">.</span><span class="m">0</span><span class="p">.</span><span class="m">0</span>/<span class="m">0</span>
	leftcert<span class="p">=</span>server<span class="p">.</span>cert<span class="p">.</span>pem
	<span class="k">right</span><span class="p">=</span>%any
	rightauth<span class="p">=</span>pubkey
	rightauth2<span class="p">=</span>xauth
	rightsourceip<span class="p">=</span><span class="m">10</span><span class="p">.</span><span class="m">1</span><span class="p">.</span><span class="m">2</span><span class="p">.</span><span class="m">0</span>/<span class="m">24</span>
	rightcert<span class="p">=</span>client<span class="p">.</span>cert<span class="p">.</span>pem
	auto<span class="p">=</span><span class="nb">add</span>

# also supports iOS PSK <span class="nb">and</span> Shrew <span class="k">on</span> Windows
conn android_xauth_psk
	keyexchange<span class="p">=</span>ikev1
	<span class="k">left</span><span class="p">=</span>%defaultroute
	leftauth<span class="p">=</span>psk
	leftsubnet<span class="p">=</span><span class="m">0</span><span class="p">.</span><span class="m">0</span><span class="p">.</span><span class="m">0</span><span class="p">.</span><span class="m">0</span>/<span class="m">0</span>
	<span class="k">right</span><span class="p">=</span>%any
	rightauth<span class="p">=</span>psk
	rightauth2<span class="p">=</span>xauth
	rightsourceip<span class="p">=</span><span class="m">10</span><span class="p">.</span><span class="m">1</span><span class="p">.</span><span class="m">2</span><span class="p">.</span><span class="m">0</span>/<span class="m">24</span>
	auto<span class="p">=</span><span class="nb">add</span>

# <span class="nb">compatible</span> with <span class="s2">"strongSwan VPN Client"</span> <span class="k">for</span> Android <span class="m">4</span><span class="p">.</span><span class="m">0</span><span class="p">+</span>
# <span class="nb">and</span> Windows <span class="m">7</span> cert <span class="k">mode</span><span class="p">.</span>
conn networkmanager<span class="p">-</span>strongswan
	keyexchange<span class="p">=</span>ikev2
	<span class="k">left</span><span class="p">=</span>%defaultroute
	leftauth<span class="p">=</span>pubkey
	leftsubnet<span class="p">=</span><span class="m">0</span><span class="p">.</span><span class="m">0</span><span class="p">.</span><span class="m">0</span><span class="p">.</span><span class="m">0</span>/<span class="m">0</span>
	leftcert<span class="p">=</span>server<span class="p">.</span>cert<span class="p">.</span>pem
	<span class="k">right</span><span class="p">=</span>%any
	rightauth<span class="p">=</span>pubkey
	rightsourceip<span class="p">=</span><span class="m">10</span><span class="p">.</span><span class="m">1</span><span class="p">.</span><span class="m">2</span><span class="p">.</span><span class="m">0</span>/<span class="m">24</span>
	rightcert<span class="p">=</span>client<span class="p">.</span>cert<span class="p">.</span>pem
	auto<span class="p">=</span><span class="nb">add</span>

#Windows <span class="m">7</span> cert<span class="p">+</span>eap<span class="p">-</span>mschapv2 <span class="k">mode</span><span class="p">.</span> Not Completely Safe<span class="p">.</span>
conn windows7
	keyexchange<span class="p">=</span>ikev2
	ike<span class="p">=</span>aes256<span class="p">-</span>sha1<span class="p">-</span>modp1024<span class="p">!</span> 
	rekey<span class="p">=</span>no
	<span class="k">left</span><span class="p">=</span>%defaultroute
	leftauth<span class="p">=</span>pubkey
	leftsubnet<span class="p">=</span><span class="m">0</span><span class="p">.</span><span class="m">0</span><span class="p">.</span><span class="m">0</span><span class="p">.</span><span class="m">0</span>/<span class="m">0</span>
	leftcert<span class="p">=</span>server<span class="p">.</span>cert<span class="p">.</span>pem   #多个证书用逗号隔开
	<span class="k">right</span><span class="p">=</span>%any
	rightauth<span class="p">=</span>eap<span class="p">-</span>mschapv2
	rightsourceip<span class="p">=</span><span class="m">10</span><span class="p">.</span><span class="m">1</span><span class="p">.</span><span class="m">2</span><span class="p">.</span><span class="m">0</span>/<span class="m">24</span>
	rightsendcert<span class="p">=</span>never
	eap_identity<span class="p">=</span>%any
	auto<span class="p">=</span><span class="nb">add</span>

#<span class="nb">compatible</span> with xl2tp	
conn L2TP<span class="p">-</span>PSK<span class="p">-</span>NAT
	rightsubnet<span class="p">=</span>vhost<span class="p">:</span>%priv
	also<span class="p">=</span>L2TP<span class="p">-</span>PSK<span class="p">-</span>noNAT
 
conn L2TP<span class="p">-</span>PSK<span class="p">-</span>noNAT
	authby<span class="p">=</span>secret
	#pfs<span class="p">=</span>no
	auto<span class="p">=</span><span class="nb">add</span>
	keyingtries<span class="p">=</span><span class="m">3</span>
	rekey<span class="p">=</span>no
	ikelifetime<span class="p">=</span><span class="m">8</span><span class="k">h</span>
	keylife<span class="p">=</span><span class="m">1</span><span class="k">h</span>
	<span class="nb">type</span><span class="p">=</span>transport
	<span class="k">left</span><span class="p">=</span>%defaultroute
	leftprotoport<span class="p">=</span><span class="m">17</span>/<span class="m">1701</span>
	<span class="k">right</span><span class="p">=</span>%any
	rightprotoport<span class="p">=</span><span class="m">17</span>/%any
	dpddelay<span class="p">=</span><span class="m">40</span>
	dpdtimeout<span class="p">=</span><span class="m">130</span>
	dpdaction<span class="p">=</span>clear
</code></pre></div></div>

<h3 id="c修改ipsecsecrets">c.修改ipsec.secrets</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/ipsec.secrets
</code></pre></div></div>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#
# ipsec<span class="p">.</span>secrets
#
# This <span class="k">file</span> holds the RSA private <span class="nb">keys</span> <span class="nb">or</span> the PSK preshared secrets <span class="k">for</span>
# the IKE/IPsec authentication<span class="p">.</span> See the ipsec<span class="p">.</span>secrets<span class="p">(</span><span class="m">5</span><span class="p">)</span> manual page<span class="p">.</span>
#
<span class="p">:</span> RSA server<span class="p">.</span>pem
<span class="p">:</span> PSK <span class="s2">"PSK password"</span>
用户名 <span class="p">:</span> XAUTH <span class="s2">"user password"</span>
用户名 <span class="p">:</span> EAP <span class="s2">"user password"</span>
</code></pre></div></div>

<h3 id="d修改strongswanconf">d.修改strongswan.conf</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/strongswan.conf
</code></pre></div></div>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code># strongswan<span class="p">.</span><span class="k">conf</span> <span class="p">-</span> strongSwan configuration <span class="k">file</span>
charon <span class="p">{</span>
       duplicheck<span class="p">.</span>enable <span class="p">=</span> no

       dns1 <span class="p">=</span> <span class="m">8</span><span class="p">.</span><span class="m">8</span><span class="p">.</span><span class="m">8</span><span class="p">.</span><span class="m">8</span>
       dns2 <span class="p">=</span> <span class="m">208</span><span class="p">.</span><span class="m">67</span><span class="p">.</span><span class="m">220</span><span class="p">.</span><span class="m">220</span>

       # <span class="k">for</span> Windows <span class="k">only</span>
       nbns1 <span class="p">=</span> <span class="m">8</span><span class="p">.</span><span class="m">8</span><span class="p">.</span><span class="m">8</span><span class="p">.</span><span class="m">8</span>
       nbns2 <span class="p">=</span> <span class="m">208</span><span class="p">.</span><span class="m">67</span><span class="p">.</span><span class="m">220</span><span class="p">.</span><span class="m">220</span>

       filelog <span class="p">{</span>
               <span class="sr">/var/</span><span class="nb">log</span>/strongswan<span class="p">.</span>charon<span class="p">.</span><span class="nb">log</span> <span class="p">{</span>
                   time_format <span class="p">=</span> %<span class="k">b</span> %<span class="k">e</span> %T
                   default <span class="p">=</span> <span class="m">2</span>
                   <span class="nb">append</span> <span class="p">=</span> no
                   flush_line <span class="p">=</span> yes
               <span class="p">}</span>
       <span class="p">}</span>
      
       #保留文件原来内容
       <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="4签发证书">4.签发证书</h1>

<h3 id="a生成ca私钥和自签名证书默认都是rsa-2048">a.生成CA私钥和自签名证书，默认都是RSA 2048：</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ipsec pki <span class="nt">--gen</span> <span class="nt">--outform</span> pem <span class="o">&gt;</span> ca.pem
ipsec pki <span class="nt">--self</span> <span class="nt">--in</span> ca.pem <span class="nt">--dn</span> <span class="s2">"C=info, O=example, CN=example.com CA"</span> <span class="nt">--ca</span> <span class="nt">--outform</span> pem <span class="o">&gt;</span>ca.cert.pem
</code></pre></div></div>

<h3 id="b生成服务器私钥用ca私钥签发服务器证书">b.生成服务器私钥，用CA私钥签发服务器证书:</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ipsec pki <span class="nt">--gen</span> <span class="nt">--outform</span> pem <span class="o">&gt;</span> server.pem
ipsec pki <span class="nt">--pub</span> <span class="nt">--in</span> server.pem | ipsec pki <span class="nt">--issue</span> <span class="nt">--cacert</span> ca.cert.pem <span class="se">\</span>
<span class="nt">--cakey</span> ca.pem <span class="nt">--dn</span> <span class="s2">"C=info, O=example, CN=example.com"</span> <span class="se">\</span>
<span class="nt">--san</span><span class="o">=</span><span class="s2">"example.com"</span> <span class="nt">--flag</span> serverAuth <span class="nt">--flag</span> ikeIntermediate <span class="se">\</span>
<span class="nt">--outform</span> pem <span class="o">&gt;</span> server.cert.pem
</code></pre></div></div>

<p>–issue, –cacert 和 –cakey 就是表明要用刚才自签的 CA 证书来签这个服务器证书。</p>

<p>–dn, –san，–flag 是一些客户端方面的特殊要求：</p>

<p>iOS 客户端要求 CN 也就是通用名必须是你的服务器的 URL 或 IP 地址;<br />
Windows 7 不但要求了上面，还要求必须显式说明这个服务器证书的用途（用于与服务器进行认证），–flag serverAuth;<br />
非 iOS 的 Mac OS X 要求了“IP 安全网络密钥互换居间（IP Security IKE Intermediate）”这种增强型密钥用法（EKU），–flag ikdeIntermediate;<br />
Android 和 iOS 都要求服务器别名（serverAltName）就是服务器的 URL 或 IP 地址，–san。</p>

<h3 id="c生成客户端私钥用ca私钥签发客户证书并生成移动客户端上使用的p12证书多个客户端可以使用多个证书也可以共用一个这里需要输入2遍证书提取密码以后安装要用">c.生成客户端私钥,用CA私钥签发客户证书，并生成移动客户端上使用的p12证书，多个客户端可以使用多个证书，也可以共用一个。这里需要输入2遍证书提取密码，以后安装要用:</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ipsec pki <span class="nt">--gen</span> <span class="nt">--outform</span> pem <span class="o">&gt;</span> client.pem
ipsec pki <span class="nt">--pub</span> <span class="nt">--in</span> client.pem | ipsec pki <span class="nt">--issue</span> <span class="nt">--cacert</span> ca.cert.pem <span class="nt">--cakey</span> ca.pem <span class="nt">--dn</span> <span class="s2">"C=info, O=example, CN=example.com Client"</span> <span class="nt">--outform</span> pem <span class="o">&gt;</span> client.cert.pem
openssl pkcs12 <span class="nt">-export</span> <span class="nt">-inkey</span> client.pem <span class="nt">-in</span> client.cert.pem <span class="nt">-name</span> <span class="s2">"client"</span> <span class="nt">-certfile</span> ca.cert.pem <span class="nt">-caname</span> <span class="s2">"example.com CA"</span>  <span class="nt">-out</span> client.cert.p12

</code></pre></div></div>

<h3 id="d写一个发证书的脚本以后省事">d.写一个发证书的脚本，以后省事：</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>CAKEY
<span class="nb">cp</span> ./tmp/ca<span class="k">*</span> ./CAKEY/	
vi keymake.sh
</code></pre></div></div>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#<span class="p">!</span><span class="sr">/bin/</span>bash
   <span class="k">read</span> <span class="p">-</span><span class="k">p</span> <span class="s2">"Please input username:"</span> user
   <span class="k">if</span> <span class="p">[</span> <span class="s2">"$user"</span> <span class="p">=</span> <span class="s2">""</span> <span class="p">]</span>; then
	echo <span class="s2">"Error! - you must input an username"</span>
	echo <span class="s2">"Exit!"</span>
	<span class="k">exit</span> <span class="m">1</span>
   fi
   echo <span class="s2">"==========================="</span>
   echo <span class="s2">"Making ${user}Key.pem ..."</span>
ipsec pki <span class="p">--</span>gen <span class="p">--</span>outform pem <span class="p">&gt;</span> $<span class="p">{</span>user<span class="p">}</span>Key<span class="p">.</span>pem
   echo <span class="s2">"Making ${user}Cert.pem ..."</span>
ipsec pki <span class="p">--</span>pub <span class="p">--</span><span class="k">in</span> $<span class="p">{</span>user<span class="p">}</span>Key<span class="p">.</span>pem <span class="p">|</span> ipsec pki <span class="p">--</span>issue <span class="p">--</span>cacert <span class="p">.</span><span class="sr">/CAKEY/</span><span class="k">ca</span><span class="p">.</span>cert<span class="p">.</span>pem <span class="p">--</span>cakey <span class="p">.</span><span class="sr">/CAKEY/</span><span class="k">ca</span><span class="p">.</span>pem <span class="p">--</span>dn <span class="s2">"C=info, O=example, CN=example.com Client"</span> <span class="p">--</span>outform pem <span class="p">&gt;</span> $<span class="p">{</span>user<span class="p">}</span>Cert<span class="p">.</span>pem
   echo <span class="s2">"Making ${user}Cert.p12 ..."</span>
openssl pkcs12 <span class="p">-</span><span class="k">export</span> <span class="p">-</span>inkey $<span class="p">{</span>user<span class="p">}</span>Key<span class="p">.</span>pem <span class="p">-</span><span class="k">in</span> $<span class="p">{</span>user<span class="p">}</span>Cert<span class="p">.</span>pem <span class="p">-</span>name $<span class="p">{</span>user<span class="p">}</span> <span class="p">-</span>certfile <span class="p">.</span><span class="sr">/CAKEY/</span><span class="k">ca</span><span class="p">.</span>cert<span class="p">.</span>pem <span class="p">-</span>caname <span class="s2">"example.com CA"</span> <span class="p">-</span>out $<span class="p">{</span>user<span class="p">}</span>Cert<span class="p">.</span>p12
   echo <span class="s2">"========== done =========="</span>
</code></pre></div></div>

<p>如要使得新证书生效，需将cert.pem拷贝到/etc/ipsec.d/certs，可能需要重启ipsec服务</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">chmod </span>755 keymake.sh
</code></pre></div></div>

<h3 id="e拷贝安装证书至服务器添加防火墙规则添加自启动服务">e.拷贝安装证书至服务器，添加防火墙规则，添加自启动服务:</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp</span> <span class="nt">-r</span> ca.cert.pem /etc/ipsec.d/cacerts/
<span class="nb">cp</span> <span class="nt">-r</span> server.cert.pem /etc/ipsec.d/certs/
<span class="nb">cp</span> <span class="nt">-r</span> server.pem /etc/ipsec.d/private/
<span class="nb">cp</span> <span class="nt">-r</span> client.cert.pem /etc/ipsec.d/certs/
<span class="nb">cp</span> <span class="nt">-r</span> client.pem  /etc/ipsec.d/private/

</code></pre></div></div>

<p>CA 证书、客户证书（两个）和 .p12 证书复制出来给客户端用。有几种 Android 配置还需要服务器证书（server.cert.pem）。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iptables <span class="nt">-A</span> INPUT <span class="nt">-p</span> udp <span class="nt">--dport</span> 500 <span class="nt">-j</span> ACCEPT
iptables <span class="nt">-A</span> INPUT <span class="nt">-p</span> udp <span class="nt">--dport</span> 4500 <span class="nt">-j</span> ACCEPT
iptables <span class="nt">--table</span> nat <span class="nt">--append</span> POSTROUTING <span class="nt">--jump</span> MASQUERADE
<span class="nb">echo </span>1 <span class="o">&gt;</span> /proc/sys/net/ipv4/ip_forward
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/rc.local
</code></pre></div></div>

<p>在exit0前面加上：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ipsec start
</code></pre></div></div>

<p>重启服务器。</p>

<h1 id="4各平台使用攻略来自参考文档1略修改">4.各平台使用攻略（来自参考文档1，略修改）</h1>

<h3 id="aios">a.iOS</h3>

<p>把 CA 证书和之前做好的 pkcs12（.p12）发邮件给自己。在 iOS 上收邮件，导入两者。然后新建 IPSec VPN：</p>

<p><em>服务器</em>，和 openSUSE 的要求一样，都是 IP 或都是 URL<br />
_账户和密码，_写 ipsec.secrets 里 XAUTH 前后的那两个<br />
如果要使用证书，证书选刚才的那个。否则可以不使用证书，输入 ipsec.secrets 里设置的 PSK 密码。</p>

<h3 id="bandroid">b.Android</h3>

<p><strong>1）自带的VPN功能</strong></p>

<p>选IPSec Xauth PSK</p>

<p>我的4.4.2是有这个的，设置 VPN 之前 要求你必须设置锁屏密码或者 PIN 码。</p>

<p>主要还是：</p>

<p><em>服务器</em>，同上<br />
<em>IPSec 预共享密钥</em>：写 ipsec.secrets 里 PSK 后面的那个密码。<br />
然后登入时还是用 XAUTH 前后的那两个做用户名密码。</p>

<p><strong>2）用”StrongSwan VPN Client” for Android 4.0 (ICS)+</strong></p>

<p>这是官方自己出的客户端，Google Play 里就有。</p>

<p>把之前做好的 pkcs12 发邮件给自己。实际上 pkcs12 里就包含了 CA 证书，iOS 是有 bug 才必须明确要求导入 CA 证书（鄙视之）。Android 不用。直接在 GMail 里点击就会提示你导入。</p>

<p>然后打开官方客户端，新建方案：</p>

<p><em>Gateway</em> 就是服务器，同上<br />
<em>Type</em> 选 IKEv2 Certificate<br />
<em>User certificate</em> 选你刚才导入的<br />
取消自动选择 CA 证书，然后在用户证书里选你刚才从 pk12 导入的</p>

<h3 id="cwindows-xpvista">c.Windows XP/Vista</h3>

<p>注意 XP/Vista 本身不支持纯 IPsec 连接。如果使用 L2TP/IPsec 模式，使用证书会 fallback 到 iOS_cert 这个连接类型，使用预共享密码会 fallback 到 android-xauth-psk 这个连接类型。<br />
<strong>1）</strong><strong>使用 Shrew Soft VPN Client,<em>只有十多天试用期。。。</em></strong></p>

<p>下载：https://www.shrew.net/download/vpn</p>

<p>安装后打开，选“Add”：</p>

<p>“General”选项卡下，把“Host Name or IP address”添好<br />
“Authorization”选项卡下：<br />
“Authorization Method”选“Mutual PSK + XAuth”<br />
“Local Identity”的“Identification Type”选“IP Address”<br />
“Credentials”下面“Pre Shared Key”里输入 PSK 密码<br />
“Phrase 1”，“Exchange Type”选“Main”<br />
“Phrase 2”，“PFS Exchange”选“auto”<br />
保存。连接时用户名密码是你的 XAUTH 用户名密码。</p>

<p>服务器端对应的配置是 android-xauth-psk 的连接类型。</p>

<h3 id="dwindows-7">d.Windows 7+</h3>

<p><strong>1）使用 Shrew Soft VPN Client 客户端：和上面 XP 的一样。</strong></p>

<p><strong>2）使用自带客户端（Agile）：</strong></p>

<p>导入证书：</p>

<p>开始菜单搜索“cmd”，打开后输入 mmc（Microsoft 管理控制台）。<br />
“文件”-“添加/删除管理单元”，添加“证书”单元<br />
证书单元的弹出窗口中一定要选“计算机账户”，之后选“本地计算机”，确定。<br />
在左边的“控制台根节点”下选择“证书”-“个人”，然后选右边的“更多操作”-“所有任务”-“导入”打开证书导入窗口。<br />
选择刚才生成的 client.cert.p12 文件。下一步输入私钥密码。下一步“证书存储”选“个人”。<br />
导入成功后，把导入的 CA 证书剪切到“受信任的根证书颁发机构”的证书文件夹里面。<br />
打开剩下的那个私人证书，看一下有没有显示“您有一个与该证书对应的私钥”，以及“证书路径”下面是不是显示“该证书没有问题”。<br />
然后关闭 mmc，提示“将控制台设置存入控制台1吗”，选“否”即可。<br />
至此，证书导入完成。</p>

<p>注意 千万不要双击 .p12 证书导入！因为那样会导入到当前用户而不是本机计算机中，ipsec 守护精灵是访问不了它的。<br />
建立连接：</p>

<p>“控制面板”-“网络和共享中心”-“设置新的连接或网络”-“连接到工作区”-“使用我的 Internet 连接”<br />
Internet 地址写服务器地址，注意事项同 openSUSE 的，都是 IP 或都是 URL。<br />
描述随便写。<br />
用户名密码写之前配置的 EAP 的那个。<br />
确定<br />
点击右下角网络图标，在新建的 VPN 连接上右键属性然后切换到“安全”选项卡。<br />
VPN 类型选 IKEv2<br />
数据加密是“需要加密”<br />
身份认证这里需要说一下，如果想要使用 EAP-MSCHAPV2 的话就选择“使用可扩展的身份认证协议”-“Microsoft 安全密码”，想要使用私人证书认证的话就选择“使用计算机证书”。</p>

<p>本文参考：<br />
1.https://zh.opensuse.org/SDB:Setup_Ipsec_VPN_with_Strongswan<br />
2.http://blog.ltns.info/linux/pure_ipsec_multi-platform_vpn_client_debian_vps/<br />
3.http://www.nsshell.com/archives/285<br />
4.https://www.bestvpn.com/blog/4147/pptp-vs-l2tp-vs-openvpn-vs-sstp-vs-ikev2/</p>
  
	</div>
	<footer class="article-footer clearfix">
<div class="article-catetags">
  
    <div class="article-categories">
      <span></span>
      
        
        <a href="/categories/linux/">linux</a>
      
        
        <a href="/categories/科学上网/">科学上网</a>
      
    </div>
  

  
    <div class="article-tags">
      <span></span>
      
        
        <a href="/tags/linux/">linux</a>
      
        
        <a href="/tags/科学上网/">科学上网</a>
      
    </div>
  
</div>



	<div class="article-share" id="share">
	
	  <div data-url="https://jibenfa.github.io/linux/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/2015/02/22/debian-7e4b88be690ade5bbbae7baafipsec-xauth-pskikev1ikev2-e5908ce697b6e59091e4b88be585bce5aeb9l2tp-vpn/" data-title="Debian 7 下搭建纯IPSEC XAUTH PSK/IKEv1/IKEv2 同时向下兼容L2TP VPN | Welcome to Coffeecat‘s Blog" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>
   
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/linux/2015/02/16/debian7-apache2e4b88be4b8bae5ad90e7ab99e590afe794a8httpsefbc8ce4bf9de68c81e4b8bbe7ab99http/" title="Debian 7 Apache2下为子站启用HTTPS，保持主站HTTP">
  <strong>上一篇：</strong><br/>
  <span>
  Debian 7 Apache2下为子站启用HTTPS，保持主站HTTP</span>
</a>
</div>


<div class="next">
<a href="/openwrt/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/2015/03/04/tp-link-wr720n-openwrte7a791e5ada6e4b88ae7bd91e694b9e980a0efbc8ce4bdbfe794a8chinadns-shadowsocks-e694bbe795a5/"  title="TP-Link wr720n Openwrt 科学上网改造，使用ChinaDNS + Shadowsocks 攻略">
 <strong>下一篇：</strong><br/> 
 <span>TP-Link wr720n Openwrt 科学上网改造，使用ChinaDNS + Shadowsocks 攻略
</span>
</a>
</div>

</nav>

	

</div>  

      
      
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside toc-content">
 
 <!--<%- toc(item.content) %>-->
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">


  
<div class="categorieslist">
  <p class="asidetitle">分类</p>
  <ul>
    
      
        
        <li>
          <a href="/categories/其他/" title="其他">
            其他<sup>6</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/categories/linux/" title="linux">
            linux<sup>9</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/categories/编程/" title="编程">
            编程<sup>5</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/categories/科学上网/" title="科学上网">
            科学上网<sup>18</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/categories/openwrt/" title="openwrt">
            openwrt<sup>45</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/categories/虚拟化/" title="虚拟化">
            虚拟化<sup>2</sup>
          </a>
        </li>
      
    
  </ul>
</div>



  
<div class="tagslist">
  <p class="asidetitle">标签</p>
  <ul class="clearfix">
    
      
        
        <li>
          <a href="/tags/里程碑/" title="里程碑">
            里程碑<sup>3</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/linux/" title="linux">
            linux<sup>9</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/编程/" title="编程">
            编程<sup>5</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/科学上网/" title="科学上网">
            科学上网<sup>14</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/插件/" title="插件">
            插件<sup>1</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/openwrt/" title="openwrt">
            openwrt<sup>47</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/microsoft/" title="Microsoft">
            Microsoft<sup>1</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/锐速/" title="锐速">
            锐速<sup>1</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/debian/" title="debian">
            debian<sup>1</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/虚拟化/" title="虚拟化">
            虚拟化<sup>2</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/apk/" title="apk">
            apk<sup>1</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/cayman/" title="cayman">
            cayman<sup>1</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/highlight-js/" title="highlight.js">
            highlight.js<sup>1</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/warp/" title="warp">
            warp<sup>1</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/cloudflare/" title="cloudflare">
            cloudflare<sup>1</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/v2ray/" title="v2ray">
            v2ray<sup>3</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/chinadns-ng/" title="chinadns-ng">
            chinadns-ng<sup>1</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/tproxy/" title="tproxy">
            tproxy<sup>1</sup>
          </a>
        </li>
      
    
  </ul>
</div>



  
  <div class="tagcloudlist">
    <p class="asidetitle">标签云</p>
    <div id="tagcloud" class="tagcloudlist clearfix">
    </div>
  </div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
    </ul>
</div>

  


  

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>



</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I'm Coffeecat. <br/>
			This is my blog.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
	<!--
			<%  Array.prototype.S=String.fromCharCode(2);
			  Array.prototype.in_array=function(e){
    			var r=new RegExp(this.S+e+this.S);
    			return (r.test(this.S+this.join(this.S)+this.S));
				};
				var cc = new Array('by','by-nc','by-nc-nd','by-nc-sa','by-nd','by-sa','zero'); %>
		<% if (cc.in_array(theme.creative_commons) ) { %>
				<div class="cc-license">
          <a href="http://creativecommons.org/licenses/<%= theme.creative_commons %>/4.0" class="cc-opacity" target="_blank">
            <img src="<%- config.root %>img/cc-<%= theme.creative_commons %>.svg" alt="Creative Commons" />
          </a>
        </div>
    <% } %>
				-->

		<p class="copyright">
		Powered by <a href="http://jekyllrb.com" target="_blank" title="jekyll">jekyll</a> and Theme by <a href="https://github.com/simpleyyt/jekyll-jacman" target="_blank" title="Jacman">Jacman</a> © 2015 
		
		<a href="about" target="_blank" title="Coffeecat">Coffeecat</a>
		
		
		</p>
</div>
</footer>
    <script src="/assets/js/jquery-2.0.3.min.js"></script>
<script src="/assets/js/jquery.imagesloaded.min.js"></script>
<script src="/assets/js/gallery.js"></script>
<script src="/assets/js/jquery.qrcode-0.12.0.min.js"></script>
<script src="/assets/js/toc.js"></script>

<script type="text/javascript">
$(document).ready(function(){
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });

  

  $(window).resize(function(){
    getSize();
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
      
    }
  });
});
</script>


<script src="/assets/js/tagcloud.js"></script>
<script>
$(document).ready(function() {
  var tags = [
    
    { "name": "里程碑", "path": "/tags/里程碑/", "length": 3 },
    
    { "name": "linux", "path": "/tags/linux/", "length": 9 },
    
    { "name": "编程", "path": "/tags/编程/", "length": 5 },
    
    { "name": "科学上网", "path": "/tags/科学上网/", "length": 14 },
    
    { "name": "插件", "path": "/tags/插件/", "length": 1 },
    
    { "name": "openwrt", "path": "/tags/openwrt/", "length": 47 },
    
    { "name": "Microsoft", "path": "/tags/microsoft/", "length": 1 },
    
    { "name": "锐速", "path": "/tags/锐速/", "length": 1 },
    
    { "name": "debian", "path": "/tags/debian/", "length": 1 },
    
    { "name": "虚拟化", "path": "/tags/虚拟化/", "length": 2 },
    
    { "name": "apk", "path": "/tags/apk/", "length": 1 },
    
    { "name": "cayman", "path": "/tags/cayman/", "length": 1 },
    
    { "name": "highlight.js", "path": "/tags/highlight-js/", "length": 1 },
    
    { "name": "warp", "path": "/tags/warp/", "length": 1 },
    
    { "name": "cloudflare", "path": "/tags/cloudflare/", "length": 1 },
    
    { "name": "v2ray", "path": "/tags/v2ray/", "length": 3 },
    
    { "name": "chinadns-ng", "path": "/tags/chinadns-ng/", "length": 1 },
    
    { "name": "tproxy", "path": "/tags/tproxy/", "length": 1 },
    
  ];
  $("#tagcloud").html(tagcloudHelper(tags));
});
</script>



<script type="text/javascript">
$(document).ready(function(){
  $('#toc.toc-aside').toc({
    title: "文章目录",
    showEffect: "none"
  });
  $('#toc.toc-article').toc({
    title: "文章目录",
    showEffect: "show",
    showSpeed: 0
  });
});
</script>



<script type="text/javascript">
$(document).ready(function(){
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>
<script type="module">
  import hljs from '/assets/js/highlight.js';

  // 获取页面中所有使用了语言的 <code class="language-xxx"> 块
  const codeBlocks = document.querySelectorAll('pre code[class^="language-"]');

  // 提取所有需要的语言类型（去重）
  const languageSet = new Set();
  codeBlocks.forEach((block) => {
    const lang = block.className.match(/language-([\w\d]+)/);
    if (lang && lang[1]) {
      languageSet.add(lang[1]);
    }
  });

  // 动态导入本地语言模块
  const languagePromises = Array.from(languageSet).map(async (lang) => {
    try {
      const module = await import(`/assets/js/languages/${lang}.min.js`);
      hljs.registerLanguage(lang, module.default);
    } catch (err) {
      console.warn(`Language module for "${lang}" not found.`);
    }
  });

  // 等全部语言模块注册后再高亮
  Promise.all(languagePromises).then(() => {
    hljs.highlightAll();
  });
</script>



<script type="text/javascript">
$(document).ready(function(){
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#nothing"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
/*
  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      //$('.hoverqrcode').hide();
  });
  */
});
</script>






<!--

-->




<link rel="stylesheet" href="/assets/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/assets/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      if ($(this).hasClass('emoji')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
});
</script>


<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/assets/img/scrollup.png"/></a>
	</div>
	<script src="/assets/js/totop.js"></script>


<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>

