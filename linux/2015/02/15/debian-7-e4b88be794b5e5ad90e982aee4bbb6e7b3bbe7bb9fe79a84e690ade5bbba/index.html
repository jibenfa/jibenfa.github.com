

 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
    
    
    
    
    <title>Debian 7 下电子邮件系统的搭建（apache2 + postfix + dovecot + rainloop + mysql） | Welcome to Coffeecat‘s Blog</title>


    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Coffeecat">
    

    
    <!--<%- open_graph({twitter_id: theme.author.twitter, google_plus: theme.author.google_plus}) %>-->

    <meta name="description" content="page.description">
    
    <meta property="og:type" content="article">
    
    <meta property="og:title" content="Debian 7 下电子邮件系统的搭建（apache2 + postfix + dovecot + rainloop + mysql）">
    <meta property="og:url" content="/linux/2015/02/15/debian-7-e4b88be794b5e5ad90e982aee4bbb6e7b3bbe7bb9fe79a84e690ade5bbba/">
    <meta property="og:site_name" content="Welcome to Coffeecat‘s Blog">
    <meta property="og:description" content="">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Debian 7 下电子邮件系统的搭建（apache2 + postfix + dovecot + rainloop + mysql）">
    <meta name="twitter:description" content="page.description">
    <meta name="twitter:creator" content="@">
    <link rel="publisher" href="">

    
    <link rel="alternative" href="/atom.xml" title="Welcome to Coffeecat‘s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/assets/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/assets/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/assets/img/jacman.jpg">
    

    <link rel="stylesheet" href="/assets/css/style.css" type="text/css">
    <link rel="stylesheet" href="/assets/css/dirtysea.css" type="text/css">

    
    
</head>

  <body>
    <header>
        <div>
		    
			<div id="imglogo">
				<a href="/"><img src="/assets/img/logo.png" alt="Welcome to Coffeecat‘s Blog" title="Welcome to Coffeecat‘s Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Welcome to Coffeecat‘s Blog">Welcome to Coffeecat‘s Blog</a></h1>
				<h2 class="blog-motto">一个不务正业的CISSP</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="/search" method="get" accept-charset="utf-8">
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
					</form>
					
					</li>
				</ul>
			</nav>
</div>

    </header>
    <div id="container">
      



<div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
	<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/linux/2015/02/15/debian-7-e4b88be794b5e5ad90e982aee4bbb6e7b3bbe7bb9fe79a84e690ade5bbba/" title="Debian 7 下电子邮件系统的搭建（apache2 + postfix + dovecot + rainloop + mysql）" itemprop="url">Debian 7 下电子邮件系统的搭建（apache2 + postfix + dovecot + rainloop + mysql）</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Coffeecat" target="_blank" itemprop="author">Coffeecat</a>
		
  <p class="article-time">
    <time datetime="2015-02-15 00:30:17 +0000" itemprop="datePublished"> 发表于 2015-02-15</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article toc-content" style="display: none;">
		
			<!--<%- toc(item.content) %>-->
		
		</div>
		
		<p>这两天心血来潮，准备在Debian 7 下搭建一个电子邮件系统，然后就去学习了一下。<br />
根据度娘定义：电子邮件系统由用户代理MUA（Mail User Agent）以及邮件传输代理MTA（Mail Transfer Agent）,MDA（Mail Delivery Agent）邮件投递代理组成。<br />
Mail User Agent (MUA)：邮件使用者代理人，这是使用者用来写信、收信的程序。例如，我们常用的 Outlook Exporess、Thunderbird 等。它的作用在于提供使用者一个好用的收发信件接口，并将信传到自己的邮件服务器。这个一般不需要自己弄，我在安卓手机上用gmail客户端，win7电脑上用foxmail客户端，当然在手机和电脑上都可以使用浏览器，通过webmail访问邮箱，我使用的是rainloop，它是使用MUA方式在服务器上实现的webmail解决方案。<br />
Mail Delivery Agent (MDA)：邮件递送代理人，负责将要给本地使用者的邮件分配到使用者的信箱中。在 UNIX 中，MDA 通常是 mail 这支程序。<br />
Mail Transfer Agent (MTA)：邮件转送代理人，是一个负责转送信件的服务器。UNIX 中使用的 Sendmail、Postfix 就是 MTA 软件。它的作用在于收到 MTU 寄来的信后，根据信件地址，将信件转送到目的地。在目的地中，也有另一台 MTA 会负责接收信件。有时候信件并不会一次就从使用者的计算机传送到目的地的主机，而是会经由许多 MTA 转送到目的地的主机。这种 MTA 接收非自己的信件，并转送到别台 MTA 的动作就叫作「Relay」。<!--more--></p>

<p>另外，还需要了解到：<br />
POP3<br />
POP3是Post Office Protocol 3的简称，即邮局协议的第3个版本,它规定怎样将个人计算机连接到Internet的邮件服务器和下载电子邮件的电子协议。它是因特网电子邮件的第一个离线协议标准,POP3允许用户从服务器上把邮件存储到本地主机（即自己的计算机）上,同时删除保存在邮件服务器上的邮件，而POP3服务器则是遵循POP3协议的接收邮件服务器，用来接收电子邮件的。<br />
IMAP<br />
IMAP全称是Internet Mail Access Protocol，即交互式邮件存取协议，它是跟POP3类似邮件访问标准协议之一。不同的是，开启了IMAP后，您在电子邮件客户端收取的邮件仍然保留在服务器上，同时在客户端上的操作都会反馈到服务器上，如：删除邮件，标记已读等，服务器上的邮件也会做相应的动作。所以无论从浏览器登录邮箱或者客户端软件登录邮箱，看到的邮件以及状态都是一致的。<br />
区别：<br />
POP3协议允许电子邮件客户端下载服务器上的邮件，但是在客户端的操作（如移动邮件、标记已读等），不会反馈到服务器上，比如通过客户端收取了邮箱中的3封邮件并移动到其他文件夹，邮箱服务器上的这些邮件是没有同时被移动的 。而IMAP提供webmail 与电子邮件客户端之间的双向通信，客户端的操作都会反馈到服务器上，对邮件进行的操作，服务器上的邮件也会做相应的动作。<br />
SMTP<br />
SMTP 的全称是“Simple Mail Transfer Protocol”，即简单邮件传输协议。它是一组用于从源地址到目的地址传输邮件的规范，通过它来控制邮件的中转方式。SMTP 协议属于 TCP/IP 协议簇，它帮助每台计算机在发送或中转信件时找到下一个目的地。SMTP 服务器就是遵循 SMTP 协议的发送邮件服务器。<br />
SMTP 认证，简单地说就是要求必须在提供了账户名和密码之后才可以登录 SMTP 服务器，这就使得那些垃圾邮件的散播者无可乘之机。<br />
增加 SMTP 认证的目的是为了使用户避免受到垃圾邮件的侵扰。</p>

<p>当然，为了实现这些功能还需要装一些辅助软件，例如web服务器软件，数据库软件等等。<br />
我所用的软件包括：<br />
1). web服务器：apache2<br />
2). MTA &amp; MDA（实现SMTPS）：postfix<br />
3). IMAP 和 POP3电子邮件服务器：dovecot<br />
4). 数据库软件：mysql<br />
5). webmail(MUA模式)：rainloop免费版<br />
6). 交互网页语言支持：php<br />
7). 后台管理软件:postfixadmin</p>

<h1 id="0安装前准备工作"><span style="color: #000000;">0、安装前准备工作：</span></h1>

<h3 id="a申请一个域名dns绑定vps的ip地址添加spf记录做好反向dnsreverse-dns解析">a.申请一个域名,DNS绑定vps的ip地址，添加spf记录，做好反向DNS（Reverse DNS）解析</h3>

<p>找个国外的域名供应商，千万别买国内的。。。国外的可以找<a href="https://www.name.com/">name.com</a>或者<a href="https://www.godaddy.com/">godaddy</a>上搜一个，然后注册，绑定vps的公网ip地址，添加spf记录（Sender Policy Framework。翻译过来就是发信者策略架构，SPF是为了防范垃圾邮件而提出来的一种DNS记录类型，它是一种TXT类型的记录，它用于登记某个域名拥有的用来外发邮件的所有IP地址。），防止你的邮件服务器发出的信被认为是垃圾邮件。<br />
我添加了两个spf，分别是v=spf1 ip4:<em>我的IP</em> ~all 和 v=spf1 mx -all，另外还在vps供应商处做了反向DNS的解析。</p>

<h3 id="b在vps中添加hostname">b.在vps中添加hostname</h3>

<p>1).修改 /etc/hostname 添加一个名字，例如：holycoco。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"holycoco"</span> <span class="o">&gt;</span> /etc/hostname
</code></pre></div></div>

<p>2).使之生效。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">hostname</span> <span class="nt">-F</span> /etc/hostname
</code></pre></div></div>

<p>3).修改 /etc/hosts，添加一些内容，如果网站是example.com，就这样写，如果网站是别的就填别的。</p>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="m">127</span><span class="p">.</span><span class="m">0</span><span class="p">.</span><span class="m">0</span><span class="p">.</span><span class="m">1</span> localhost<span class="p">.</span>localdomain localhost
我的IP holycoco<span class="p">.</span>example<span class="p">.</span><span class="k">com</span> holycoco
</code></pre></div></div>

<p>4).检查host。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">hostname
hostname</span> <span class="nt">-f</span>
</code></pre></div></div>

<p>前者应该显示holycoco，后者应该显示holycoco.example.com，千万别略过这步骤，否则会后悔的。。。</p>

<h1 id="1安装apache2">1、安装apache2</h1>

<h3 id="a安装">a.安装</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get <span class="nb">install </span>apache2
<span class="nb">cp</span> /etc/apache2/apache2.conf /etc/apache2/apache2.backup.conf
vi /etc/apache2/apache2.conf
</code></pre></div></div>

<h3 id="b由于我的vps内存只有1gb所以进行优化">b.由于我的vps内存只有1GB所以进行优化：</h3>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code>KeepAlive Off
<span class="p">...</span>
<span class="p">&lt;</span>IfModule mpm_prefork_module<span class="p">&gt;</span>
StartServers <span class="m">2</span>
MinSpareServers <span class="m">6</span>
MaxSpareServers <span class="m">12</span>
MaxClients <span class="m">80</span>
MaxRequestsPerChild <span class="m">3000</span>
<span class="p">&lt;</span>/IfModule<span class="p">&gt;</span>
</code></pre></div></div>

<h3 id="c重启服务">c.重启服务</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>service apache2 restart
</code></pre></div></div>

<h3 id="d禁用apache默认设置创建一些文件夹做一些配置">d.禁用apache默认设置，创建一些文件夹，做一些配置</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a2dissite <span class="k">*</span>default
<span class="nb">cd</span> /var/www
<span class="nb">mkdir </span>example.com
<span class="nb">mkdir</span> <span class="nt">-p</span> example.com/public_html
<span class="nb">mkdir</span> <span class="nt">-p</span> example.com/log
<span class="nb">mkdir</span> <span class="nt">-p</span> example.com/backups
vi /etc/apache2/sites-available/example.com.conf
</code></pre></div></div>

<h3 id="e为了支持多个域名编辑内容如下重启apache以后可能会有warning因为还没建后面几个文件夹">e.为了支持多个域名，编辑内容如下，（重启apache以后可能会有warning，因为还没建后面几个文件夹）</h3>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code># domain<span class="p">:</span> example<span class="p">.</span><span class="k">com</span>
# public<span class="p">:</span> <span class="sr">/var/</span>www<span class="sr">/example.com/</span>public_html/
<span class="p">&lt;</span>VirtualHost *<span class="p">:</span><span class="m">80</span><span class="p">&gt;</span>
  # Admin email<span class="p">,</span> Server Name <span class="p">(</span>domain name<span class="p">),</span> <span class="nb">and</span> any aliases
  ServerAdmin webmaster@example<span class="p">.</span><span class="k">com</span>
  ServerName  www<span class="p">.</span>example<span class="p">.</span><span class="k">com</span>
  ServerAlias example<span class="p">.</span><span class="k">com</span>
  # Index <span class="k">file</span> <span class="nb">and</span> Document Root <span class="p">(</span>where the public <span class="k">files</span> are located<span class="p">)</span>
  DirectoryIndex <span class="nb">index</span><span class="p">.</span>html <span class="nb">index</span><span class="p">.</span>php
  DocumentRoot <span class="sr">/var/</span>www<span class="sr">/example.com/</span>public_html
  # Log <span class="k">file</span> locations
  LogLevel <span class="nb">warn</span>
  ErrorLog  <span class="sr">/var/</span>www<span class="sr">/example.com/</span><span class="nb">log</span>/error<span class="p">.</span><span class="nb">log</span>
  CustomLog <span class="sr">/var/</span>www<span class="sr">/example.com/</span><span class="nb">log</span>/access<span class="p">.</span><span class="nb">log</span> combined
<span class="p">&lt;</span>/VirtualHost<span class="p">&gt;</span>
<span class="p">&lt;</span>VirtualHost *<span class="p">:</span><span class="m">80</span><span class="p">&gt;</span>
  DirectoryIndex <span class="nb">index</span><span class="p">.</span>html <span class="nb">index</span><span class="p">.</span>php
  DocumentRoot <span class="sr">/var/</span>www<span class="sr">/example.com/</span>public_html/postfixadmin
  ServerName pfadmin<span class="p">.</span>example<span class="p">.</span><span class="k">com</span>
<span class="p">&lt;</span>/VirtualHost<span class="p">&gt;</span>
<span class="p">&lt;</span>Directory <span class="sr">/var/</span>www<span class="sr">/example.com/</span>public_html/webmail<span class="p">&gt;</span>
  Options FollowSymLinks
  <span class="p">&lt;</span>IfModule mod_php5<span class="p">.</span><span class="k">c</span><span class="p">&gt;</span>
    php_flag register_globals off
  <span class="p">&lt;</span>/IfModule<span class="p">&gt;</span>
  <span class="p">&lt;</span>IfModule mod_dir<span class="p">.</span><span class="k">c</span><span class="p">&gt;</span>
    DirectoryIndex <span class="nb">index</span><span class="p">.</span>php
  <span class="p">&lt;</span>/IfModule<span class="p">&gt;</span>
<span class="p">&lt;</span>/Directory<span class="p">&gt;</span>
<span class="p">&lt;</span>Directory <span class="sr">/var/</span>www<span class="sr">/example.com/</span>public_html<span class="sr">/webmail/</span>data<span class="p">&gt;</span>
 deny from <span class="k">all</span>
<span class="p">&lt;</span>/Directory<span class="p">&gt;</span>
<span class="p">&lt;</span>VirtualHost *<span class="p">:</span><span class="m">80</span><span class="p">&gt;</span>
  DirectoryIndex <span class="nb">index</span><span class="p">.</span>html <span class="nb">index</span><span class="p">.</span>php
  DocumentRoot <span class="sr">/var/</span>www<span class="sr">/example.com/</span>public_html/webmail
  ServerName webmail<span class="p">.</span>example<span class="p">.</span><span class="k">com</span>
<span class="p">&lt;</span>/VirtualHost<span class="p">&gt;</span>
</code></pre></div></div>

<h3 id="f使配置文件生效重启服务">f.使配置文件生效，重启服务</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a2ensite example.com.conf
service apache2 restart
</code></pre></div></div>

<h1 id="2安装mysql">2、安装mysql</h1>

<h3 id="a安装-1">a.安装</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get <span class="nb">install </span>mysql-server
mysql_secure_installation
</code></pre></div></div>

<p>设置完root的密码，一定要自己记录下来。。。<br />
另外安全设置时要删除匿名用户，删除默认测试数据库，禁止root远程登录</p>

<h3 id="b为1gb内存进行优化">b.为1GB内存进行优化</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/mysql/my.cnf
</code></pre></div></div>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code>max_connections <span class="p">=</span> <span class="m">75</span>
key_buffer <span class="p">=</span> <span class="m">32</span>M
max_allowed_packet <span class="p">=</span> <span class="m">1</span>M
thread_stack <span class="p">=</span> <span class="m">128</span>K
table_cache <span class="p">=</span> <span class="m">32</span>
</code></pre></div></div>

<h3 id="c创建数据库后面要用">c.创建数据库，后面要用：</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql <span class="nt">-u</span> root <span class="nt">-p</span>
</code></pre></div></div>

<pre><code class="language-mysql">create database mynamemailserver;
GRANT all privileges  ON mynamemailserver.* TO 'mymailuser'@'holycoco.example.com' IDENTIFIED BY 'mypassword';
GRANT all privileges  ON mynamemailserver.* TO 'mymailuser'@'127.0.0.1' IDENTIFIED BY 'mypassword';
</code></pre>

<h3 id="d重启数据库服务">d.重启数据库服务</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>service mysql restart
</code></pre></div></div>

<p>这里可以不建表，因为装postadmin的时候会建的。。。</p>

<h1 id="3安装php支持">3、安装php支持</h1>

<h3 id="a安装-2">a.安装</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get <span class="nb">install </span>php5 libapache2-mod-auth-mysql libmysqlclient15-dev php5-mysql curl libcurl3 libcurl3-dev php5-curl php5-json php-pear
</code></pre></div></div>

<h3 id="b为1gb内存进行优化修改部分内容">b.为1GB内存进行优化，修改部分内容</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/php5/apache2/php.ini
</code></pre></div></div>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code>max_execution_time <span class="p">=</span> <span class="m">30</span>
memory_limit <span class="p">=</span> <span class="m">128</span>M
error_reporting <span class="p">=</span> E_COMPILE_ERROR<span class="p">|</span>E_RECOVERABLE_ERROR<span class="p">|</span>E_ERROR<span class="p">|</span>E_CORE_ERROR
display_errors <span class="p">=</span> Off
log_errors <span class="p">=</span> On
error_log <span class="p">=</span> <span class="sr">/var/</span><span class="nb">log</span><span class="sr">/php/</span>error<span class="p">.</span><span class="nb">log</span>
register_globals <span class="p">=</span> Off
</code></pre></div></div>

<h3 id="c记录日志重启web服务加载php模块">c.记录日志，重启web服务，加载php模块</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="nt">-p</span> /var/log/php
<span class="nb">chown </span>www-data /var/log/php
service apache2 restart
</code></pre></div></div>

<h1 id="4安装postfix和dovecot">4.安装postfix和dovecot</h1>

<h3 id="a安装-3">a.安装</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get <span class="nb">install </span>postfix postfix-mysql dovecot-core dovecot-imapd dovecot-pop3d dovecot-lmtpd dovecot-mysql
</code></pre></div></div>

<p>弹出的框里面Postfix configuration选<strong>Internet Site</strong>，System mail name填入<strong>example.com</strong>，如果网站是别的就填别的。</p>

<h3 id="b配置postfix限制用户邮箱大小等一系列东东用户认证使用dovecot而不是默认的virtual_mailbox">b.配置postfix，限制用户邮箱大小等一系列东东，用户认证使用dovecot，而不是默认的virtual_mailbox</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp</span> /etc/postfix/main.cf /etc/postfix/main.cf.orig
vi /etc/postfix/main.cf
</code></pre></div></div>

<p>/etc/postfix/main.cf 参数必须顶格写。。。。。。。。。。。。内容为：</p>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code># See <span class="sr">/usr/</span>share<span class="sr">/postfix/</span>main<span class="p">.</span><span class="k">cf</span><span class="p">.</span>dist <span class="k">for</span> <span class="k">a</span> commented<span class="p">,</span> <span class="nb">more</span> <span class="nb">complete</span> <span class="k">version</span>
# Debian specific<span class="p">:</span>  Specifying <span class="k">a</span> <span class="k">file</span> name will cause the <span class="k">first</span>
# <span class="nb">line</span> of that <span class="k">file</span> <span class="k">to</span> be used <span class="k">as</span> the name<span class="p">.</span>  The Debian default
# <span class="k">is</span> <span class="sr">/etc/</span>mailname<span class="p">.</span>
#myorigin <span class="p">=</span> <span class="sr">/etc/</span>mailname
smtpd_banner <span class="p">=</span> $myhostname ESMTP $mail_name <span class="p">(</span>Debian/GNU<span class="p">)</span>
biff <span class="p">=</span> no
# appending <span class="p">.</span>domain <span class="k">is</span> the MUA's job<span class="p">.</span>
append_dot_mydomain <span class="p">=</span> no
# Uncomment the <span class="k">next</span> <span class="nb">line</span> <span class="k">to</span> generate <span class="s2">"delayed mail"</span> warnings
#delay_warning_time <span class="p">=</span> <span class="m">4</span><span class="k">h</span>
readme_directory <span class="p">=</span> no
# TLS parameters
#smtpd_tls_cert_file<span class="p">=</span><span class="sr">/etc/</span><span class="nb">ssl</span><span class="sr">/certs/</span><span class="nb">ssl</span><span class="p">-</span>cert<span class="p">-</span>snakeoil<span class="p">.</span>pem
#smtpd_tls_key_file<span class="p">=</span><span class="sr">/etc/</span><span class="nb">ssl</span><span class="sr">/private/</span><span class="nb">ssl</span><span class="p">-</span>cert<span class="p">-</span>snakeoil<span class="p">.</span><span class="nb">key</span>
#smtpd_use_tls<span class="p">=</span>yes
#smtpd_tls_session_cache_database <span class="p">=</span> btree<span class="p">:</span>$<span class="p">{</span>data_directory<span class="p">}</span>/smtpd_scache
#smtp_tls_session_cache_database <span class="p">=</span> btree<span class="p">:</span>$<span class="p">{</span>data_directory<span class="p">}</span>/smtp_scache
smtpd_tls_cert_file<span class="p">=</span><span class="sr">/etc/</span>dovecot/dovecot<span class="p">.</span>pem
smtpd_tls_key_file<span class="p">=</span><span class="sr">/etc/</span>dovecot<span class="sr">/private/</span>dovecot<span class="p">.</span>pem
smtpd_use_tls<span class="p">=</span>yes
smtpd_tls_auth_only <span class="p">=</span> yes
#Enabling SMTP <span class="k">for</span> authenticated users<span class="p">,</span> <span class="nb">and</span> handing off authentication <span class="k">to</span> Dovecot
smtpd_sasl_type <span class="p">=</span> dovecot
smtpd_sasl_path <span class="p">=</span> private/auth
smtpd_sasl_auth_enable <span class="p">=</span> yes
smtpd_recipient_restrictions <span class="p">=</span>
          permit_sasl_authenticated<span class="p">,</span>
          permit_mynetworks<span class="p">,</span>
          reject_unauth_destination
# See <span class="sr">/usr/</span>share<span class="sr">/doc/</span>postfix/TLS_README<span class="p">.</span>gz <span class="k">in</span> the postfix<span class="p">-</span>doc package <span class="k">for</span>
# information <span class="k">on</span> enabling SSL <span class="k">in</span> the smtp client<span class="p">.</span>
inet_interfaces <span class="p">=</span> <span class="k">all</span>
myhostname <span class="p">=</span> holycoco<span class="p">.</span>example<span class="p">.</span><span class="k">com</span>
alias_maps <span class="p">=</span> hash<span class="p">:</span><span class="sr">/etc/</span>aliases
alias_database <span class="p">=</span> hash<span class="p">:</span><span class="sr">/etc/</span>aliases
myorigin <span class="p">=</span> <span class="sr">/etc/</span>mailname
mydestination <span class="p">=</span> localhost
relayhost <span class="p">=</span> 
mynetworks <span class="p">=</span> <span class="m">127</span><span class="p">.</span><span class="m">0</span><span class="p">.</span><span class="m">0</span><span class="p">.</span><span class="m">0</span><span class="sr">/8 [::ffff:127.0.0.0]/</span><span class="m">104</span> <span class="p">[::</span><span class="m">1</span><span class="p">]</span>/<span class="m">128</span>
mailbox_command <span class="p">=</span> procmail <span class="p">-</span><span class="k">a</span> <span class="s2">"$EXTENSION"</span>
mailbox_size_limit <span class="p">=</span> <span class="m">0</span>
recipient_delimiter <span class="p">=</span> <span class="p">+</span>
#Handing off local delivery <span class="k">to</span> Dovecot's LMTP<span class="p">,</span> <span class="nb">and</span> telling it where <span class="k">to</span> store mail
virtual_transport <span class="p">=</span> lmtp<span class="p">:</span>unix<span class="p">:</span>private/dovecot<span class="p">-</span>lmtp
# Virtual mailbox settings<span class="p">.</span>
 
virtual_mailbox_maps <span class="p">=</span> mysql<span class="p">:</span><span class="sr">/etc/</span>postfix/mysql<span class="p">-</span>virtual<span class="p">-</span>mailbox_maps<span class="p">.</span><span class="k">cf</span>
virtual_mailbox_domains <span class="p">=</span> mysql<span class="p">:</span><span class="sr">/etc/</span>postfix/mysql<span class="p">-</span>virtual<span class="p">-</span>mailbox<span class="p">-</span>domains<span class="p">.</span><span class="k">cf</span>
virtual_alias_maps <span class="p">=</span> mysql<span class="p">:</span><span class="sr">/etc/</span>postfix/mysql<span class="p">-</span>virtual<span class="p">-</span>alias<span class="p">-</span>maps<span class="p">.</span><span class="k">cf</span>
virtual_uid_maps <span class="p">=</span> static<span class="p">:&lt;</span><span class="k">em</span><span class="p">&gt;</span>postfix 用户的uid<span class="p">&lt;</span>/<span class="k">em</span><span class="p">&gt;</span>

virtual_gid_maps <span class="p">=</span> static<span class="p">:&lt;</span><span class="k">em</span><span class="p">&gt;</span>postfix 用户的gid<span class="p">&lt;</span>/<span class="k">em</span><span class="p">&gt;</span>

message_size_limit <span class="p">=</span> <span class="m">102400000</span>
virtual_mailbox_limit <span class="p">=</span> <span class="m">2097152000</span>
virtual_create_maildirsize <span class="p">=</span> yes
virtual_mailbox_extended <span class="p">=</span> yes
virtual_mailbox_limit_maps <span class="p">=</span> mysql<span class="p">:</span><span class="sr">/etc/</span>postfix/mysql<span class="p">-</span>virtual<span class="p">-</span>mailbox<span class="p">-</span>limit<span class="p">-</span>maps<span class="p">.</span><span class="k">cf</span>
virtual_mailbox_limit_override <span class="p">=</span> yes
virtual_maildir_limit_message <span class="p">=</span> Sorry<span class="p">,</span> the user's maildir <span class="nb">has</span> exceeded the quota<span class="p">.</span>
virtual_overquota_bounce <span class="p">=</span> yes
</code></pre></div></div>

<p>virtual_uid_maps 和 virtual_gid_maps 改成postfix用户的uid和gid ,可用 id postfix 命令获取<br />
注：postfix服务重启后会有warning，据说可以别理它。。。</p>

<h3 id="c添加数据库查询配置文件用来认证用户登录时候的sql语句">c.添加数据库查询配置文件，用来认证用户登录时候的sql语句</h3>

<p>这些表现在还没建，后面装postfixadmin的时候会自动建的</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/postfix/mysql-virtual-alias-maps.cf
</code></pre></div></div>

<p>这个是转发表查询</p>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user <span class="p">=</span> mymailuser
password <span class="p">=</span> mypassword
hosts <span class="p">=</span> <span class="m">127</span><span class="p">.</span><span class="m">0</span><span class="p">.</span><span class="m">0</span><span class="p">.</span><span class="m">1</span>
dbname <span class="p">=</span> mynamemailserver
query <span class="p">=</span> SELECT <span class="k">goto</span> FROM alias WHERE address<span class="p">=</span><span class="s1">'%s'</span> AND active <span class="p">=</span> <span class="s1">'1'</span>
#query <span class="p">=</span> SELECT destination FROM virtual_aliases WHERE <span class="k">source</span><span class="p">=</span><span class="s1">'%s'</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/postfix/mysql-virtual-mailbox-domains.cf
</code></pre></div></div>

<p>这个是domain表查询</p>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user <span class="p">=</span> mymailuser
password <span class="p">=</span> mypassword
hosts <span class="p">=</span> <span class="m">127</span><span class="p">.</span><span class="m">0</span><span class="p">.</span><span class="m">0</span><span class="p">.</span><span class="m">1</span>
dbname <span class="p">=</span> mynamemailserver
query <span class="p">=</span> SELECT domain FROM domain WHERE domain<span class="p">=</span><span class="s1">'%s'</span> AND active <span class="p">=</span> <span class="s1">'1'</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/postfix/mysql-virtual-mailbox-limit-maps.cf
</code></pre></div></div>

<p>这个是邮箱空间配额查询，不知道有没有用。。。</p>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user <span class="p">=</span> mymailuser
password <span class="p">=</span> mypassword
hosts <span class="p">=</span> <span class="m">127</span><span class="p">.</span><span class="m">0</span><span class="p">.</span><span class="m">0</span><span class="p">.</span><span class="m">1</span>
dbname <span class="p">=</span> mynamemailserver
query <span class="p">=</span> SELECT quota FROM mailbox WHERE username<span class="p">=</span><span class="s1">'%s'</span> AND active <span class="p">=</span> <span class="s1">'1'</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/postfix/mysql-virtual-mailbox-maps.cf
</code></pre></div></div>

<p>这个是最关键的登录查询了</p>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user <span class="p">=</span> mymailuser
password <span class="p">=</span> mypassword
hosts <span class="p">=</span> <span class="m">127</span><span class="p">.</span><span class="m">0</span><span class="p">.</span><span class="m">0</span><span class="p">.</span><span class="m">1</span>
dbname <span class="p">=</span> mynamemailserver
query <span class="p">=</span> SELECT CONCAT<span class="p">(</span>domain<span class="p">,</span><span class="s1">'/'</span><span class="p">,</span>maildir<span class="p">)</span> FROM mailbox WHERE username<span class="p">=</span><span class="s1">'%s'</span> AND active <span class="p">=</span> <span class="s1">'1'</span>
</code></pre></div></div>

<h3 id="d配置开启哪些邮件服务">d.配置开启哪些邮件服务</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp</span> /etc/postfix/master.cf /etc/postfix/master.cf.orig
vi /etc/postfix/master.cf
</code></pre></div></div>

<p>允许smtp走ssl，在端口 25，另外还有587和465（这个不懂），反正就是把submission和smtps前面注释去掉。</p>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#
# Postfix master process configuration <span class="k">file</span><span class="p">.</span>  For details <span class="k">on</span> the format
# of the <span class="k">file</span><span class="p">,</span> see the master<span class="p">(</span><span class="m">5</span><span class="p">)</span> manual page <span class="p">(</span>command<span class="p">:</span> <span class="s2">"man 5 master"</span><span class="p">).</span>
#
# Do not forget <span class="k">to</span> <span class="nb">execute</span> <span class="s2">"postfix reload"</span> after editing this <span class="k">file</span><span class="p">.</span>
#
# <span class="p">==========================================================================</span>
# service <span class="nb">type</span>  private unpriv  chroot  wakeup  maxproc command <span class="p">+</span> <span class="k">args</span>
#               <span class="p">(</span>yes<span class="p">)</span>   <span class="p">(</span>yes<span class="p">)</span>   <span class="p">(</span>yes<span class="p">)</span>   <span class="p">(</span>never<span class="p">)</span> <span class="p">(</span><span class="m">100</span><span class="p">)</span>
# <span class="p">==========================================================================</span>
smtp      inet  <span class="k">n</span>       <span class="p">-</span>       <span class="p">-</span>       <span class="p">-</span>       <span class="p">-</span>       smtpd
#smtp      inet  <span class="k">n</span>       <span class="p">-</span>       <span class="p">-</span>       <span class="p">-</span>       <span class="m">1</span>       postscreen
#smtpd     pass  <span class="p">-</span>       <span class="p">-</span>       <span class="p">-</span>       <span class="p">-</span>       <span class="p">-</span>       smtpd
#dnsblog   unix  <span class="p">-</span>       <span class="p">-</span>       <span class="p">-</span>       <span class="p">-</span>       <span class="m">0</span>       dnsblog
#tlsproxy  unix  <span class="p">-</span>       <span class="p">-</span>       <span class="p">-</span>       <span class="p">-</span>       <span class="m">0</span>       tlsproxy
submission inet <span class="k">n</span>       <span class="p">-</span>       <span class="p">-</span>       <span class="p">-</span>       <span class="p">-</span>       smtpd
#  <span class="p">-</span><span class="k">o</span> syslog_name<span class="p">=</span>postfix/submission
#  <span class="p">-</span><span class="k">o</span> smtpd_tls_security_level<span class="p">=</span>encrypt
#  <span class="p">-</span><span class="k">o</span> smtpd_sasl_auth_enable<span class="p">=</span>yes
#  <span class="p">-</span><span class="k">o</span> smtpd_client_restrictions<span class="p">=</span>permit_sasl_authenticated<span class="p">,</span>reject
#  <span class="p">-</span><span class="k">o</span> milter_macro_daemon_name<span class="p">=</span>ORIGINATING
smtps     inet  <span class="k">n</span>       <span class="p">-</span>       <span class="p">-</span>       <span class="p">-</span>       <span class="p">-</span>       smtpd
#  <span class="p">-</span><span class="k">o</span> syslog_name<span class="p">=</span>postfix/smtps
#  <span class="p">-</span><span class="k">o</span> smtpd_tls_wrappermode<span class="p">=</span>yes
#  <span class="p">-</span><span class="k">o</span> smtpd_sasl_auth_enable<span class="p">=</span>yes
#  <span class="p">-</span><span class="k">o</span> smtpd_client_restrictions<span class="p">=</span>permit_sasl_authenticated<span class="p">,</span>reject
#  <span class="p">-</span><span class="k">o</span> milter_macro_daemon_name<span class="p">=</span>ORIGINATING
</code></pre></div></div>

<h3 id="e重启postfix服务">e.重启postfix服务</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>service postfix restart
</code></pre></div></div>

<h3 id="f配置dovecot">f.配置dovecot</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp</span> /etc/dovecot/dovecot.conf /etc/dovecot/dovecot.conf.orig
<span class="nb">cp</span> /etc/dovecot/conf.d/10-mail.conf /etc/dovecot/conf.d/10-mail.conf.orig
<span class="nb">cp</span> /etc/dovecot/conf.d/10-auth.conf /etc/dovecot/conf.d/10-auth.conf.orig
<span class="nb">cp</span> /etc/dovecot/dovecot-sql.conf.ext /etc/dovecot/dovecot-sql.conf.ext.orig
<span class="nb">cp</span> /etc/dovecot/conf.d/10-master.conf /etc/dovecot/conf.d/10-master.conf.orig
<span class="nb">cp</span> /etc/dovecot/conf.d/10-ssl.conf /etc/dovecot/conf.d/10-ssl.conf.orig
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/dovecot/dovecot.conf
</code></pre></div></div>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">!</span><span class="nb">include</span> <span class="k">conf</span><span class="p">.</span><span class="k">d</span>/*<span class="p">.</span><span class="k">conf</span>
# Enable installed protocols
<span class="p">!</span>include_try <span class="sr">/usr/</span>share<span class="sr">/dovecot/</span>protocols<span class="p">.</span><span class="k">d</span>/*<span class="p">.</span>protocol
protocols <span class="p">=</span> imap pop3 lmtp
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/dovecot/conf.d/10-mail.conf
</code></pre></div></div>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#这个配置很重要
mail_location <span class="p">=</span> maildir<span class="p">:</span><span class="sr">/var/</span>mail<span class="sr">/vhosts/</span>%<span class="k">d</span>/%<span class="k">n</span>
mail_privileged_group <span class="p">=</span> mail
</code></pre></div></div>

<p>检查权限</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">ls</span> <span class="nt">-ld</span> /var/mail
</code></pre></div></div>

<p>应该是这样</p>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code>drwxrwsr<span class="p">-</span><span class="k">x</span> <span class="m">2</span> root mail <span class="m">4096</span> Mar  <span class="m">6</span> <span class="m">15</span><span class="p">:</span><span class="m">08</span> <span class="sr">/var/</span>mail
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="nt">-p</span> /var/mail/vhosts/example.com
groupadd <span class="nt">-g</span> 5000 vmail
useradd <span class="nt">-g</span> vmail <span class="nt">-u</span> 5000 vmail <span class="nt">-d</span> /var/mail
<span class="nb">chown</span> <span class="nt">-R</span> vmail:vmail /var/mail
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/dovecot/conf.d/10-auth.conf
</code></pre></div></div>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code>disable_plaintext_auth <span class="p">=</span> yes
auth_mechanisms <span class="p">=</span> plain login
#<span class="p">!</span><span class="nb">include</span> auth<span class="p">-</span><span class="nb">system</span><span class="p">.</span><span class="k">conf</span><span class="p">.</span>ext
<span class="p">!</span><span class="nb">include</span> auth<span class="p">-</span>sql<span class="p">.</span><span class="k">conf</span><span class="p">.</span>ext
#<span class="p">!</span><span class="nb">include</span> auth<span class="p">-</span>ldap<span class="p">.</span><span class="k">conf</span><span class="p">.</span>ext
#<span class="p">!</span><span class="nb">include</span> auth<span class="p">-</span>passwdfile<span class="p">.</span><span class="k">conf</span><span class="p">.</span>ext
#<span class="p">!</span><span class="nb">include</span> auth<span class="p">-</span>checkpassword<span class="p">.</span><span class="k">conf</span><span class="p">.</span>ext
#<span class="p">!</span><span class="nb">include</span> auth<span class="p">-</span>vpopmail<span class="p">.</span><span class="k">conf</span><span class="p">.</span>ext
#<span class="p">!</span><span class="nb">include</span> auth<span class="p">-</span>static<span class="p">.</span><span class="k">conf</span><span class="p">.</span>ext
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/dovecot/conf.d/auth-sql.conf.ext
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>passdb <span class="o">{</span>
  driver <span class="o">=</span> sql
  args <span class="o">=</span> /etc/dovecot/dovecot-sql.conf.ext
<span class="o">}</span>
userdb <span class="o">{</span>
  driver <span class="o">=</span> static
  args <span class="o">=</span> <span class="nv">uid</span><span class="o">=</span>vmail <span class="nv">gid</span><span class="o">=</span>vmail <span class="nv">home</span><span class="o">=</span>/var/mail/vhosts/%d/%n
<span class="o">}</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/dovecot/dovecot-sql.conf.ext
</code></pre></div></div>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code>driver <span class="p">=</span> mysql
connect <span class="p">=</span> host<span class="p">=</span><span class="m">127</span><span class="p">.</span><span class="m">0</span><span class="p">.</span><span class="m">0</span><span class="p">.</span><span class="m">1</span> dbname<span class="p">=</span>mailserver user<span class="p">=</span>mailuser password<span class="p">=</span>mailuserpass
default_pass_scheme <span class="p">=</span> SHA512<span class="p">-</span>CRYPT
#注意这<span class="m">2</span>个表现在还没有，后面postfixadmin会建的
password_query <span class="p">=</span> SELECT password FROM mailbox WHERE username <span class="p">=</span> <span class="s1">'%u'</span>
user_query <span class="p">=</span> SELECT maildir<span class="p">,</span> <span class="m">502</span> AS uid<span class="p">,</span> <span class="m">502</span> AS gid FROM mailbox WHERE username <span class="p">=</span> <span class="s1">'%u'</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">chown</span> <span class="nt">-R</span> vmail:dovecot /etc/dovecot
<span class="nb">chmod</span> <span class="nt">-R</span> o-rwx /etc/dovecot
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/dovecot/conf.d/10-master.conf
</code></pre></div></div>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#禁止不加 密登录
service imap<span class="p">-</span>login <span class="p">{</span>
    inet_listener imap <span class="p">{</span>
      port <span class="p">=</span> <span class="m">0</span>
    <span class="p">}</span>
  <span class="p">...</span>
  <span class="p">}</span>
  service pop3<span class="p">-</span>login <span class="p">{</span>
    inet_listener pop3 <span class="p">{</span>
      port <span class="p">=</span> <span class="m">0</span>
    <span class="p">}</span>
  <span class="p">...</span>
  <span class="p">}</span>
#lmtp
  service lmtp <span class="p">{</span>
   unix_listener <span class="sr">/var/</span>spool<span class="sr">/postfix/</span>private/dovecot<span class="p">-</span>lmtp <span class="p">{</span>
     <span class="k">mode</span> <span class="p">=</span> <span class="m">0600</span>
     user <span class="p">=</span> postfix
     group <span class="p">=</span> postfix
    <span class="p">}</span>
    # Create inet listener <span class="k">only</span> <span class="k">if</span> you can'<span class="k">t</span> use the above UNIX socket
    #inet_listener lmtp <span class="p">{</span>
      # Avoid making LMTP visible <span class="k">for</span> the entire internet
      #address <span class="p">=</span>
      #port <span class="p">=</span>
    #<span class="p">}</span>
  <span class="p">}</span>
#auth
service auth <span class="p">{</span>
  # auth_socket_path points <span class="k">to</span> this userdb socket by default<span class="p">.</span> It's typically
  # used by dovecot<span class="p">-</span>lda<span class="p">,</span> doveadm<span class="p">,</span> possibly imap process<span class="p">,</span> etc<span class="p">.</span> Its default
  # permissions <span class="k">make</span> it readable <span class="k">only</span> by root<span class="p">,</span> but you may need <span class="k">to</span> relax these
  # permissions<span class="p">.</span> Users that have access <span class="k">to</span> this socket are able <span class="k">to</span> <span class="nb">get</span> <span class="k">a</span> <span class="k">list</span>
  # of <span class="k">all</span> usernames <span class="nb">and</span> <span class="nb">get</span> results of everyone's userdb lookups<span class="p">.</span>
  unix_listener <span class="sr">/var/</span>spool<span class="sr">/postfix/</span>private/auth <span class="p">{</span>
    <span class="k">mode</span> <span class="p">=</span> <span class="m">0666</span>
    user <span class="p">=</span> postfix
    group <span class="p">=</span> postfix
  <span class="p">}</span>
  unix_listener auth<span class="p">-</span>userdb <span class="p">{</span>
    <span class="k">mode</span> <span class="p">=</span> <span class="m">0600</span>
    user <span class="p">=</span> vmail
    #group <span class="p">=</span>
  <span class="p">}</span>
  # Postfix smtp<span class="p">-</span>auth
  #unix_listener <span class="sr">/var/</span>spool<span class="sr">/postfix/</span>private/auth <span class="p">{</span>
  #  <span class="k">mode</span> <span class="p">=</span> <span class="m">0666</span>
  #<span class="p">}</span>
  # Auth process <span class="k">is</span> run <span class="k">as</span> this user<span class="p">.</span>
  user <span class="p">=</span> dovecot
<span class="p">}</span>
#auth<span class="p">-</span>worker
service auth<span class="p">-</span>worker <span class="p">{</span>
  # Auth worker process <span class="k">is</span> run <span class="k">as</span> root by default<span class="p">,</span> <span class="k">so</span> that it can access
  # <span class="sr">/etc/</span>shadow<span class="p">.</span> If this isn'<span class="k">t</span> necessary<span class="p">,</span> the user should be changed <span class="k">to</span>
  # $default_internal_user<span class="p">.</span>
  user <span class="p">=</span> vmail
<span class="p">}</span>
</code></pre></div></div>

<p>检查自签名证书，非常重要</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">ls</span> /etc/dovecot/dovecot.pem
<span class="nb">ls</span> /etc/dovecot/private/dovecot.pem
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/dovecot/conf.d/10-ssl.conf
</code></pre></div></div>

<p>强制ssl</p>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssl_cert <span class="p">=</span> <span class="p">&lt;</span><span class="sr">/etc/</span>dovecot/dovecot<span class="p">.</span>pem
ssl_key <span class="p">=</span> <span class="p">&lt;</span><span class="sr">/etc/</span>dovecot<span class="sr">/private/</span>dovecot<span class="p">.</span>pem
<span class="nb">ssl</span> <span class="p">=</span> required
</code></pre></div></div>

<p>重启dovecot服务</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>service dovecot restart
</code></pre></div></div>

<h1 id="5安装postfixadmin">5.安装postfixadmin</h1>

<h3 id="a下载安装postfixadmin">a.下载安装postfixadmin</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget <span class="s1">'http://downloads.sourceforge.net/project/postfixadmin/postfixadmin/postfixadmin-2.92/postfixadmin-2.92.tar.gz?use_mirror=jaist'</span>
<span class="nb">tar </span>zxvf postfixadmin-2.92.tar.gz
<span class="nb">mv </span>postfixadmin-2.92 /var/www/example.com/public_html/postfixadmin
</code></pre></div></div>

<p>这时候/var/www/example.com/public_html/postfixadmin下应该有config.inc.php文件，否则就是再嵌了个文件夹了。。。</p>

<h3 id="b修改配置文件">b.修改配置文件</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi config.inc.php
</code></pre></div></div>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$CONF<span class="p">[</span><span class="s1">'default_language'</span><span class="p">]</span> <span class="p">=</span> <span class="s1">'cn'</span>;
$CONF<span class="p">[</span><span class="s1">'configured'</span><span class="p">]</span> <span class="p">=</span> true;
$CONF<span class="p">[</span><span class="s1">'default_language'</span><span class="p">]</span> <span class="p">=</span> <span class="s1">'en'</span>;
$CONF<span class="p">[</span><span class="s1">'database_type'</span><span class="p">]</span> <span class="p">=</span> <span class="s1">'mynamemailserver'</span>;
$CONF<span class="p">[</span><span class="s1">'database_host'</span><span class="p">]</span> <span class="p">=</span> <span class="s1">'127.0.0.1'</span>;
$CONF<span class="p">[</span><span class="s1">'database_user'</span><span class="p">]</span> <span class="p">=</span> <span class="s1">'mymailuser'</span>;
$CONF<span class="p">[</span><span class="s1">'database_password'</span><span class="p">]</span> <span class="p">=</span> <span class="s1">'mypassword'</span>;
</code></pre></div></div>

<p>汉化不完全的可以打开language下的cn.lang手工修改。。。</p>

<h3 id="c用浏览器访问postfixadmin的设置页httppfadminexamplecomsetupphp会进行检查各项ok后最后自动生成数据表shell下检查一下如果是这些就ok了">c.用浏览器访问Postfixadmin的设置页http://pfadmin.example.com/setup.php，会进行检查，各项ok后，最后自动生成数据表，shell下检查一下，如果是这些就ok了：</h3>

<pre><code class="language-mysql">show tables;
...
| admin                         |
| alias                         |
| alias_domain                  |
| config                        |
| domain                        |
| domain_admins                 |
| fetchmail                     |
| log                           |
| mailbox                       |
| quota                         |
| quota2                        |
| vacation                      |
| vacation_notification         |
...
</code></pre>

<h3 id="d在浏览器页面下面创建setup-password填复杂一些点击generate-password-hash获取hash代码将代码拷贝到配置文件configincphp中的以下配置中">d.在浏览器页面下面创建Setup password，填复杂一些，点击“Generate password hash”获取hash代码，将代码拷贝到配置文件config.inc.php中的以下配置中</h3>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$CONF<span class="p">[</span><span class="s1">'setup_password'</span><span class="p">]</span> <span class="p">=</span> <span class="s1">'changeme'</span>;#（用hash代码替换changeme）
</code></pre></div></div>

<h3 id="e然后重启apache2服务">e.然后重启apache2服务：</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>service apache2 restart
</code></pre></div></div>

<h3 id="f再次访问httppfadminexamplecomsetupphp创建管理员的账号和密码">f.再次访问http://pfadmin.example.com/setup.php，创建管理员的账号和密码</h3>
<p>（需要正确输入之前创建的Setup password（填的不是hash值）才能创建管理员账号）<br />
设置完成后要做一些安全工作</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">rm </span>setup.php
<span class="nb">chown </span>root config.inc.php
</code></pre></div></div>

<h3 id="g最后访问postfixadmin的登录页httppfadminexamplecom">g.最后访问PostfixAdmin的登录页http://pfadmin.example.com/</h3>
<p>使用管理员账号登录后，就可以添加domain和多用户邮箱什么的了。</p>

<h1 id="6安装rainloop">6.安装rainloop</h1>

<p>其实webmail有很多，为啥选这个呢，因为这个干净，纯php webmail前台页面，它并不创建一个数据库，应用直接访问邮件服务器来显示电子邮件。解压就能用，支持多国语言。</p>

<h3 id="a下载解压">a.下载解压</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> /var/www/example.com/public_html/webmail
<span class="nb">cd</span> /var/www/example.com/public_html/webmail
wget http://repository.rainloop.net/v2/webmail/rainloop-latest.zip
unzip rainloop-latest.zip
<span class="nb">rm </span>rainloop-<span class="k">*</span>.zip
</code></pre></div></div>

<p>这时候webmail目录下应该有个index.php,还有2个文件夹data和rainloop，否则又是嵌套了一层。</p>

<h3 id="b设置权限">b.设置权限</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /var/www/example.com/public_html/webmail
find <span class="nb">.</span> <span class="nt">-type</span> d <span class="nt">-exec</span> <span class="nb">chmod </span>755 <span class="o">{}</span> <span class="se">\;</span>
find <span class="nb">.</span> <span class="nt">-type</span> f <span class="nt">-exec</span> <span class="nb">chmod </span>644 <span class="o">{}</span> <span class="se">\;</span>
<span class="nb">chown</span> <span class="nt">-R</span> www-data:www-data <span class="nb">.</span>
</code></pre></div></div>

<h3 id="c直接访问管理页面进行配置">c.直接访问管理页面进行配置：</h3>

<p>URL : http://webmail.example.com/?admin<br />
User : admin<br />
Pass : 12345</p>

<p>登陆以后进行修改，设置复杂密码。</p>

<h3 id="d设置主要是修改几个地方">d.设置主要是修改几个地方：</h3>

<p>Login 里面不要填default domain，如果你只有一个domain的话，选择Try to determine user domain<br />
Domain 里面 add domain，然后点击新增的domain名字，填写imap和smtp信息，注意不要选use short login，我发现选了以后反而是disabled，不选反而ok。。然后smtp我选的是use php mail()，否则test通不过。<br />
按上面的设置，正确的应该是：Port 993 for secure IMAP, Port 995 for secure POP3, and Port 25 with SSL for SMTP<br />
大工告成！<br />
访问http://webmail.example.com/ 就可以登录邮箱了。或者用第三方客户端进行设置以后也可以使用，第三方客户端设置时，接收服务可选IMAP 993 SSL（接受所有证书）或POP3 995 SSL（接受所有证书），发送服务选SMTP 25 STARTTLS（接收所有证书）。这里之所以用dovecot自签名的证书，是因为穷！商业证书都太贵了，土豪可以选Verisign。。。<br />
最后发2个图。</p>

<p><br /> 
 <img src="https://jibenfa.github.io/uploads/2015/02/QQ20150215002753.png" width="1000" height="800" alt="AltText" /></p>

<p><br /></p>

<p><img src="https://jibenfa.github.io/uploads/2015/02/QQ20150215002946.png" width="1000" height="700" alt="AltText" />
  <br /> 
参考文档：<br />
1.https://www.linode.com/docs/getting-started<br />
2.https://www.linode.com/docs/websites/hosting-a-website<br />
3.https://www.linode.com/docs/email/running-a-mail-server<br />
4.https://www.linode.com/docs/email/postfix/email-with-postfix-dovecot-and-mysql<br />
5.http://help.163.com/09/1223/14/5R7P6CJ600753VB8.html<br />
6.http://help.163.com/10/0203/13/5UJONJ4I00753VB8.html<br />
7.http://www.sulabs.net/?p=311<br />
8.http://www.tecmint.com/rainloop-webmail-a-modern-fast-web-based-email-client-for-linux/</p>
  
	</div>
	<footer class="article-footer clearfix">
<div class="article-catetags">
  
    <div class="article-categories">
      <span></span>
      
        
        <a href="/categories/linux/">linux</a>
      
    </div>
  

  
    <div class="article-tags">
      <span></span>
      
        
        <a href="/tags/linux/">linux</a>
      
    </div>
  
</div>



	<div class="article-share" id="share">
	
	  <div data-url="https://jibenfa.github.io/linux/2015/02/15/debian-7-e4b88be794b5e5ad90e982aee4bbb6e7b3bbe7bb9fe79a84e690ade5bbba/" data-title="Debian 7 下电子邮件系统的搭建（apache2 + postfix + dovecot + rainloop + mysql） | Welcome to Coffeecat‘s Blog" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>
   
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/%E5%85%B6%E4%BB%96/2015/02/11/e5bcbae78388e68ea8e88d90crayon-syntax-highlightere4bba3e7a081e9ab98e4baaee68f92e4bbb6efbc8ce99d9ee5b8b8e5a5bde794a8/" title="强烈推荐Crayon Syntax Highlighter代码高亮插件，非常好用">
  <strong>上一篇：</strong><br/>
  <span>
  强烈推荐Crayon Syntax Highlighter代码高亮插件，非常好用</span>
</a>
</div>


<div class="next">
<a href="/linux/2015/02/16/debian7-apache2e4b88be4b8bae5ad90e7ab99e590afe794a8httpsefbc8ce4bf9de68c81e4b8bbe7ab99http/"  title="Debian 7 Apache2下为子站启用HTTPS，保持主站HTTP">
 <strong>下一篇：</strong><br/> 
 <span>Debian 7 Apache2下为子站启用HTTPS，保持主站HTTP
</span>
</a>
</div>

</nav>

	

</div>  

      
      
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside toc-content">
 
 <!--<%- toc(item.content) %>-->
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">


  
<div class="categorieslist">
  <p class="asidetitle">分类</p>
  <ul>
    
      
        
        <li>
          <a href="/categories/其他/" title="其他">
            其他<sup>6</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/categories/linux/" title="linux">
            linux<sup>9</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/categories/编程/" title="编程">
            编程<sup>5</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/categories/科学上网/" title="科学上网">
            科学上网<sup>15</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/categories/openwrt/" title="openwrt">
            openwrt<sup>45</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/categories/虚拟化/" title="虚拟化">
            虚拟化<sup>2</sup>
          </a>
        </li>
      
    
  </ul>
</div>



  
<div class="tagslist">
  <p class="asidetitle">标签</p>
  <ul class="clearfix">
    
      
        
        <li>
          <a href="/tags/里程碑/" title="里程碑">
            里程碑<sup>3</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/linux/" title="linux">
            linux<sup>9</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/编程/" title="编程">
            编程<sup>5</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/科学上网/" title="科学上网">
            科学上网<sup>14</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/插件/" title="插件">
            插件<sup>1</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/openwrt/" title="openwrt">
            openwrt<sup>45</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/microsoft/" title="Microsoft">
            Microsoft<sup>1</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/锐速/" title="锐速">
            锐速<sup>1</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/debian/" title="debian">
            debian<sup>1</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/虚拟化/" title="虚拟化">
            虚拟化<sup>2</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/apk/" title="apk">
            apk<sup>1</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/cayman/" title="cayman">
            cayman<sup>1</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/highlight-js/" title="highlight.js">
            highlight.js<sup>1</sup>
          </a>
        </li>
      
    
  </ul>
</div>



  
  <div class="tagcloudlist">
    <p class="asidetitle">标签云</p>
    <div id="tagcloud" class="tagcloudlist clearfix">
    </div>
  </div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
    </ul>
</div>

  


  

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>



</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I'm Coffeecat. <br/>
			This is my blog.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
	<!--
			<%  Array.prototype.S=String.fromCharCode(2);
			  Array.prototype.in_array=function(e){
    			var r=new RegExp(this.S+e+this.S);
    			return (r.test(this.S+this.join(this.S)+this.S));
				};
				var cc = new Array('by','by-nc','by-nc-nd','by-nc-sa','by-nd','by-sa','zero'); %>
		<% if (cc.in_array(theme.creative_commons) ) { %>
				<div class="cc-license">
          <a href="http://creativecommons.org/licenses/<%= theme.creative_commons %>/4.0" class="cc-opacity" target="_blank">
            <img src="<%- config.root %>img/cc-<%= theme.creative_commons %>.svg" alt="Creative Commons" />
          </a>
        </div>
    <% } %>
				-->

		<p class="copyright">
		Powered by <a href="http://jekyllrb.com" target="_blank" title="jekyll">jekyll</a> and Theme by <a href="https://github.com/simpleyyt/jekyll-jacman" target="_blank" title="Jacman">Jacman</a> © 2015 
		
		<a href="about" target="_blank" title="Coffeecat">Coffeecat</a>
		
		
		</p>
</div>
</footer>
    <script src="/assets/js/jquery-2.0.3.min.js"></script>
<script src="/assets/js/jquery.imagesloaded.min.js"></script>
<script src="/assets/js/gallery.js"></script>
<script src="/assets/js/jquery.qrcode-0.12.0.min.js"></script>
<script src="/assets/js/toc.js"></script>

<script type="text/javascript">
$(document).ready(function(){
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });

  

  $(window).resize(function(){
    getSize();
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
      
    }
  });
});
</script>


<script src="/assets/js/tagcloud.js"></script>
<script>
$(document).ready(function() {
  var tags = [
    
    { "name": "里程碑", "path": "/tags/里程碑/", "length": 3 },
    
    { "name": "linux", "path": "/tags/linux/", "length": 9 },
    
    { "name": "编程", "path": "/tags/编程/", "length": 5 },
    
    { "name": "科学上网", "path": "/tags/科学上网/", "length": 14 },
    
    { "name": "插件", "path": "/tags/插件/", "length": 1 },
    
    { "name": "openwrt", "path": "/tags/openwrt/", "length": 45 },
    
    { "name": "Microsoft", "path": "/tags/microsoft/", "length": 1 },
    
    { "name": "锐速", "path": "/tags/锐速/", "length": 1 },
    
    { "name": "debian", "path": "/tags/debian/", "length": 1 },
    
    { "name": "虚拟化", "path": "/tags/虚拟化/", "length": 2 },
    
    { "name": "apk", "path": "/tags/apk/", "length": 1 },
    
    { "name": "cayman", "path": "/tags/cayman/", "length": 1 },
    
    { "name": "highlight.js", "path": "/tags/highlight-js/", "length": 1 },
    
  ];
  $("#tagcloud").html(tagcloudHelper(tags));
});
</script>



<script type="text/javascript">
$(document).ready(function(){
  $('#toc.toc-aside').toc({
    title: "文章目录",
    showEffect: "none"
  });
  $('#toc.toc-article').toc({
    title: "文章目录",
    showEffect: "show",
    showSpeed: 0
  });
});
</script>



<script type="text/javascript">
$(document).ready(function(){
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>
<script type="module">
  import hljs from '/assets/js/highlight.js';

  // 获取页面中所有使用了语言的 <code class="language-xxx"> 块
  const codeBlocks = document.querySelectorAll('pre code[class^="language-"]');

  // 提取所有需要的语言类型（去重）
  const languageSet = new Set();
  codeBlocks.forEach((block) => {
    const lang = block.className.match(/language-([\w\d]+)/);
    if (lang && lang[1]) {
      languageSet.add(lang[1]);
    }
  });

  // 动态导入本地语言模块
  const languagePromises = Array.from(languageSet).map(async (lang) => {
    try {
      const module = await import(`/assets/js/languages/${lang}.min.js`);
      hljs.registerLanguage(lang, module.default);
    } catch (err) {
      console.warn(`Language module for "${lang}" not found.`);
    }
  });

  // 等全部语言模块注册后再高亮
  Promise.all(languagePromises).then(() => {
    hljs.highlightAll();
  });
</script>



<script type="text/javascript">
$(document).ready(function(){
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#nothing"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
/*
  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      //$('.hoverqrcode').hide();
  });
  */
});
</script>






<!--

-->




<link rel="stylesheet" href="/assets/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/assets/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      if ($(this).hasClass('emoji')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
});
</script>


<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/assets/img/scrollup.png"/></a>
	</div>
	<script src="/assets/js/totop.js"></script>


<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>

