

 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
    
    
    
    
    <title>openwrt路由部署wireguard实现两地组网 | Welcome to Coffeecat‘s Blog</title>


    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Coffeecat">
    

    
    <!--<%- open_graph({twitter_id: theme.author.twitter, google_plus: theme.author.google_plus}) %>-->

    <meta name="description" content="page.description">
    
    <meta property="og:type" content="article">
    
    <meta property="og:title" content="openwrt路由部署wireguard实现两地组网">
    <meta property="og:url" content="/openwrt/2024/12/19/openwrtE8B7AFE794B1E9A3A8E7BDB2wireguardE5AE9EE78EE7B8AEE4B8A4E59C84E7BB84E7BD91/">
    <meta property="og:site_name" content="Welcome to Coffeecat‘s Blog">
    <meta property="og:description" content="">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="openwrt路由部署wireguard实现两地组网">
    <meta name="twitter:description" content="page.description">
    <meta name="twitter:creator" content="@">
    <link rel="publisher" href="">

    
    <link rel="alternative" href="/atom.xml" title="Welcome to Coffeecat‘s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/assets/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/assets/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/assets/img/jacman.jpg">
    

    <link rel="stylesheet" href="/assets/css/style.css" type="text/css">
    <link rel="stylesheet" href="/assets/css/highlight.css" type="text/css">
    
    
</head>

  <body>
    <header>
        <div>
		    
			<div id="imglogo">
				<a href="/"><img src="/assets/img/logo.png" alt="Welcome to Coffeecat‘s Blog" title="Welcome to Coffeecat‘s Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Welcome to Coffeecat‘s Blog">Welcome to Coffeecat‘s Blog</a></h1>
				<h2 class="blog-motto">一个不务正业的CISSP</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="/search" method="get" accept-charset="utf-8">
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
					</form>
					
					</li>
				</ul>
			</nav>
</div>

    </header>
    <div id="container">
      



<div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
	<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/openwrt/2024/12/19/openwrtE8B7AFE794B1E9A3A8E7BDB2wireguardE5AE9EE78EE7B8AEE4B8A4E59C84E7BB84E7BD91/" title="openwrt路由部署wireguard实现两地组网" itemprop="url">openwrt路由部署wireguard实现两地组网</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Coffeecat" target="_blank" itemprop="author">Coffeecat</a>
		
  <p class="article-time">
    <time datetime="2024-12-19 06:12:12 +0000" itemprop="datePublished"> 发表于 2024-12-19</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article toc-content" style="display: none;">
		
			<!--<%- toc(item.content) %>-->
		
		</div>
		
		<p>很久没升级路由了，最近openwrt和openvpn又更新版本了，导致之前的openwrt路由下opevpn互联配置出了些问题，连同Windows下tap模式访问局域网也失效了，配了半天都未成功，只能使用tun模式。</p>

<p>然后研究了一下wireguard，发现配置比openvpn简单太多了。于是决定用wireguard。</p>

<p>配置方法记录一下备忘：</p>

<p>两个路由：</p>

<p>路由A：具有外网ip和动态域名，内网网段172.24.1.0/24</p>

<p>路由B：无外网ip，内网网段172.24.8.0/24</p>

<p>1.两台路由均执行以下操作：</p>

<p>1）安装wireguard，这里使用的是openwrt 23.05.5版本</p>
<pre lang="bash" line="0" colla="+">
opkg update
opkg install luci-app-wireguard kmod-wireguard wireguard-tools
</pre>

<p>2）生成公私钥对</p>
<pre lang="bash" line="0" colla="+">
wg genkey | tee privatekey | wg pubkey &gt; publickey
</pre>

<p>3）调整防火墙（/etc/config/firewall），在末尾增加：</p>
<pre lang="bash" line="0" colla="+">
config zone
        option name 'wg'
        option input 'ACCEPT'
        option forward 'ACCEPT'
        option output 'ACCEPT'
        option masq '1'
        option mtu_fix '1'
        list network 'wg0'

config forwarding
        option src 'wg'
        option dest 'lan'

config forwarding
        option src 'lan'
        option dest 'wg'

config forwarding
        option src 'wg'
        option dest 'lan'

config rule
        option name 'wireguard'
        option src 'wan'
        option dest '*'
        option dest_port '51820'
        option target 'ACCEPT'

</pre>

<p>2.在路由A上设置网络接口（/etc/config/network），在最后增加：</p>
<pre lang="bash" line="0" colla="+">
config interface 'wg0'
        option proto 'wireguard'
        option private_key '路由A私钥'
        list addresses '10.168.10.1/24'
        option listen_port '51820'

config wireguard_wg0
        option description 'router'
        option public_key '路由B公钥'
        option persistent_keepalive '25'
        list allowed_ips '10.168.10.3/32'
        list allowed_ips '172.24.8.0/24'

config route
        option interface 'wg0'
        option target '172.24.8.0/24'
        option gateway '10.168.10.1'
        option metric '1'
</pre>

<p>3.在路由B上设置网络接口（/etc/config/network），在最后增加：</p>
<pre lang="bash" line="0" colla="+">
config interface 'wg0'
        option proto 'wireguard'
        option private_key '路由B私钥'
        list addresses '10.168.10.3/24'
        option listen_port '51820'

config wireguard_wg0
        option description 'router_client1'
        option public_key '路由A公钥'
        option endpoint_host '路由A的ddns域名'
        option endpoint_port '51820'
        option persistent_keepalive '25'
        list allowed_ips '10.168.10.1/32'
        list allowed_ips '172.24.1.0/24'

config route
        option interface 'wg0'
        option target '172.24.1.0/24'
        option gateway '10.168.10.3'
        option metric '1'
</pre>

<p>4.最后重启路由A和路由B，两个路由间的局域网就可以互相访问了</p>

<p>参考：</p>

<p>1.https://www.knightli.com/2022/04/14/openwrt-wireguard-connect-two-network/</p>

<p>2.chatgpt</p>
  
	</div>
	<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <!--
  <%- list_categories(item.categories, {
      show_count: false,
      class: 'article-category',
      style: 'none',
      separator: '►'
  }) %>
  -->
  
  <a class="article-category-link" href="/categories/#openwrt">openwrt</a>
  
</div>


  <div class="article-tags">
  <!--
  <% var tags = [];
    item.tags.forEach(function(tag){
      tags.push('<a href="' + config.root + tag.path + '">' + tag.name + '</a>');
    }); %>-->
  <span></span> <!--<%- tags.join('') %>-->
  
  
  <a href="/tags/#openwrt">openwrt</a>
  
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="https://jibenfa.github.io/openwrt/2024/12/19/openwrtE8B7AFE794B1E9A3A8E7BDB2wireguardE5AE9EE78EE7B8AEE4B8A4E59C84E7BB84E7BD91/" data-title="openwrt路由部署wireguard实现两地组网 | Welcome to Coffeecat‘s Blog" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>
   
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/openwrt/2024/12/18/openwrtE4B88BE8A7A3E586B3dnsmasq20cannot20access20directory20E79A84E997AEE9A298/" title="openwrt下解决dnsmasq cannot access directory 的问题">
  <strong>上一篇：</strong><br/>
  <span>
  openwrt下解决dnsmasq cannot access directory 的问题</span>
</a>
</div>


<div class="next">
<a href="/openwrt/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/2025/07/30/openwrtE4B88Bv2rayE9808FE6988EE4BBA3E79086vE9858DE7BDAEE4BB8EiptablesE59091nftablesE8BF81E7A7BB/"  title="openwrt下v2ray透明代理配置从iptables向nftables迁移">
 <strong>下一篇：</strong><br/> 
 <span>openwrt下v2ray透明代理配置从iptables向nftables迁移
</span>
</a>
</div>

</nav>

	

</div>  

      
      
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside toc-content">
 
 <!--<%- toc(item.content) %>-->
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">


  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/#其他" title="其他">其他<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/#linux" title="linux">linux<sup>9</sup></a></li>
		  
		
		  
			<li><a href="/categories/#编程" title="编程">编程<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/#科学上网" title="科学上网">科学上网<sup>15</sup></a></li>
		  
		
		  
			<li><a href="/categories/#openwrt" title="openwrt">openwrt<sup>44</sup></a></li>
		  
		
		  
			<li><a href="/categories/#虚拟化" title="虚拟化">虚拟化<sup>2</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/#里程碑" title="里程碑">里程碑<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/#linux" title="linux">linux<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/#编程" title="编程">编程<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/#科学上网" title="科学上网">科学上网<sup>14</sup></a></li>
			
		
			
				<li><a href="/tags/#插件" title="插件">插件<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/#openwrt" title="openwrt">openwrt<sup>44</sup></a></li>
			
		
			
				<li><a href="/tags/#Microsoft" title="Microsoft">Microsoft<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/#锐速" title="锐速">锐速<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/#debian" title="debian">debian<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/#虚拟化" title="虚拟化">虚拟化<sup>2</sup></a></li>
			
		
		</ul>
</div>


  
  <div class="tagcloudlist">
    <p class="asidetitle">标签云</p>
    <div id="tagcloud" class="tagcloudlist clearfix">
    </div>
  </div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
    </ul>
</div>

  


  

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>



</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I'm Coffeecat. <br/>
			This is my blog.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
	<!--
			<%  Array.prototype.S=String.fromCharCode(2);
			  Array.prototype.in_array=function(e){
    			var r=new RegExp(this.S+e+this.S);
    			return (r.test(this.S+this.join(this.S)+this.S));
				};
				var cc = new Array('by','by-nc','by-nc-nd','by-nc-sa','by-nd','by-sa','zero'); %>
		<% if (cc.in_array(theme.creative_commons) ) { %>
				<div class="cc-license">
          <a href="http://creativecommons.org/licenses/<%= theme.creative_commons %>/4.0" class="cc-opacity" target="_blank">
            <img src="<%- config.root %>img/cc-<%= theme.creative_commons %>.svg" alt="Creative Commons" />
          </a>
        </div>
    <% } %>
				-->

		<p class="copyright">
		Powered by <a href="http://jekyllrb.com" target="_blank" title="jekyll">jekyll</a> and Theme by <a href="https://github.com/simpleyyt/jekyll-jacman" target="_blank" title="Jacman">Jacman</a> © 2015 
		
		<a href="about" target="_blank" title="Coffeecat">Coffeecat</a>
		
		
		</p>
</div>
</footer>
    <script src="/assets/js/jquery-2.0.3.min.js"></script>
<script src="/assets/js/jquery.imagesloaded.min.js"></script>
<script src="/assets/js/gallery.js"></script>
<script src="/assets/js/jquery.qrcode-0.12.0.min.js"></script>
<script src="/assets/js/toc.js"></script>

<script type="text/javascript">
$(document).ready(function(){
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });

  

  $(window).resize(function(){
    getSize();
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
      
    }
  });
});
</script>


<script src="/assets/js/tagcloud.js"></script>
<script>
$(document).ready(function() {
  var tags = [
    
    { "name": "里程碑", "path": "/tags/#里程碑", "length": 1 },
    
    { "name": "linux", "path": "/tags/#linux", "length": 9 },
    
    { "name": "编程", "path": "/tags/#编程", "length": 5 },
    
    { "name": "科学上网", "path": "/tags/#科学上网", "length": 14 },
    
    { "name": "插件", "path": "/tags/#插件", "length": 1 },
    
    { "name": "openwrt", "path": "/tags/#openwrt", "length": 44 },
    
    { "name": "Microsoft", "path": "/tags/#Microsoft", "length": 1 },
    
    { "name": "锐速", "path": "/tags/#锐速", "length": 1 },
    
    { "name": "debian", "path": "/tags/#debian", "length": 1 },
    
    { "name": "虚拟化", "path": "/tags/#虚拟化", "length": 2 },
    
  ];
  $("#tagcloud").html(tagcloudHelper(tags));
});
</script>



<script type="text/javascript">
$(document).ready(function(){
  $('#toc.toc-aside').toc({
    title: "文章目录",
    showEffect: "none"
  });
  $('#toc.toc-article').toc({
    title: "文章目录",
    showEffect: "show",
    showSpeed: 0
  });
});
</script>



<script type="text/javascript">
$(document).ready(function(){
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>



<script type="text/javascript">
$(document).ready(function(){
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#nothing"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
/*
  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      //$('.hoverqrcode').hide();
  });
  */
});
</script>






<!--

-->




<link rel="stylesheet" href="/assets/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/assets/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      if ($(this).hasClass('emoji')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
});
</script>


<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/assets/img/scrollup.png"/></a>
	</div>
	<script src="/assets/js/totop.js"></script>


<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>

