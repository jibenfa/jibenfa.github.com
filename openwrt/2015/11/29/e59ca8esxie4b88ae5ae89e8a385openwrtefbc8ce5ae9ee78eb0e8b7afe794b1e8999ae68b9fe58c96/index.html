

 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
    
    
    
    
    <title>在HP GEN8上安装openwrt，实现“万兆”虚拟路由器。。。 | Welcome to Coffeecat‘s Blog</title>


    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Coffeecat">
    

    
    <!--<%- open_graph({twitter_id: theme.author.twitter, google_plus: theme.author.google_plus}) %>-->

    <meta name="description" content="page.description">
    
    <meta property="og:type" content="article">
    
    <meta property="og:title" content="在HP GEN8上安装openwrt，实现“万兆”虚拟路由器。。。">
    <meta property="og:url" content="/openwrt/2015/11/29/e59ca8esxie4b88ae5ae89e8a385openwrtefbc8ce5ae9ee78eb0e8b7afe794b1e8999ae68b9fe58c96/">
    <meta property="og:site_name" content="Welcome to Coffeecat‘s Blog">
    <meta property="og:description" content="">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="在HP GEN8上安装openwrt，实现“万兆”虚拟路由器。。。">
    <meta name="twitter:description" content="page.description">
    <meta name="twitter:creator" content="@">
    <link rel="publisher" href="">

    
    <link rel="alternative" href="/atom.xml" title="Welcome to Coffeecat‘s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/assets/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/assets/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/assets/img/jacman.jpg">
    

    <link rel="stylesheet" href="/assets/css/style.css" type="text/css">
    <link rel="stylesheet" href="/assets/css/highlight.css" type="text/css">
    <link rel="stylesheet" href="/assets/css/dirtysea.css">

    
    
</head>

  <body>
    <header>
        <div>
		    
			<div id="imglogo">
				<a href="/"><img src="/assets/img/logo.png" alt="Welcome to Coffeecat‘s Blog" title="Welcome to Coffeecat‘s Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Welcome to Coffeecat‘s Blog">Welcome to Coffeecat‘s Blog</a></h1>
				<h2 class="blog-motto">一个不务正业的CISSP</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="/search" method="get" accept-charset="utf-8">
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
					</form>
					
					</li>
				</ul>
			</nav>
</div>

    </header>
    <div id="container">
      



<div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
	<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/openwrt/2015/11/29/e59ca8esxie4b88ae5ae89e8a385openwrtefbc8ce5ae9ee78eb0e8b7afe794b1e8999ae68b9fe58c96/" title="在HP GEN8上安装openwrt，实现“万兆”虚拟路由器。。。" itemprop="url">在HP GEN8上安装openwrt，实现“万兆”虚拟路由器。。。</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Coffeecat" target="_blank" itemprop="author">Coffeecat</a>
		
  <p class="article-time">
    <time datetime="2015-11-29 20:54:28 +0000" itemprop="datePublished"> 发表于 2015-11-29</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article toc-content" style="display: none;">
		
			<!--<%- toc(item.content) %>-->
		
		</div>
		
		<p>最近搞了一台HP Gen8 microserver，升级cpu，内存，Intel I350-T4口千兆网卡以后就装了个esxi，自己用ESXi-Customizer-v2.7.2把最新版的网卡驱动集成了进去，网卡驱动为igb-5.3.1-1331820-3123166，之前网友说kmod-igb支持I350，所以这次才入的I350-T4，据说转发小包性能强于I340-T4，价格还比I340便宜。。。</p>

<p><strong>目标：</strong></p>

<ul>
  <li>
    <p>通过openwrt设置vmxnet3万兆虚拟网卡通过esxi的链路聚合设置I350， 实现4Gb上行链路
<strong>过程：</strong></p>
  </li>
  <li>netgear GS116E V2交换机，只支持static的链路聚合lag，不支持lacp。。。双机拷贝openwrt下文件速度之和最多1900Mbps</li>
  <li>后来更新了个HP 1810-8g的设备，成功实现了distribute switch下的lacp，但是双机拷贝openwrt下文件速度之和最多仍然是1900Mbps</li>
  <li>通过监控发现，静态下和动态lacp下，走的是两个物理网口，但是速度之和为1900Mpbs（最后有截图）</li>
  <li>另外，如果I350的4个网口，直通了2个e1000，另外两个做lacp的话，当openwrt选择虚拟vmnet3时，网络是不通的，只有选择e1000才通。。。</li>
  <li>最后在I350直通了2个网口分别给2台物理机，同时拷贝openwrt速度均可以达到1000Mpbs，说明不是磁盘性能问题。
<!--more--></li>
</ul>

<p><strong>插曲：</strong></p>

<ul>
  <li>distribute switch在lacp模式下，虚拟机win7，使用vmxnet3网口，安装vmwaretools，双机拷贝虚拟机下文件，可以达到总共2000Mbps的速度，说明lacp配置正确。</li>
  <li>
    <p>使用standard switch，交换机在static模式下，虚拟机win7，使用vmxnet3网口，安装vmwaretools，双机拷贝虚拟机下文件，可以达到总共2000Mbps的速度，说明交换机trunk配置正确。
<strong>结论：</strong></p>
  </li>
  <li>
    <p>openwrt的vmxnet3驱动后虽然暂时无法安装vmware tools但性能至少可以达到1900Mpbs
<strong>硬件：</strong></p>
  </li>
  <li>HP Gen8 屌丝版——HP服务器做工真心好，但是主板所有接口都是反人类的非标口，主板也是非标型主板。</li>
  <li>CPU升级为： E3 1230 V2</li>
  <li>内存升级为平民版：Kingston DDR3 1600 8GB ECC 惠普服务器专用内存(KTH-PL316ELV/8G) *2 共16GB</li>
  <li>电源搞了个国产的250w 小1U电源，替换了原装的150w 小1U电源，主要是它的光驱位供电居然是迷你小4pin的软驱口。。。换了电源接口多多</li>
  <li>风扇捆了2个Wind Ace D35M12 3CM 12V 0.04A ，毕竟原装散热片是35w tdp的，而1230是69w的tdp。。。</li>
</ul>

<p><br />
 <img src="https://jibenfa.github.io/uploads/2015/11/QQ20151206114231.jpg" width="1000" height="618" alt="AltText" />
 <br /></p>

<ul>
  <li>硬盘是之前买的西数nas红盘 放在sata1，镁光BX100 500G SSD 放在sata5，都是做成单盘raid0，否则无法从sata5启动，这样的优点是可以不用tf或者u盘引导启动，缺点是所有硬盘不可以休眠。</li>
</ul>

<p><br />
 <img src="https://jibenfa.github.io/uploads/2015/11/QQ20151206114902.png" width="1000" height="618" alt="AltText" />
 <br /></p>

<p>我用的是HP的intelligent provision，也就是ip 装的系统，这坑货不识别6.0的HP定制版的ESXi iso。。。后来才知道6.0的版本要用bundle版本才可以装，不管了，装了HP定制版VMware-ESXi-5.5.0-Update3-3116895-HP-550.9.4.26-Nov2015.iso也行，后来发现也是坑啊。</p>

<p>1.编译Openwrt系统img<br />
这个不多说了，问题在于:<br />
<strong>一定要把kmod-vmxnet3，kmod-igb,kmod-e1000,kmod-e1000e编译进去，否则esxi虚拟的网卡不能用</strong><br />
<strong>如果无需迅雷远程，可以编译x64版本的镜像，性能远超x86</strong><br />
下面有个性能对比，都是我跑出来的第一手资料，cc略强于bb，但是cc下的openvpn我编译出来运行不了，老缺个libc.so，所以最后就放弃了：</p>

<pre><code class="language-vim">MD5 	SHA-1 	DES 	3DES 	AES-128 	RSA Sign 	RSA Verify 	DSA Sign 	DSA Verify 	OS 	SoC 	CPU 	OpenSSL Version 
422333440	157073750	52919910	19314850	66379090	61.8	2260.6	222.3	182.2	bbr46287	i3 540	x86	1.0.2d 
506805250	480641710	62921390	24199510	100739070	522	16821.8	1664.6	1364.2	ccrc3r46163	i3 540	x8664	1.0.2d
513278290	196502530	67375790	24792060	108380840	107.7	3959.3	386.6	311.7	ccr46705	vmware e3  1230v2	x86vmware	1.0.2d
512455340	193744550	66202970	24312830	105958400	105.6	3872.5	379.4	309.3	bbr46287	vmware e3  1230v2	x86vmware	1.0.2d
</code></pre>

<p>我编译出来的镜像叫：openwrt-x86-generic-combined-ext4.img，是bb 14.07的版本。</p>

<p>2.制作vmdk 6G大镜像——也就是esxi的虚拟盘<br />
其实本来可以在esxi下对于现有的vmdk进行扩容，我也试过，但是每次扩容完成后，都无法启动openwrt，提示找不到盘，故采用其他方法：<br />
首先制作一个全0x00的二进制文件，例如6g_00.bin，然后在linux下执行：</p>

<pre><code class="language-sh">cat openwrt-x86-generic-combined-ext4.img 6g_00.bin &gt; openwrt-x86-generic-combined-ext4-bb6g.img </code></pre>

<p>这样就得到一个6G的镜像了。<br />
接下来就是要把img转换成vmdk，<a href="https://wiki.openwrt.org/doc/howto/vmware">openwrt官网有如何把img转换成vmdk的攻略</a>，由于我用的是debian，故略有不同：</p>

<pre><code class="language-sh">apt-get install qemu-utils
  qemu-img convert -f raw -O vmdk openwrt-x86-generic-combined-ext4-bb6g.img openwrt-x86-generic-combined-ext4-bb6g.vmdk</code></pre>

<p>转换完成后的vmdk只有48MB多一些，但是加载到esxi上后就可以看到置备空间是6G多，达到了我们目的。</p>

<p>3.上传并安装，分区<br />
用vmware client把openwrt的vmdk虚拟盘上传到ssd，再把gparted-live-0.21.0-1-i586.iso上传ssd以后，就可以添加虚拟机了，首先我们要建立一个其他的虚拟机，其中光盘使用gparted-live-0.21.0-1-i586.iso引导，然后挂载openwrt的vmdk的虚拟盘进行扩展，一共分3个区，把openwrt分区拉到3G，最后一个分区也拉到3G，最后显示为类似如下图（下图是我用之前硬盘分3个区的）：<br />
<br />
 <img src="https://jibenfa.github.io/uploads/2015/07/IMG_20150725_202654.jpg" width="1000" height="618" alt="AltText" />
 <br /></p>

<p>分区完成后，关闭该虚拟机，记得移除挂载的openwrt分区。</p>

<p>4.创建openwrt虚拟机<br />
这个就很简答拉，直接添加openwrt的vmdk，然后添加2块网卡，注意都要选择vmxnet3，这样就是万兆卡了</p>

<p><br />
 <img src="https://jibenfa.github.io/uploads/2015/11/QQ20151201210547.png" width="1000" height="618" alt="AltText" />
 <br /></p>

<p><br />
 <img src="https://jibenfa.github.io/uploads/2015/11/QQ20151201210638.png" width="1000" height="618" alt="AltText" />
 <br /></p>

<p>启动openwrt，最后会看见如下图：</p>

<pre><code class="language-vim">[    5.176918] vmxnet3 0000:03:00.0 eth0: intr type 3, mode 0, 5 vectors allocated
[    5.177585] vmxnet3 0000:03:00.0 eth0: NIC Link is Up 10000 Mbps
[    5.177744] 8021q: adding VLAN 0 to HW filter on device eth0
[    5.177824] device eth0 entered promiscuous mode
[    5.177933] br-lan: port 1(eth0) entered forwarding state
[    5.178013] br-lan: port 1(eth0) entered forwarding state
[    5.178954] vmxnet3 0000:0b:00.0 eth1: intr type 3, mode 0, 5 vectors allocated
[    5.179815] vmxnet3 0000:0b:00.0 eth1: NIC Link is Up 10000 Mbps
[    5.180439] 8021q: adding VLAN 0 to HW filter on device eth1
[    5.277329] device tap0 entered promiscuous mode</code></pre>

<p>妥妥的万兆卡（实测双机拷贝最多达到总共1900Mpbs）</p>

<p>5.设置链路聚合<br />
由于openwrt不支持链路聚合，所以我用的是esxi的简单的方式实现链路聚合，基于ip哈希的策略，对于单机拷贝来说，最多1000Mbps，但是可以支持多个1000Mbps拷贝，如图：</p>

<p><br />
 <img src="https://jibenfa.github.io/uploads/2015/11/QQ20151201211138.jpg" width="1000" height="618" alt="AltText" />
 <br /></p>

<p>netgear上的设置也很简单，无需设置vlan，这个交换机好贵。。。</p>

<p>6.小插曲<br />
一开始搞完上述以后，我测试了一下网络，传输读写拷贝文件居然只有~100Mbps（10-15MB/s）,这不科学啊。。。于是我采用排除法，把I350网卡直通，发现还是这么慢，在乱改一同参数后，发现，不是esxi 5.5的网络慢，原来是坑爹的磁盘慢，读写只有这么点，后来查阅了大量资料，最终在<a href="http://www.chiphell.com/thread-1330699-1-1.html">chiphell网友</a>和某台湾网友的帖子里面发现是板载raid卡b120i的驱动问题：Mware-ESXi-5.5.0-Update3-3116895-HP-550.9.4.26-Nov2015.iso带的scsi-hpvsa 5.5.0.100-1OEM.550.0.0.1331820 Hewlett-Packard 这个是罪魁祸首，更换为<a href="http://vibsdepot.hp.com/hpq/sep2014/esxi-550-drv-vibs/hpvsa/scsi-hpvsa-5.5.0-88OEM.550.0.0.1331820.x86_64.vib">scsi-hpvsa-5.5.0-88OEM.550.0.0.1331820.x86_64.vib</a>问题解决，更换办法可以参考<a href="http://www.chiphell.com/thread-1330699-1-1.html">chiphell网友sym的攻略</a>,但是我最后还是使用了scsi-hpvsa-5.5.0-84OEM.550.0.0.1198611.x86_64.vib这个版本的驱动，<a href="http://wolfriya.blogspot.jp/2015/03/hp-proliant-microserver-gen8-exsi.html">原因是一位台湾网友的帖子，88版本有heartbeat问题，会造成虚拟机卡顿</a>：<br />
先把驱动上传esxi的存储，拷贝到/var/log/vmware/,我的上传路径是vmfs/volumes/datastorage1/drviers：</p>

<pre><code class="language-sh">cp vmfs/volumes/datastorage1/drviers/scsi-hpvsa-5.5.0-84OEM.550.0.0.1198611.x86_64.vib /var/log/vmware/</code></pre>

<p>然后运行：</p>

<pre><code class="language-sh">esxcli system maintenanceMode set --enable true</code></pre>

<p>进入维护模式，然后卸载原来的驱动，大约需要几十秒：</p>

<pre><code class="language-sh">esxcli software vib remove -n scsi-hpvsa -f</code></pre>

<p>接着安装驱动：</p>

<pre><code class="language-sh">esxcli software vib install -v file:scsi-hpvsa-5.5.0-84OEM.550.0.0.1198611.x86_64.vib --force --no-sig-check --maintenance-mode</code></pre>

<p>几十秒安装完成后，重启后退出维护模式</p>

<pre><code class="language-sh">esxcli system maintenanceMode set --enable no</code></pre>

<p>然后再测试拷贝，大约就有800-900Mbps（90-100+MB/s）的速度啦。</p>

<p>由于gen8的板载raid卡关系，不能直通硬盘控制器，否则esxi就不能用了。。除非用pcie的raid卡，但是我的已经被网卡占了。。。。所以只能取舍了。。。</p>

<p>2015年12月6日更新LACP链路聚合：<br />
上行链路uplink配置</p>

<p><br />
 <img src="https://jibenfa.github.io/uploads/2015/11/QQ20151206095232.png" width="1000" height="618" alt="AltText" />
 <br /></p>

<p>端口组portgroup配置</p>

<p><br />
 <img src="https://jibenfa.github.io/uploads/2015/11/QQ20151206095202.jpg" width="1000" height="618" alt="AltText" />
 <br /></p>

<p>distribute switch虚拟机配置</p>

<p><br />
 <img src="https://jibenfa.github.io/uploads/2015/11/QQ20151206094232.png" width="1000" height="618" alt="AltText" />
 <br /></p>

<p>HP交换机lacp配置</p>

<p><br />
 <img src="https://jibenfa.github.io/uploads/2015/11/QQ20151206094205.png" width="1000" height="618" alt="AltText" />
 <br /></p>

<p><br />
 <img src="https://jibenfa.github.io/uploads/2015/11/QQ20151206094147.png" width="1000" height="618" alt="AltText" />
 <br /></p>

<p><br />
 <img src="https://jibenfa.github.io/uploads/2015/11/QQ20151206094122.png" width="1000" height="618" alt="AltText" />
 <br /></p>

<p>可以看到，6,7端口分别承担了一半的流量，在虚拟机openwrt下和在虚拟机windows下可以达到至少1900Mbps（因为只有2台机器测试）</p>

<p><br />
 <img src="https://jibenfa.github.io/uploads/2015/11/QQ20151206111438.png" width="1000" height="618" alt="AltText" />
 <br /></p>

<p><br />
 <img src="https://jibenfa.github.io/uploads/2015/11/QQ20151206113210.jpg" width="1000" height="618" alt="AltText" />
 <br /></p>

  
	</div>
	<footer class="article-footer clearfix">
<div class="article-catetags">
  
    <div class="article-categories">
      <span></span>
      
        
        <a class="article-category-link" href="/categories/openwrt/">openwrt</a>
      
    </div>
  

  
    <div class="article-tags">
      <span></span>
      
        
        <a href="/tags/openwrt/">openwrt</a>
      
    </div>
  
</div>



	<div class="article-share" id="share">
	
	  <div data-url="https://jibenfa.github.io/openwrt/2015/11/29/e59ca8esxie4b88ae5ae89e8a385openwrtefbc8ce5ae9ee78eb0e8b7afe794b1e8999ae68b9fe58c96/" data-title="在HP GEN8上安装openwrt，实现“万兆”虚拟路由器。。。 | Welcome to Coffeecat‘s Blog" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>
   
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/%E5%85%B6%E4%BB%96/2015/09/18/e69cace7ab99e59f9fe5908de694b9e4b8barouteragency-com/" title="本站域名改为RouterAgency.com">
  <strong>上一篇：</strong><br/>
  <span>
  本站域名改为RouterAgency.com</span>
</a>
</div>


<div class="next">
<a href="/openwrt/2015/11/30/e8a7a3e586b3openwrt-readonly-file-systeme69687e4bbb6e7b3bbe7bb9fe58faae8afbbe79a84e997aee9a298/"  title="解决Openwrt Readonly file system文件系统只读的问题">
 <strong>下一篇：</strong><br/> 
 <span>解决Openwrt Readonly file system文件系统只读的问题
</span>
</a>
</div>

</nav>

	

</div>  

      
      
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside toc-content">
 
 <!--<%- toc(item.content) %>-->
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">


  
<div class="categorieslist">
  <p class="asidetitle">分类</p>
  <ul>
    
      
        
        <li>
          <a href="/categories/其他/" title="其他">
            其他<sup>5</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/categories/linux/" title="linux">
            linux<sup>9</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/categories/编程/" title="编程">
            编程<sup>5</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/categories/科学上网/" title="科学上网">
            科学上网<sup>15</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/categories/openwrt/" title="openwrt">
            openwrt<sup>45</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/categories/虚拟化/" title="虚拟化">
            虚拟化<sup>2</sup>
          </a>
        </li>
      
    
  </ul>
</div>



  
<div class="tagslist">
  <p class="asidetitle">标签</p>
  <ul class="clearfix">
    
      
        
        <li>
          <a href="/tags/里程碑/" title="里程碑">
            里程碑<sup>1</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/linux/" title="linux">
            linux<sup>9</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/编程/" title="编程">
            编程<sup>5</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/科学上网/" title="科学上网">
            科学上网<sup>14</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/插件/" title="插件">
            插件<sup>1</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/openwrt/" title="openwrt">
            openwrt<sup>45</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/microsoft/" title="Microsoft">
            Microsoft<sup>1</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/锐速/" title="锐速">
            锐速<sup>1</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/debian/" title="debian">
            debian<sup>1</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/虚拟化/" title="虚拟化">
            虚拟化<sup>2</sup>
          </a>
        </li>
      
    
      
        
        <li>
          <a href="/tags/apk/" title="apk">
            apk<sup>1</sup>
          </a>
        </li>
      
    
  </ul>
</div>



  
  <div class="tagcloudlist">
    <p class="asidetitle">标签云</p>
    <div id="tagcloud" class="tagcloudlist clearfix">
    </div>
  </div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
    </ul>
</div>

  


  

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>



</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I'm Coffeecat. <br/>
			This is my blog.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
	<!--
			<%  Array.prototype.S=String.fromCharCode(2);
			  Array.prototype.in_array=function(e){
    			var r=new RegExp(this.S+e+this.S);
    			return (r.test(this.S+this.join(this.S)+this.S));
				};
				var cc = new Array('by','by-nc','by-nc-nd','by-nc-sa','by-nd','by-sa','zero'); %>
		<% if (cc.in_array(theme.creative_commons) ) { %>
				<div class="cc-license">
          <a href="http://creativecommons.org/licenses/<%= theme.creative_commons %>/4.0" class="cc-opacity" target="_blank">
            <img src="<%- config.root %>img/cc-<%= theme.creative_commons %>.svg" alt="Creative Commons" />
          </a>
        </div>
    <% } %>
				-->

		<p class="copyright">
		Powered by <a href="http://jekyllrb.com" target="_blank" title="jekyll">jekyll</a> and Theme by <a href="https://github.com/simpleyyt/jekyll-jacman" target="_blank" title="Jacman">Jacman</a> © 2015 
		
		<a href="about" target="_blank" title="Coffeecat">Coffeecat</a>
		
		
		</p>
</div>
</footer>
    <script src="/assets/js/jquery-2.0.3.min.js"></script>
<script src="/assets/js/jquery.imagesloaded.min.js"></script>
<script src="/assets/js/gallery.js"></script>
<script src="/assets/js/jquery.qrcode-0.12.0.min.js"></script>
<script src="/assets/js/toc.js"></script>

<script type="text/javascript">
$(document).ready(function(){
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });

  

  $(window).resize(function(){
    getSize();
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
      
    }
  });
});
</script>


<script src="/assets/js/tagcloud.js"></script>
<script>
$(document).ready(function() {
  var tags = [
    
    { "name": "里程碑", "path": "/tags/里程碑/", "length": 1 },
    
    { "name": "linux", "path": "/tags/linux/", "length": 9 },
    
    { "name": "编程", "path": "/tags/编程/", "length": 5 },
    
    { "name": "科学上网", "path": "/tags/科学上网/", "length": 14 },
    
    { "name": "插件", "path": "/tags/插件/", "length": 1 },
    
    { "name": "openwrt", "path": "/tags/openwrt/", "length": 45 },
    
    { "name": "Microsoft", "path": "/tags/microsoft/", "length": 1 },
    
    { "name": "锐速", "path": "/tags/锐速/", "length": 1 },
    
    { "name": "debian", "path": "/tags/debian/", "length": 1 },
    
    { "name": "虚拟化", "path": "/tags/虚拟化/", "length": 2 },
    
    { "name": "apk", "path": "/tags/apk/", "length": 1 },
    
  ];
  $("#tagcloud").html(tagcloudHelper(tags));
});
</script>



<script type="text/javascript">
$(document).ready(function(){
  $('#toc.toc-aside').toc({
    title: "文章目录",
    showEffect: "none"
  });
  $('#toc.toc-article').toc({
    title: "文章目录",
    showEffect: "show",
    showSpeed: 0
  });
});
</script>



<script type="text/javascript">
$(document).ready(function(){
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>
<script type="module">
  import hljs from '/assets/js/highlight.js';

  // 获取页面中所有使用了语言的 <code class="language-xxx"> 块
  const codeBlocks = document.querySelectorAll('pre code[class^="language-"]');

  // 提取所有需要的语言类型（去重）
  const languageSet = new Set();
  codeBlocks.forEach((block) => {
    const lang = block.className.match(/language-([\w\d]+)/);
    if (lang && lang[1]) {
      languageSet.add(lang[1]);
    }
  });

  // 动态导入本地语言模块
  const languagePromises = Array.from(languageSet).map(async (lang) => {
    try {
      const module = await import(`/assets/js/languages/${lang}.min.js`);
      hljs.registerLanguage(lang, module.default);
    } catch (err) {
      console.warn(`Language module for "${lang}" not found.`);
    }
  });

  // 等全部语言模块注册后再高亮
  Promise.all(languagePromises).then(() => {
    hljs.highlightAll();
  });
</script>



<script type="text/javascript">
$(document).ready(function(){
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#nothing"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
/*
  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      //$('.hoverqrcode').hide();
  });
  */
});
</script>






<!--

-->




<link rel="stylesheet" href="/assets/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/assets/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      if ($(this).hasClass('emoji')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
});
</script>


<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/assets/img/scrollup.png"/></a>
	</div>
	<script src="/assets/js/totop.js"></script>


<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>

