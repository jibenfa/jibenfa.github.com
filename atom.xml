<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

 <title>Welcome to Coffeecat‘s Blog</title>
 <link href="https://jibenfa.github.io/atom.xml" rel="self"/>
 <link href="https://jibenfa.github.io"/>
 <updated>2025-08-20T09:19:00+00:00</updated>
 <id>https://jibenfa.github.io</id>
 <author>
   <name>Coffeecat</name>
   <email></email>
 </author>

 
 <entry>
   <title>在openwrt下使用chinadns-ng搭配v2ray实现透明代理</title>
   <link href="https://jibenfa.github.io/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/2025/08/19/E59CA8openwrtE4B88BE4BDBFE794A8chinadns-ngE690ADE9858Dv2rayE5AE9EE78EB0E9808FE6988EE4BBA3E79086/"/>
   <updated>2025-08-19T00:12:13+00:00</updated>
   <id>https://jibenfa.github.io/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/2025/08/19/E59CA8openwrtE4B88BE4BDBFE794A8chinadns-ngE690ADE9858Dv2rayE5AE9EE78EB0E9808FE6988EE4BBA3E79086</id>
   <content type="html">&lt;p&gt;之前在openwrt下一直用chinadns、dnsmasq搭配v2ray实现的透明代理上网，但是chinadns很久没维护了，另外看到了chinadns-ng，除了支持原版chinadns的功能外，还能实现dns over tcp/tls，按域名、ip分流，ipv6，还支持dns缓存，最新版本已经可以全面替代dnsmasq，dns查询性能大幅度提升。所以研究了一下，部署以后通过cdn warp后的代理速度明显提升，访问github网页速度提升了约40-50%。&lt;/p&gt;

&lt;p&gt;下面是部署的步骤：&lt;/p&gt;

&lt;p&gt;1.下载chinadns-ng&lt;/p&gt;

&lt;p&gt;1）从https://github.com/zfl9/chinadns-ng/releases/tag/2025.08.09 下载的现成的（自己编译openwrt下的chinadns-ng版本未成功。。。）。拷贝到/usr/bin下，并改名为chinadns-ng，
然后：&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;chmod&lt;/span&gt; +x /usr/bin/chinadns-ng
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;运行一下：&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;/usr/bin/chinadns-ng &lt;span class=&quot;nt&quot;&gt;-V&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;如果显示正常就ok了&lt;/p&gt;

&lt;p&gt;2）从https://github.com/zfl9/chinadns-ng 中下载source，提取其中的res文件夹下的文件，拷贝到/etc/chinadns-ng文件夹下，没有的话就创建一个，主要有以下几个文件：&lt;/p&gt;

&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# &lt;span class=&quot;k&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/etc/&lt;/span&gt;chinadns&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;ng/
chnlist&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;txt               chnroute6&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;ipset           direct&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;txt                disable_gfwip&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;nftset      gfwip6&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;nftset             &lt;span class=&quot;k&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;chnroute&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;nft&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;sh&lt;/span&gt;    &lt;span class=&quot;k&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;chnroute6&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;nft&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;sh&lt;/span&gt;
chnroute&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;ipset            chnroute6&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;nftset          disable_chnroute&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;nftset   disable_gfwip6&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;nftset     gfwlist&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;txt               &lt;span class=&quot;k&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;chnroute&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;v2ray&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;sh&lt;/span&gt;  &lt;span class=&quot;k&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;chnroute6&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;sh&lt;/span&gt;
chnroute&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;nftset           chnroute_v2ray&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;txt        disable_chnroute6&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;nftset  gfwip&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;nftset              &lt;span class=&quot;k&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;chnlist&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;sh&lt;/span&gt;         &lt;span class=&quot;k&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;chnroute&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;sh&lt;/span&gt;        &lt;span class=&quot;k&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;gfwlist&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;sh&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;注意：
direct.txt,
update-chnroute-v2ray.sh,
chnroute_v2ray.txt,
disable_chnroute.nftset,
disable_chnroute6.nftset,
gfwip.nftset,
gfwip6.nftset,
disable_gfwip.nftset,
disable_gfwip6.nftset是我创建的。&lt;/p&gt;

&lt;p&gt;a)其中direct.txt中内容为需要通过国内114解析的域名，主要是v2ray的域名！这一点非常重要，v2ray域名一定要由国内dns解析，否则无法连接。例如v2ray服务端域名是xxx.com，则direct.txt内容可以为：&lt;/p&gt;

&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;xxx&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;com&lt;/span&gt;
ntp&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;org
vultur&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;com&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;b)update-chnroute-v2ray.sh主要用于拉取国内ip段，生成chnroute_v2ray.txt，内容为：&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/bash&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; errexit
&lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; pipefail

&lt;span class=&quot;c&quot;&gt;# exit if curl failed&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-4fsSkL&lt;/span&gt; https://raw.githubusercontent.com/pexcn/daily/gh-pages/chnroute/chnroute.txt&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;chnroute_v2ray.txt
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$data&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;awk&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;{printf(&quot;%s\n&quot;, $0)}&apos;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;chnroute_v2ray.txt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;其实chnroute_v2ray.txt内容和之前chinadns的chinadns_chnroute.txt是一毛一样的，主要用于v2ray。&lt;/p&gt;

&lt;p&gt;c)disable_chnroute.nftset内容为：&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;flush &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;inet global chnroute
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;d)disable_chnroute6.nftset内容为：&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;flush &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;inet global chnroute6
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;e)gfwip.nftset内容为：&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;add table inet global
add &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;inet global gfwip &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;type &lt;/span&gt;ipv4_addr&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;flags interval&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;f)gfwip6.nftset内容为：&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;add table inet global
add &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;inet global gfwip8 &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;type &lt;/span&gt;ipv4_addr&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;flags interval&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;g)disable_chnroute.nftset内容为：&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;flush &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;inet global gfwip
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;h)disable_chnroute6.nftset内容为：&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;flush &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;inet global gfwip6
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2.配置chinadns-ng&lt;/p&gt;

&lt;p&gt;1）创建并修改配置文件/etc/config/chinadns-ng:&lt;/p&gt;
&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# 监听地址和端口
bind&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;addr &lt;span class=&quot;m&quot;&gt;127&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;
bind&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;port &lt;span class=&quot;m&quot;&gt;5353&lt;/span&gt;

# 国内 DNS
china&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;dns &lt;span class=&quot;m&quot;&gt;114&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;114&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;114&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;114&lt;/span&gt;
china&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;dns &lt;span class=&quot;m&quot;&gt;223&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;
china&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;dns &lt;span class=&quot;m&quot;&gt;119&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;29&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;29&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;29&lt;/span&gt;

# 国外 DNS
trust&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;dns &lt;span class=&quot;m&quot;&gt;127&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;#&lt;span class=&quot;m&quot;&gt;5354&lt;/span&gt;
trust&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;dns tcp&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt;//&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;127&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;#&lt;span class=&quot;m&quot;&gt;5356&lt;/span&gt;
trust&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;dns &lt;span class=&quot;m&quot;&gt;127&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;#&lt;span class=&quot;m&quot;&gt;5358&lt;/span&gt;
trust&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;dns &lt;span class=&quot;m&quot;&gt;127&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;#&lt;span class=&quot;m&quot;&gt;5360&lt;/span&gt;

# 列表文件
chnlist&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;file&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/etc/&lt;/span&gt;chinadns&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;ng/chnlist&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;txt
gfwlist&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;file&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/etc/&lt;/span&gt;chinadns&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;ng/gfwlist&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;txt

# group文件
group direct
group&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;dnl &lt;span class=&quot;sr&quot;&gt;/etc/&lt;/span&gt;chinadns&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;ng/direct&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;txt
group&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;upstream &lt;span class=&quot;m&quot;&gt;114&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;114&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;114&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;114&lt;/span&gt;

# 收集 &lt;span class=&quot;k&quot;&gt;tag&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;chn、&lt;span class=&quot;k&quot;&gt;tag&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;gfw&lt;/span&gt; 域名的 IP &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;可选&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
# 相关 family，table，set名称要与nftset文件中的一致，否则无法生效
#&lt;span class=&quot;nb&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;tagchn&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;ip inet@global@chnip&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;inet@global@chnip6
&lt;span class=&quot;nb&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;taggfw&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;ip inet@global@gfwip&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;inet@global@gfwip6

# 测试 &lt;span class=&quot;k&quot;&gt;tag&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;none 域名的 IP &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;针对国内上游&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
# 相关 family，table，set名称要与nftset文件中的一致，否则无法生效
ipset&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;name4 inet@global@chnroute
ipset&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;name6 inet@global@chnroute6

# dns 缓存
cache &lt;span class=&quot;m&quot;&gt;4096&lt;/span&gt;
cache&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;stale &lt;span class=&quot;m&quot;&gt;86400&lt;/span&gt;
cache&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;refresh &lt;span class=&quot;m&quot;&gt;20&lt;/span&gt;

# verdict 缓存 &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;用于 &lt;span class=&quot;k&quot;&gt;tag&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;none 域名&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
verdict&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;cache &lt;span class=&quot;m&quot;&gt;4096&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2）注册为系统服务&lt;/p&gt;

&lt;p&gt;创建并编辑/etc/init.d/chinadns-ng&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/sh /etc/rc.common&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# init script for chinadns-ng&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;START&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;85
&lt;span class=&quot;nv&quot;&gt;STOP&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;10

&lt;span class=&quot;nv&quot;&gt;USE_PROCD&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1
&lt;span class=&quot;nv&quot;&gt;PROG&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/bin/chinadns-ng
&lt;span class=&quot;nv&quot;&gt;CONF&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/etc/config/chinadns-ng

&lt;span class=&quot;c&quot;&gt;#下列NFTSET文件中相关 family，table，set名称要也与chinadnsng配置文件中的一致，否则无法生效&lt;/span&gt;
enable_nft_rules &lt;span class=&quot;o&quot;&gt;(){&lt;/span&gt;
    nft &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; /etc/chinadns-ng/chnroute.nftset
    nft &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; /etc/chinadns-ng/chnroute6.nftset
    nft &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; /etc/chinadns-ng/gfwip.nftset
    nft &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; /etc/chinadns-ng/gfwip6.nftset
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

disable_nft_rules &lt;span class=&quot;o&quot;&gt;(){&lt;/span&gt;
    nft &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; /etc/chinadns-ng/disable_chnroute.nftset
    nft &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; /etc/chinadns-ng/disable_chnroute6.nftset
    nft &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; /etc/chinadns-ng/disable_gfwip.nftset
    nft &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; /etc/chinadns-ng/disable_gfwip6.nftset
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

start_service&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-x&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$PROG&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;exit &lt;/span&gt;1
    &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$CONF&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;exit &lt;/span&gt;1
    &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[+] 启动 chinadns-ng 服务&quot;&lt;/span&gt;
    procd_open_instance
    procd_set_param &lt;span class=&quot;nb&quot;&gt;command&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$PROG&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-C&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$CONF&lt;/span&gt;
    procd_set_param respawn
    enable_nft_rules
    procd_close_instance
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

stop_service&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[+] 停止 chinadns-ng 服务&quot;&lt;/span&gt;
    disable_nft_rules
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;然后执行：&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;chmod&lt;/span&gt; +x /etc/init.d/chinadns-ng
/etc/init.d/chinadns-ng &lt;span class=&quot;nb&quot;&gt;enable&lt;/span&gt;
/etc/init.d/chinadns-ng start
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3.配置v2ray&lt;/p&gt;

&lt;p&gt;1）修改配置文件（/etc/config/v2ray.json）&lt;/p&gt;
&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;c&quot;&gt;&quot;inbounds&quot;: [&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;    
      &lt;span class=&quot;c&quot;&gt;&quot;protocol&quot;: &quot;dokodemo-door&quot;,&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;port&quot;: 1060,&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;listen&quot;:&quot;0.0.0.0&quot;,&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;sniffing&quot;: {&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;enabled&quot;: false,&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;destOverride&quot;: [&quot;http&quot;, &quot;tls&quot;]&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
       &lt;span class=&quot;c&quot;&gt;&quot;settings&quot;: {&lt;/span&gt;
         &lt;span class=&quot;c&quot;&gt;&quot;network&quot;: &quot;tcp,udp&quot;,&lt;/span&gt;
         &lt;span class=&quot;c&quot;&gt;&quot;followRedirect&quot;: true &lt;/span&gt;
       &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;protocol&quot;: &quot;dokodemo-door&quot;,&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;listen&quot;:&quot;0.0.0.0&quot;,&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;port&quot;: 5354,&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;settings&quot;: {&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;address&quot;: &quot;8.8.8.8&quot;,&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;port&quot;: 53,&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;network&quot;: &quot;udp&quot;,&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;timeout&quot;: 0,&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;followRedirect&quot;: false&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;protocol&quot;: &quot;dokodemo-door&quot;,&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;listen&quot;:&quot;0.0.0.0&quot;,&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;port&quot;: 5356,&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;settings&quot;: {&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;address&quot;: &quot;8.8.8.8&quot;,&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;port&quot;: 53,&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;network&quot;: &quot;tcp&quot;,&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;timeout&quot;: 0,&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;followRedirect&quot;: false&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;protocol&quot;: &quot;dokodemo-door&quot;,&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;listen&quot;:&quot;0.0.0.0&quot;,&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;port&quot;: 5358,&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;settings&quot;: {&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;address&quot;: &quot;1.1.1.1&quot;,&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;port&quot;: 53,&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;network&quot;: &quot;udp&quot;,&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;timeout&quot;: 0,&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;followRedirect&quot;: false&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;protocol&quot;: &quot;dokodemo-door&quot;,&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;listen&quot;:&quot;0.0.0.0&quot;,&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;port&quot;: 5360,&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;settings&quot;: {&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;address&quot;: &quot;8.8.4.4&quot;,&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;port&quot;: 53,&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;network&quot;: &quot;udp&quot;,&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;timeout&quot;: 0,&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;followRedirect&quot;: false&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
  &lt;span class=&quot;c&quot;&gt;&quot;outbounds&quot;: [&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;protocol&quot;: &quot;vless&quot;,&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;tag&quot;: &quot;proxy&quot;,&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;settings&quot;: {&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;vnext&quot;: [&lt;/span&gt;
          &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;c&quot;&gt;&quot;address&quot;: &quot;xxx.com&quot;,&lt;/span&gt;
            &lt;span class=&quot;c&quot;&gt;&quot;port&quot;: 443,&lt;/span&gt;
            &lt;span class=&quot;c&quot;&gt;&quot;users&quot;: [&lt;/span&gt;
              &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;c&quot;&gt;&quot;id&quot;: &quot;***************uuid************************&quot;,&lt;/span&gt;
                &lt;span class=&quot;c&quot;&gt;&quot;encryption&quot;: &quot;none&quot;&lt;/span&gt;
              &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
          &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;streamSettings&quot;: {&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;network&quot;: &quot;ws&quot;,&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;security&quot;: &quot;tls&quot;,&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;wsSettings&quot;: {&lt;/span&gt;
          &lt;span class=&quot;c&quot;&gt;&quot;path&quot;: &quot;/mypath&quot;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;tcpSettings&quot;: {&lt;/span&gt;
          &lt;span class=&quot;c&quot;&gt;&quot;allowInsecureCiphers&quot;: false&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2）调整启动脚本（/etc/init.d/v2ray）&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/sh /etc/rc.common&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# This is free software, licensed under the GNU General Public License v3.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# See /LICENSE for more information.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# To use this file, install chinadns-ng,v2ray,coreutils-nohup,coreutils-paste first&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;START&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;90
&lt;span class=&quot;nv&quot;&gt;USE_PROCD&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1

&lt;span class=&quot;nv&quot;&gt;DOMAIN&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;xxx.com&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;DNS_SERVER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;114.114.114.114&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;BACKUP_DNS_SERVER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;119.29.29.29 223.5.5.5 180.76.76.76&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;LOCAL_IP&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;127.0.0.1&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;CHINADNSNG_PORT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5353&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;CHINADNSNG_FILES_PATH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/etc/chinadns-ng/&quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# 本配置文件中NFT默认参数为：&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# family:inet&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# table:global&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# set:chnroute,chnroute6,gfwip,gfwip6&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# 上述值需与chinadnsng配置文件中的一致，否则无法生效：&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# add-taggfw-ip inet@global@gfwip,inet@global@gfwip6&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# ipset-name4 inet@global@chnroute&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# ipset-name6 inet@global@chnroute6&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# 且下列NFTSET文件中相关 family，table，set名称要也与chinadnsng配置文件中的一致，否则无法生效&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;CHNROUTE_NFT_NAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;chnroute.nftset&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;CHNROUTE6_NFT_NAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;chnroute6.nftset&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;GFWIP_NFT_NAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;gfwip.nftset&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;GFWIP6_NFT_NAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;gfwip6.nftset&quot;&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;V2RAY_PORT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;1060&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;V2RAY_DNS_PORTS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5354 5356 5358 5360&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;V2RAY_BIN&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/usr/bin/v2ray&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;V2RAY_CONF&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/etc/config/v2ray.json&quot;&lt;/span&gt;

set_multi_domestic_dns&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;current_dns_list&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;uci get dhcp.@dnsmasq[0].server 2&amp;gt;/dev/null&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; x&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;DNS_SERVER&lt;/span&gt;:0:15&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; x&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;current_dns_list&lt;/span&gt;:0:15&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
        &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[+] 设置使用国内DNS服务器&quot;&lt;/span&gt;
        uci &lt;span class=&quot;nt&quot;&gt;-q&lt;/span&gt; delete dhcp.@dnsmasq[0].server
        uci add_list dhcp.@dnsmasq[0].server&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;DNS_SERVER&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;dns &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$BACKUP_DNS_SERVER&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do
            &lt;/span&gt;uci add_list dhcp.@dnsmasq[0].server&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;dns&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;done
        &lt;/span&gt;uci &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;dhcp.@dnsmasq[0].noresolv&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0
        uci &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;dhcp.@dnsmasq[0].nohosts&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0
        uci commit dhcp
        &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[+] 重启dnsmasq服务&quot;&lt;/span&gt;
        /etc/init.d/dnsmasq restart 1&amp;gt;/dev/null 2&amp;gt;&amp;amp;1
        &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[✓] 完成&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

set_multi_foreign_dns&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;current_dns_list&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;uci get dhcp.@dnsmasq[0].server 2&amp;gt;/dev/null&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; x&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;LOCAL_IP&lt;/span&gt;:0:9&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; x&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;current_dns_list&lt;/span&gt;:0:9&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
        &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[+] 设置使用ChinaDNSNG DNS服务器&quot;&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;chinadnsng_listen_ipport&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;LOCAL_IP&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;#&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;CHINADNSNG_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
        uci &lt;span class=&quot;nt&quot;&gt;-q&lt;/span&gt; delete dhcp.@dnsmasq[0].server
        uci add_list dhcp.@dnsmasq[0].server&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;chinadnsng_listen_ipport&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
        uci &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;dhcp.@dnsmasq[0].noresolv&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1
        uci &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;dhcp.@dnsmasq[0].nohosts&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1
        uci commit dhcp
        &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[+] 重启dnsmasq服务&quot;&lt;/span&gt;
        /etc/init.d/dnsmasq restart 1&amp;gt;/dev/null 2&amp;gt;&amp;amp;1
        &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[✓] 完成&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

create_chnroute&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;   
    &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[*] 创建 inet global 表和 chnroute 和 chnroute6 集合&quot;&lt;/span&gt; 

    nft &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;CHINADNSNG_FILES_PATH&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;CHNROUTE_NFT_NAME&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
    nft &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;CHINADNSNG_FILES_PATH&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;CHNROUTE6_NFT_NAME&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;# 添加私有地址段&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[+] 添加内网地址段到 chnroute&quot;&lt;/span&gt;
    nft add element inet global chnroute  &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
        0.0.0.0/8, 10.0.0.0/8, 127.0.0.0/8, &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
        169.254.0.0/16, 172.16.0.0/12, &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
        192.168.0.0/16, 224.0.0.0/4, 240.0.0.0/4 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;# 加载 VPS 域名解析结果&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[+] 解析 &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$DOMAIN&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; 并加入 chnroute&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;ip &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;dig +short &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$DOMAIN&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; @&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$DNS_SERVER&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;grep&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Eo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;([0-9]{1,3}\.){3}[0-9]{1,3}&apos;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do
        &lt;/span&gt;nft add element inet global chnroute &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$ip&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;    加入 &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$ip&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;done
    &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;    chnroute 已载入 &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;nft list &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;inet global chnroute | &lt;span class=&quot;nb&quot;&gt;grep&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-oE&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+(/[0-9]+)?&apos;&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;wc&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-l&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; 条目&quot;&lt;/span&gt;

&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

create_gfwip&lt;span class=&quot;o&quot;&gt;(){&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[*] 创建 inet global 表和 gfwip 和 gfwip6 集合&quot;&lt;/span&gt;

    nft &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;CHINADNSNG_FILES_PATH&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;GFWIP_NFT_NAME&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
    nft &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;CHINADNSNG_FILES_PATH&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;GFWIP6_NFT_NAME&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

create_empty_chain&lt;span class=&quot;o&quot;&gt;(){&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;# 确保 table 存在&lt;/span&gt;
    nft create table inet global 2&amp;gt;/dev/null

    &lt;span class=&quot;c&quot;&gt;# 确保 prerouting/output 链存在&lt;/span&gt;
    nft create chain inet global prerouting &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;type &lt;/span&gt;nat hook prerouting priority dstnat&lt;span class=&quot;se&quot;&gt;\;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; 2&amp;gt;/dev/null
    nft create chain inet global output &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;type &lt;/span&gt;nat hook output priority &lt;span class=&quot;nt&quot;&gt;-100&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; 2&amp;gt;/dev/null

    &lt;span class=&quot;c&quot;&gt;# 清空链&lt;/span&gt;
    nft flush chain inet global prerouting
    nft flush chain inet global output
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

create_chain_rules&lt;span class=&quot;o&quot;&gt;(){&lt;/span&gt;
    create_empty_chain
    nft add rule inet global prerouting ip daddr &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;LOCAL_IP&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; tcp dport &lt;span class=&quot;se&quot;&gt;\{&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;CHINADNSNG_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;,&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_DNS_PORTS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;// /,&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return &lt;/span&gt;2&amp;gt;/dev/null
    nft add rule inet global prerouting ip daddr &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;LOCAL_IP&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; udp dport &lt;span class=&quot;se&quot;&gt;\{&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;CHINADNSNG_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;,&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_DNS_PORTS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;// /,&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return &lt;/span&gt;2&amp;gt;/dev/null
    nft add rule inet global output ip daddr &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;LOCAL_IP&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; tcp dport &lt;span class=&quot;se&quot;&gt;\{&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;CHINADNSNG_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;,&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_DNS_PORTS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;// /,&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return &lt;/span&gt;2&amp;gt;/dev/null
    nft add rule inet global output ip daddr &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;LOCAL_IP&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; udp dport &lt;span class=&quot;se&quot;&gt;\{&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;CHINADNSNG_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;,&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_DNS_PORTS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;// /,&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return &lt;/span&gt;2&amp;gt;/dev/null
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

enable_chnroute_firewall_rules&lt;span class=&quot;o&quot;&gt;(){&lt;/span&gt;
    create_chain_rules
    nft add rule inet global prerouting ip daddr &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; @chnroute tcp dport 0-65535 counter redirect to :&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; 2&amp;gt;/dev/null
    nft add rule inet global output ip daddr &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; @chnroute tcp dport 0-65535 counter redirect to :&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; 2&amp;gt;/dev/null
    nft add rule inet global prerouting ip6 daddr &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; @chnroute6 tcp dport 0-65535 counter redirect to :&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; 2&amp;gt;/dev/null
    nft add rule inet global output ip6 daddr &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; @chnroute6 tcp dport 0-65535 counter redirect to :&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; 2&amp;gt;/dev/null
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

enable_gfwip_firewall_rules&lt;span class=&quot;o&quot;&gt;(){&lt;/span&gt;
    create_chain_rules
    nft add rule inet global prerouting ip daddr @gfwip tcp dport 0-65535 counter redirect to :&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; 2&amp;gt;/dev/null
    nft add rule inet global output ip daddr @gfwip tcp dport 0-65535 counter redirect to :&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; 2&amp;gt;/dev/null
    nft add rule inet global prerouting ip6 daddr @gfwip6 tcp dport 0-65535 counter redirect to :&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; 2&amp;gt;/dev/null
    nft add rule inet global output ip6 daddr @gfwip6 tcp dport 0-65535 counter redirect to :&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; 2&amp;gt;/dev/null
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

disable_v2ray_rules&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    create_empty_chain
    set_multi_domestic_dns
    &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;ingfw&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /tmp/v2raymode.txt   
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

stop_service&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[+] 停止 v2ray 服务&quot;&lt;/span&gt;
    disable_v2ray_rules
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

enable_v2ray_rules&lt;span class=&quot;o&quot;&gt;(){&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;running_v2ray_mode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /tmp/v2raymode.txt 2&amp;gt;/dev/null | &lt;span class=&quot;nb&quot;&gt;tr&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;\r&apos;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;v2ray_mode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;uci get advancedconfig.@rules[0].v2raymode 2&amp;gt;/dev/null&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; x&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;v2ray_mode&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; x&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;running_v2ray_mode&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
        &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[+] v2ray模式未变化&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;else
        &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[+] v2ray模式已变化&quot;&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[+] 设置&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;v2ray_mode&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;模式中&quot;&lt;/span&gt;
        disable_v2ray_rules
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;v2ray_mode&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;outlands&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
            &lt;/span&gt;create_chnroute
            enable_chnroute_firewall_rules
            set_multi_foreign_dns
        
        &lt;span class=&quot;k&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;v2ray_mode&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;gfwlist&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
            &lt;/span&gt;create_gfwip
            enable_gfwip_firewall_rules
            set_multi_foreign_dns
        
        &lt;span class=&quot;k&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;v2ray_mode&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;ingfw&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
            &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; “[+] 启动墙内访问模式”
        &lt;span class=&quot;k&quot;&gt;fi
        &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;v2ray_mode&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /tmp/v2raymode.txt
    &lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

start_service&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[+] 启动 v2ray 服务&quot;&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;mkdir&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; /var/log/v2ray
    &lt;span class=&quot;nb&quot;&gt;ulimit&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-n&lt;/span&gt; 65535
    procd_open_instance
    procd_set_param &lt;span class=&quot;nb&quot;&gt;command&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$V2RAY_BIN&lt;/span&gt; run &lt;span class=&quot;nt&quot;&gt;-config&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$V2RAY_CONF&lt;/span&gt;
    procd_set_param file &lt;span class=&quot;nv&quot;&gt;$V2RAY_CONF&lt;/span&gt;
    procd_set_param respawn
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_set_param pidfile /var/run/v2ray.pid
    enable_v2ray_rules
    procd_close_instance
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

service_triggers&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    procd_add_reload_trigger &lt;span class=&quot;s2&quot;&gt;&quot;advancedconfig&quot;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;4.调整dnsmasq，chinadns等配置，避免冲突。&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;&apos;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /etc/dnsmasq.conf
/etc/init.d/chinadns disable
/etc/init.d/chinadns stop
&lt;span class=&quot;nb&quot;&gt;rm&lt;/span&gt; /root/start_multi_chinadns.sh
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;然后在luci界面中，把“网络-&amp;gt;dhcp/dns-&amp;gt;转发”菜单下的dns转发改成“127.0.0.1#5353”，保存后重启openwrt。&lt;/p&gt;

&lt;p&gt;参考：
1.https://github.com/zfl9/chinadns-ng
2.chatgpt&lt;/p&gt;
</content>
 </entry>
 
 <entry>
   <title>使用warp隐藏vps的真实ip</title>
   <link href="https://jibenfa.github.io/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/2025/08/14/E4BDBFE794A8warpE99A90E8978FvpsE79A84E79C9FE5AE9Eip/"/>
   <updated>2025-08-14T00:12:13+00:00</updated>
   <id>https://jibenfa.github.io/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/2025/08/14/E4BDBFE794A8warpE99A90E8978FvpsE79A84E79C9FE5AE9Eip</id>
   <content type="html">&lt;p&gt;最近发现一些境外的图层网站还有例如reddit等网站屏蔽了很多vps的ip地址，导致即使通过vps代理也无法访问这些网站。研究了一下，发现运行v2ray的vps使用warp可以隐藏vps的真实ip。&lt;/p&gt;

&lt;p&gt;简单来说访问网络的数据路径变更为：&lt;/p&gt;

&lt;p&gt;境内v2ray客户端 → Cloudflare CDN 集群 → 境外VPS → Cloudflare WARP 集群→ reddit等网站&lt;/p&gt;

&lt;p&gt;这样vps出口ip就变成了Cloudflare池子里面的ip了，实际测试可以访问reddit等网站。不得不说Cloudflare真是赛博大善人！&lt;/p&gt;

&lt;p&gt;具体配置如下：&lt;/p&gt;

&lt;p&gt;1.安装warp&lt;/p&gt;

&lt;p&gt;根据 https://pkg.cloudflareclient.com/ 网站上的安装指南安装warp，我的vps是ubuntu，安装步骤如下：&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# Add cloudflare gpg key&lt;/span&gt;
curl &lt;span class=&quot;nt&quot;&gt;-fsSL&lt;/span&gt; https://pkg.cloudflareclient.com/pubkey.gpg | &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;gpg &lt;span class=&quot;nt&quot;&gt;--yes&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--dearmor&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--output&lt;/span&gt; /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg


&lt;span class=&quot;c&quot;&gt;# Add this repo to your apt repositories&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;deb [signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;lsb_release &lt;span class=&quot;nt&quot;&gt;-cs&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; main&quot;&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;sudo tee&lt;/span&gt; /etc/apt/sources.list.d/cloudflare-client.list


&lt;span class=&quot;c&quot;&gt;# Install&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt-get update &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt-get &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;cloudflare-warp

&lt;span class=&quot;c&quot;&gt;# 启动 WARP 服务&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl start warp-svc
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;warp-svc
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2.设置warp&lt;/p&gt;

&lt;p&gt;1)注册warp&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;warp-cli registration new
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;2)设置warp为代理模式&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;warp-cli mode proxy
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;注意，如果跳过这步，直接运行：sudo warp-cli connect 的话会直接导致vps的ssh断连，因为所有出口都经过warp，且没有任何配置，这时候需要通过vps供应商的管理界面把warp断掉才行。&lt;/p&gt;

&lt;p&gt;3）启动warp&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;warp-cli connect
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;4）检测warp运行情况&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#检查监听端口&lt;/span&gt;
ss &lt;span class=&quot;nt&quot;&gt;-ltnp&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;grep &lt;/span&gt;40000

&lt;span class=&quot;c&quot;&gt;# 测试 SOCKS5 代理是否能访问 Google&lt;/span&gt;
curl &lt;span class=&quot;nt&quot;&gt;--socks5&lt;/span&gt; 127.0.0.1:40000 https://www.google.com &lt;span class=&quot;nt&quot;&gt;-v&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# 或者测试 Cloudflare 是否通&lt;/span&gt;
curl &lt;span class=&quot;nt&quot;&gt;--socks5&lt;/span&gt; 127.0.0.1:40000 https://www.cloudflare.com/cdn-cgi/trace
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;如果有返回结果就ok了。&lt;/p&gt;

&lt;p&gt;5）把warp-proxy注册为系统服务&lt;/p&gt;

&lt;p&gt;a.创建 systemd 服务文件&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;vi /etc/systemd/system/warp-proxy.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;b.编辑warp-proxy.service&lt;/p&gt;
&lt;div class=&quot;language-ini highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nn&quot;&gt;[Unit]&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;Description&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;Cloudflare WARP Proxy Mode&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;After&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;network.target&lt;/span&gt;

&lt;span class=&quot;nn&quot;&gt;[Service]&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;oneshot&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;ExecStart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/usr/bin/warp-cli mode proxy&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;ExecStartPost&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/usr/bin/warp-cli connect&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;RemainAfterExit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;yes&lt;/span&gt;

&lt;span class=&quot;nn&quot;&gt;[Install]&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;WantedBy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;multi-user.target&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;c.重新加载 systemd 并启用服务&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl daemon-reload
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;warp-proxy.service
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl start warp-proxy.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;d.重启vps后，检查状态&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;warp-cli status
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;显示 connected 就ok了&lt;/p&gt;

&lt;p&gt;3.配置v2ray服务端，修改v2ray的配置文件为：&lt;/p&gt;
&lt;div class=&quot;language-json highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;inbounds&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;port&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;23456&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;listen&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;127.0.0.1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;protocol&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;vless&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;settings&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;clients&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
          &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
            &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;id&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;********hidden-uuid************&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
          &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;decryption&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;none&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;streamSettings&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;network&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;ws&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;wsSettings&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
          &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;path&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/mypath&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;outbounds&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;protocol&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;socks&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;settings&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;servers&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
          &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
            &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;address&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;127.0.0.1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
            &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;port&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;40000&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
          &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;tag&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;warp&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;protocol&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;freedom&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;tag&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;direct&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;routing&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;domainStrategy&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;AsIs&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;rules&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;type&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;field&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;outboundTag&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;direct&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;domain&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
          &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;geosite:netflix&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
          &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;geosite:youtube&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;type&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;field&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;outboundTag&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;direct&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;ip&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
            &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;127.0.0.1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; 
            &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;::1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
            &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;8.8.8.8&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
            &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;8.8.4.4&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
            &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;1.1.1.1&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;type&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;field&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;outboundTag&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;warp&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;network&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;tcp,udp&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;最后重启v2ray服务即可，客户端不用做任何改动。&lt;/p&gt;

&lt;p&gt;这个配置文件的含义是，除了Netflix和YouTube网站、本机、还有几个dns的ip走直连外，其他流量都经过warp。当然也可以根据需求使用其他配置。&lt;/p&gt;

&lt;p&gt;免费版 Warp 在高并发/大流量下会出现限速，一般稳定在 10~50Mbps 左右，而且网络延迟也会增加一些，所以只要网站不限制vps ip访问（或者没有强隐私需求，有的网站会抓取访问的ip作别的用途），没有必要通过Warp。&lt;/p&gt;

&lt;p&gt;参考：&lt;/p&gt;

&lt;p&gt;1.https://pkg.cloudflareclient.com/&lt;/p&gt;

&lt;p&gt;2.chatgpt&lt;/p&gt;
</content>
 </entry>
 
 <entry>
   <title>更换了本站的主题</title>
   <link href="https://jibenfa.github.io/%E5%85%B6%E4%BB%96/2025/08/08/E69BB4E68DA2E4BA86E69CACE7AB99E79A84E4B8BBE9A298/"/>
   <updated>2025-08-08T00:12:13+00:00</updated>
   <id>https://jibenfa.github.io/%E5%85%B6%E4%BB%96/2025/08/08/E69BB4E68DA2E4BA86E69CACE7AB99E79A84E4B8BBE9A298</id>
   <content type="html">&lt;p&gt;最近更换了本站的主题，主要是基于
&lt;a href=&quot;https://github.com/Simpleyyt/jekyll-jacman&quot;&gt;jekyll-jacman主题&lt;/a&gt;做的二次开发，主要修改内容：&lt;/p&gt;

&lt;p&gt;1.修复了当分类和标签为中文时，超级链接失效的问题。&lt;/p&gt;

&lt;p&gt;2.从原来内置的rouge代码高亮主题升级成了&lt;a href=&quot;https://github.com/highlightjs/highlight.js&quot;&gt;highlight.js&lt;/a&gt;代码高亮方案，支持切换主题和多语言。&lt;/p&gt;

&lt;p&gt;3.修复了页面布局中分类和标签的左右间距和上下对齐问题。&lt;/p&gt;

&lt;p&gt;4.增加了代码复制按钮。&lt;/p&gt;

&lt;p&gt;另外发现通过：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-html&quot;&gt; 
```lua 
{代码} 
```
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;比使用：&lt;/p&gt;
&lt;div class=&quot;language-html highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;pre&amp;gt;&amp;lt;code&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;class=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;language-lua&quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt; 
{代码} 
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/code&amp;gt;&amp;lt;/pre&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;对lua类的代码兼容性更好，不会出现jekyll解析时的错误转义，导致显示错误。&lt;/p&gt;
</content>
 </entry>
 
 <entry>
   <title>openwrt下apk命令报FDB格式错误的解决方法</title>
   <link href="https://jibenfa.github.io/openwrt/2025/08/05/openwrtE4B88BapkE591BDE4BBA4E68AA5FDBE6A0BCE5BC8FE99499E8AFAFE79A84E8A7A3E586B3E696B9E6B395/"/>
   <updated>2025-08-05T04:23:13+00:00</updated>
   <id>https://jibenfa.github.io/openwrt/2025/08/05/openwrtE4B88BapkE591BDE4BBA4E68AA5FDBE6A0BCE5BC8FE99499E8AFAFE79A84E8A7A3E586B3E696B9E6B395</id>
   <content type="html">&lt;p&gt;话说openwrt正式版安装命令是opkg，现在snapshot里面变成了apk。前几天尝试了一下，居然得到一个报错：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
  
root@OpenWrt:~# apk update
ERROR: FDB format error &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;line 7002, entry &lt;span class=&quot;s1&quot;&gt;&apos;Z&apos;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
ERROR: Unable to &lt;span class=&quot;nb&quot;&gt;read &lt;/span&gt;database: v2 database format error
ERROR: Failed to open apk database: v2 database format error


&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;研究了一下，其实这个报错，跟以前opkg被lock的情况有点相似，只不过是apk采用了数据库，更新的时候异常关闭导致的。&lt;/p&gt;

&lt;p&gt;解决方案是：&lt;/p&gt;

&lt;p&gt;打开/lib/apk/db 里面有个installed 的数据库，然后找到报错的行，进行修改。当然也可以简单删除这个库，只不过会导致重新安装一遍所有软件，不建议直接删。&lt;/p&gt;

&lt;p&gt;话说使用snapshot要慎重，用apk的话以前现成的.ipk的安装包统统不能用了，要重新编译打包成.apk包。另外snapshot下缺失不少软件，例如mtk的bind-dig就没有，还有就是稳定性的问题。&lt;/p&gt;
</content>
 </entry>
 
 <entry>
   <title>openwrt下v2ray透明代理配置从iptables向nftables迁移</title>
   <link href="https://jibenfa.github.io/openwrt/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/2025/07/30/openwrtE4B88Bv2rayE9808FE6988EE4BBA3E79086vE9858DE7BDAEE4BB8EiptablesE59091nftablesE8BF81E7A7BB/"/>
   <updated>2025-07-30T03:22:13+00:00</updated>
   <id>https://jibenfa.github.io/openwrt/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/2025/07/30/openwrtE4B88Bv2rayE9808FE6988EE4BBA3E79086vE9858DE7BDAEE4BB8EiptablesE59091nftablesE8BF81E7A7BB</id>
   <content type="html">&lt;p&gt;由于openwrt的防火墙逐步从iptables向nftables升级，官方24.10.2的dnsmasq包默认不将ipset纳入编译选项，只支持nftset，
由此带来v2ray透明代理的配置必须进行升级，此次主要是调整了v2ray的配置和dnsmasq-full的配置。&lt;/p&gt;

&lt;p&gt;1）修改/etc/init.d/v2ray&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
  
&lt;span class=&quot;c&quot;&gt;#!/bin/sh /etc/rc.common&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# This is free software, licensed under the GNU General Public License v3.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# See /LICENSE for more information.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# To use this file, install chinadns,v2ray,dnsmasq-full,coreutils-nohup,coreutils-paste first&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#!/bin/sh /etc/rc.common&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;START&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;90
&lt;span class=&quot;nv&quot;&gt;USE_PROCD&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1

&lt;span class=&quot;nv&quot;&gt;DOMAIN&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;xxx.com&quot;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;#需改为实际网址。同时在dnsmasq配置文件中设置nftset=/xxx.com/114.114.114.114&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;DNS_SERVER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;114.114.114.114&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;BACKUP_DNS_SERVER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;119.29.29.29 223.5.5.5 180.76.76.76&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;LOCAL_IP&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;127.0.0.1&quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#CHINADNS和V2RAY端口范围:5354-5355 5356-5357 5358-5359 5360-5361，须搭配对应的chinadns和v2ray配置文件使用&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;CHINADNS_MIN_PORT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5354&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;CHNROUTE_FILE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/etc/chinadns_chnroute.txt&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;V2RAY_PORT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;1060&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;V2RAY_MAX_DNS_PORT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5361&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;V2RAY_DNS_PORTS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5357 5359 5361&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;V2RAY_BIN&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/usr/bin/v2ray&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;V2RAY_CONF&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/etc/config/v2ray.json&quot;&lt;/span&gt;

set_multi_domestic_dns&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;current_dns_list&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;uci get dhcp.@dnsmasq[0].server 2&amp;gt;/dev/null&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; x&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;DNS_SERVER&lt;/span&gt;:0:15&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; x&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;current_dns_list&lt;/span&gt;:0:15&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
        &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[+] 设置使用国内DNS服务器&quot;&lt;/span&gt;
        uci &lt;span class=&quot;nt&quot;&gt;-q&lt;/span&gt; delete dhcp.@dnsmasq[0].server
        uci add_list dhcp.@dnsmasq[0].server&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;DNS_SERVER&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;dns &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$BACKUP_DNS_SERVER&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do
            &lt;/span&gt;uci add_list dhcp.@dnsmasq[0].server&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;dns&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;done
        &lt;/span&gt;uci &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;dhcp.@dnsmasq[0].noresolv&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0
        uci &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;dhcp.@dnsmasq[0].nohosts&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0
        uci commit dhcp
        &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[+] 重启dnsmasq服务&quot;&lt;/span&gt;
        /etc/init.d/dnsmasq restart 1&amp;gt;/dev/null 2&amp;gt;&amp;amp;1
        &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[✓] 完成&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

set_multi_foreign_dns&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;current_dns_list&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;uci get dhcp.@dnsmasq[0].server 2&amp;gt;/dev/null&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; x&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;LOCAL_IP&lt;/span&gt;:0:9&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; x&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;current_dns_list&lt;/span&gt;:0:9&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
        &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[+] 设置使用ChinaDNS DNS服务器&quot;&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;chinadns_port&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;uci get chinadns.@chinadns[0].port 2&amp;gt;/dev/null&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;chinadns_listen_ipport&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;LOCAL_IP&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;#&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;chinadns_port&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
        uci &lt;span class=&quot;nt&quot;&gt;-q&lt;/span&gt; delete dhcp.@dnsmasq[0].server
        uci add_list dhcp.@dnsmasq[0].server&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;chinadns_listen_ipport&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;port &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$V2RAY_DNS_PORTS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do
            &lt;/span&gt;uci add_list dhcp.@dnsmasq[0].server&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;LOCAL_IP&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;done
        &lt;/span&gt;uci &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;dhcp.@dnsmasq[0].noresolv&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1
        uci &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;dhcp.@dnsmasq[0].nohosts&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1
        uci commit dhcp
        &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[+] 重启dnsmasq服务&quot;&lt;/span&gt;
        /etc/init.d/dnsmasq restart 1&amp;gt;/dev/null 2&amp;gt;&amp;amp;1
        &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[✓] 完成&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

create_bypasslist&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[*] 创建 inet v2ray 表和 bypasslist 集合&quot;&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;# 创建 table（如不存在）&lt;/span&gt;
    nft list table inet v2ray 2&amp;gt;/dev/null &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;/dev/null
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$?&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-ne&lt;/span&gt; 0 &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
        &lt;/span&gt;nft add table inet v2ray
    &lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;# 创建或清空 set：bypasslist&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if &lt;/span&gt;nft list &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;inet v2ray bypasslist 2&amp;gt;/dev/null &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;/dev/null&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
        &lt;/span&gt;nft delete &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;inet v2ray bypasslist
    &lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;# 创建 bypasslist 集合&lt;/span&gt;
    nft add &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;inet v2ray bypasslist &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;type &lt;/span&gt;ipv4_addr&lt;span class=&quot;se&quot;&gt;\;&lt;/span&gt; flags interval&lt;span class=&quot;se&quot;&gt;\;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;# 添加私有地址段&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[+] 添加内网地址段到 bypasslist&quot;&lt;/span&gt;
    nft add element inet v2ray bypasslist &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
        0.0.0.0/8, 10.0.0.0/8, 127.0.0.0/8, &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
        169.254.0.0/16, 172.16.0.0/12, &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
        192.168.0.0/16, 224.0.0.0/4, 240.0.0.0/4 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;# 加载国内 IP（来自文件）&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$CHNROUTE_FILE&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
        &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[+] 加载国内 IP 到 bypasslist（来源: &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$CHNROUTE_FILE&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;）&quot;&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;BATCH_SIZE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1000
        &lt;span class=&quot;nv&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0
        &lt;span class=&quot;nv&quot;&gt;batch&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;

        &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[*] 正在批量导入到 nftables...&quot;&lt;/span&gt;

        &lt;span class=&quot;k&quot;&gt;while &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;read&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-r&lt;/span&gt; line&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-z&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$line&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;continue&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;#\#&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$line&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;continue

            &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;batch&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$batch&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$line&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;,&quot;&lt;/span&gt;
            &lt;span class=&quot;nv&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$((&lt;/span&gt;count &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;))&lt;/span&gt;

            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$count&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-ge&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$BATCH_SIZE&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
                &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;batch&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;batch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;%,&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
                nft add element inet v2ray bypasslist &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$batch&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
                &lt;span class=&quot;nv&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0
                &lt;span class=&quot;nv&quot;&gt;batch&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;fi
        done&lt;/span&gt; &amp;lt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$CHNROUTE_FILE&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;

        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-n&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$batch&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
            &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;batch&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;batch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;%,&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
            nft add element inet v2ray bypasslist &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$batch&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;fi

        &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[✓] 导入完成&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;else
        &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[!] 未找到国内 IP 文件: &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$CHNROUTE_FILE&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;# 加载 VPS 域名解析结果&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[+] 解析 &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$DOMAIN&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; 并加入 bypasslist&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;ip &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;dig +short &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$DOMAIN&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; @&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$DNS_SERVER&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;grep&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Eo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;([0-9]{1,3}\.){3}[0-9]{1,3}&apos;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do
        &lt;/span&gt;nft add element inet v2ray bypasslist &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$ip&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;    加入 &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$ip&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;done
    &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;    bypasslist 已载入 &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;nft list &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;inet v2ray bypasslist | &lt;span class=&quot;nb&quot;&gt;grep&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-oE&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+(/[0-9]+)?&apos;&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;wc&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-l&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; 条目&quot;&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;# 创建 nat 类型链&lt;/span&gt;
    nft list chain inet v2ray prerouting 1&amp;gt;/dev/null 2&amp;gt;&amp;amp;1 &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; nft add chain inet v2ray prerouting &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;type &lt;/span&gt;nat hook prerouting priority dstnat&lt;span class=&quot;se&quot;&gt;\;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    nft list chain inet v2ray output 1&amp;gt;/dev/null 2&amp;gt;&amp;amp;1 &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; nft add chain inet v2ray output &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;type &lt;/span&gt;nat hook output priority &lt;span class=&quot;nt&quot;&gt;-100&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

create_gfwlist&lt;span class=&quot;o&quot;&gt;(){&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[*] 创建 inet v2ray 表和 gfwlist 集合&quot;&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;# 创建 table（如不存在）&lt;/span&gt;
    nft list table inet v2ray 2&amp;gt;/dev/null &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;/dev/null
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$?&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-ne&lt;/span&gt; 0 &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
        &lt;/span&gt;nft add table inet v2ray
    &lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;# 创建或清空 set：gfwlist&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if &lt;/span&gt;nft list &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;inet v2ray gfwlist 2&amp;gt;/dev/null &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;/dev/null&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
        &lt;/span&gt;nft delete &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;inet v2ray gfwlist
    &lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;# 创建 gfwlist 集合&lt;/span&gt;
    nft add &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;inet v2ray gfwlist &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;type &lt;/span&gt;ipv4_addr&lt;span class=&quot;se&quot;&gt;\;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;# 注意dnsmasq配置文件中也有gfwlist的内容，所以需要重新加载,此操作不会直接增加gfwlist条目数，只会在解析网址时动态增加&lt;/span&gt;
    /etc/init.d/dnsmasq reload 1&amp;gt;/dev/null 2&amp;gt;&amp;amp;1
    &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;    gfwlist 已载入 &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;nft list &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;inet v2ray gfwlist | &lt;span class=&quot;nb&quot;&gt;grep&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-oE&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+(/[0-9]+)?&apos;&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;wc&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-l&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; 条目&quot;&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;# 创建 nat 类型链&lt;/span&gt;
    nft list chain inet v2ray prerouting 1&amp;gt;/dev/null 2&amp;gt;&amp;amp;1 &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; nft add chain inet v2ray prerouting &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;type &lt;/span&gt;nat hook prerouting priority dstnat&lt;span class=&quot;se&quot;&gt;\;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    nft list chain inet v2ray output 1&amp;gt;/dev/null 2&amp;gt;&amp;amp;1 &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; nft add chain inet v2ray output &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;type &lt;/span&gt;nat hook output priority &lt;span class=&quot;nt&quot;&gt;-100&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

enable_bypasslist_firewall_rules&lt;span class=&quot;o&quot;&gt;(){&lt;/span&gt;
    nft add rule inet v2ray prerouting ip daddr &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; @bypasslist tcp dport 0-65535 counter redirect to :&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; 2&amp;gt;/dev/null
    nft add rule inet v2ray output ip daddr &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; @bypasslist tcp dport 0-65535 counter redirect to :&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; 2&amp;gt;/dev/null
    nft add rule inet v2ray prerouting ip daddr &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;LOCAL_IP&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; udp dport &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;CHINADNS_MIN_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;-&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_MAX_DNS_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return &lt;/span&gt;2&amp;gt;/dev/null
    nft add rule inet v2ray output ip daddr &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;LOCAL_IP&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; udp dport &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;CHINADNS_MIN_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;-&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_MAX_DNS_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return &lt;/span&gt;2&amp;gt;/dev/null
    nft add rule inet v2ray prerouting ip daddr &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; @bypasslist udp dport 0-65535 counter redirect to :&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; 2&amp;gt;/dev/null
    nft add rule inet v2ray output ip daddr &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; @bypasslist udp dport 0-65535 counter redirect to :&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; 2&amp;gt;/dev/null
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

disable_bypasslist_firewall_rules&lt;span class=&quot;o&quot;&gt;(){&lt;/span&gt;
    nft delete rule inet v2ray prerouting ip daddr &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; @bypasslist tcp dport 0-65535 counter redirect to :&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; 2&amp;gt;/dev/null
    nft delete rule inet v2ray output ip daddr &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; @bypasslist tcp dport 0-65535 counter redirect to :&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; 2&amp;gt;/dev/null
    nft delete rule inet v2ray prerouting ip daddr &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;LOCAL_IP&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; udp dport &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;CHINADNS_MIN_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;-&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_MAX_DNS_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return &lt;/span&gt;2&amp;gt;/dev/null
    nft delete rule inet v2ray output ip daddr &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;LOCAL_IP&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; udp dport &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;CHINADNS_MIN_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;-&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_MAX_DNS_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return &lt;/span&gt;2&amp;gt;/dev/null
    nft delete rule inet v2ray prerouting ip daddr &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; @bypasslist udp dport 0-65535 counter redirect to :&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; 2&amp;gt;/dev/null
    nft delete rule inet v2ray output ip daddr &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; @bypasslist udp dport 0-65535 counter redirect to :&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; 2&amp;gt;/dev/null
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

enable_gfwlist_firewall_rules&lt;span class=&quot;o&quot;&gt;(){&lt;/span&gt;
    nft add rule inet v2ray prerouting ip daddr @gfwlist tcp dport 0-65535 counter redirect to :&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; 2&amp;gt;/dev/null
    nft add rule inet v2ray output ip daddr @gfwlist tcp dport 0-65535 counter redirect to :&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; 2&amp;gt;/dev/null
    nft add rule inet v2ray prerouting ip daddr &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;LOCAL_IP&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; udp dport &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;CHINADNS_MIN_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;-&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_MAX_DNS_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return &lt;/span&gt;2&amp;gt;/dev/null
    nft add rule inet v2ray output ip daddr &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;LOCAL_IP&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; udp dport &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;CHINADNS_MIN_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;-&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_MAX_DNS_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return &lt;/span&gt;2&amp;gt;/dev/null
    nft add rule inet v2ray prerouting ip daddr @gfwlist udp dport 0-65535 counter redirect to :&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; 2&amp;gt;/dev/null
    nft add rule inet v2ray output ip daddr @gfwlist udp dport 0-65535 counter redirect to :&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; 2&amp;gt;/dev/null
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

disable_gfwlist_firewall_rules&lt;span class=&quot;o&quot;&gt;(){&lt;/span&gt;
    nft delete rule inet v2ray prerouting ip daddr @gfwlist tcp dport 0-65535 counter redirect to :&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; 2&amp;gt;/dev/null
    nft delete rule inet v2ray output ip daddr @gfwlist tcp dport 0-65535 counter redirect to :&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; 2&amp;gt;/dev/null
    nft delete rule inet v2ray prerouting ip daddr &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;LOCAL_IP&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; udp dport &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;CHINADNS_MIN_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;-&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_MAX_DNS_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return &lt;/span&gt;2&amp;gt;/dev/null
    nft delete rule inet v2ray output ip daddr &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;LOCAL_IP&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; udp dport &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;CHINADNS_MIN_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;-&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_MAX_DNS_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return &lt;/span&gt;2&amp;gt;/dev/null
    nft delete rule inet v2ray prerouting ip daddr @gfwlist udp dport 0-65535 counter redirect to :&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; 2&amp;gt;/dev/null
    nft delete rule inet v2ray output ip daddr @gfwlist udp dport 0-65535 counter redirect to :&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;V2RAY_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; 2&amp;gt;/dev/null
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

disable_v2ray_rules&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if &lt;/span&gt;nft list table inet v2ray 2&amp;gt;/dev/null &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;/dev/null&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
        &lt;/span&gt;nft flush table inet v2ray
    &lt;span class=&quot;k&quot;&gt;else
        &lt;/span&gt;nft add table inet v2ray
    &lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;
    
    &lt;span class=&quot;c&quot;&gt;# 创建或清空 set：gfwlist&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if &lt;/span&gt;nft list &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;inet v2ray gfwlist 2&amp;gt;/dev/null &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;/dev/null&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
        &lt;/span&gt;nft delete &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;inet v2ray gfwlist
    &lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;# 创建 gfwlist 集合&lt;/span&gt;
    nft add &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;inet v2ray gfwlist &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;type &lt;/span&gt;ipv4_addr&lt;span class=&quot;se&quot;&gt;\;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    set_multi_domestic_dns
    &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;ingfw&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /tmp/v2raymode.txt
    
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

stop_service&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[+] 停止 v2ray 服务&quot;&lt;/span&gt;
    disable_v2ray_rules
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

enable_v2ray_rules&lt;span class=&quot;o&quot;&gt;(){&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;running_v2ray_mode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /tmp/v2raymode.txt 2&amp;gt;/dev/null | &lt;span class=&quot;nb&quot;&gt;tr&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;\r&apos;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;v2ray_mode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;uci get advancedconfig.@rules[0].v2raymode 2&amp;gt;/dev/null&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; x&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;v2ray_mode&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; x&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;running_v2ray_mode&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
        &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[+] v2ray模式未变化&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;else
        &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[+] v2ray模式已变化&quot;&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[+] 设置&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;v2ray_mode&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;模式中&quot;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;v2ray_mode&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;outlands&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
            &lt;/span&gt;disable_gfwlist_firewall_rules
            create_bypasslist
            enable_bypasslist_firewall_rules
            set_multi_foreign_dns
        
        &lt;span class=&quot;k&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;v2ray_mode&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;gfwlist&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
            &lt;/span&gt;disable_bypasslist_firewall_rules
            create_gfwlist
            enable_gfwlist_firewall_rules
            set_multi_foreign_dns
        
        &lt;span class=&quot;k&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;v2ray_mode&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;ingfw&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
            &lt;/span&gt;disable_v2ray_rules
        &lt;span class=&quot;k&quot;&gt;fi
        &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;v2ray_mode&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /tmp/v2raymode.txt
    &lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

start_service&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[+] 启动 v2ray 服务&quot;&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;mkdir&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; /var/log/v2ray
    &lt;span class=&quot;nb&quot;&gt;ulimit&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-n&lt;/span&gt; 65535
    procd_open_instance
    procd_set_param &lt;span class=&quot;nb&quot;&gt;command&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$V2RAY_BIN&lt;/span&gt; run &lt;span class=&quot;nt&quot;&gt;-config&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$V2RAY_CONF&lt;/span&gt;
    procd_set_param file &lt;span class=&quot;nv&quot;&gt;$V2RAY_CONF&lt;/span&gt;
    procd_set_param respawn
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_set_param pidfile /var/run/v2ray.pid
    enable_v2ray_rules
    procd_close_instance
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

service_triggers&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    procd_add_reload_trigger &lt;span class=&quot;s2&quot;&gt;&quot;advancedconfig&quot;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
      

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2)修改/etc/dnsmasq.d/下的conf文件：&lt;/p&gt;

&lt;p&gt;将原来的所有&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;nv&quot;&gt;ipset&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/xxxx.com/gfwlist

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;全部修改为：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;nv&quot;&gt;nftset&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/xxxx.com/4#inet#v2ray#gfwlist

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;需要注意的是，conf文件不能有windows换行符，因为nftset对于格式非常敏感，之前windows换行符对于ipset没有问题，但是对于nftset就无法正常执行。&lt;/p&gt;

&lt;p&gt;3）对应的/etc/config/chinadns文件：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
config chinadns
	option chnroute &lt;span class=&quot;s1&quot;&gt;&apos;/etc/chinadns_chnroute.txt&apos;&lt;/span&gt;
	option addr &lt;span class=&quot;s1&quot;&gt;&apos;0.0.0.0&apos;&lt;/span&gt;
	option &lt;span class=&quot;nb&quot;&gt;enable&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;1&apos;&lt;/span&gt;
	option port &lt;span class=&quot;s1&quot;&gt;&apos;5355&apos;&lt;/span&gt;
	option bidirectional &lt;span class=&quot;s1&quot;&gt;&apos;0&apos;&lt;/span&gt;
	option server &lt;span class=&quot;s1&quot;&gt;&apos;114.114.114.114,127.0.0.1:5354&apos;&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;4）对应的/root/start_multi_chinadns.sh文件：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;c&quot;&gt;#!/bin/sh&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# 启动多个 chinadns 实例并使用不同的国内 DNS 和端口&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# 依赖：chinadns、v2ray、dnsmasq-full、coreutils-nohup&lt;/span&gt;

killall chinadns 2&amp;gt;/dev/null
/etc/init.d/chinadns restart
&lt;span class=&quot;nb&quot;&gt;sleep &lt;/span&gt;1

start_chinadns&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;nb&quot;&gt;local &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$1&lt;/span&gt;
  &lt;span class=&quot;nb&quot;&gt;local &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;dns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$2&lt;/span&gt;
  &lt;span class=&quot;nb&quot;&gt;local &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;v2port&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$3&lt;/span&gt;
  &lt;span class=&quot;nb&quot;&gt;nohup&lt;/span&gt; /usr/bin/chinadns &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-b&lt;/span&gt; 0.0.0.0 &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$port&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$dns&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;,127.0.0.1:&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$v2port&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; /etc/chinadns_chnroute.txt &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;/dev/null 2&amp;gt;&amp;amp;1 &amp;amp;
  &lt;span class=&quot;nb&quot;&gt;sleep &lt;/span&gt;1
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

start_chinadns 5357 119.29.29.29 5356
start_chinadns 5359 223.5.5.5    5358
start_chinadns 5361 180.76.76.76 5360

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;5）对应的/etc/config/v2ray配置：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;inbounds&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;    
      &lt;span class=&quot;s2&quot;&gt;&quot;protocol&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;dokodemo-door&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: 1060,
      &lt;span class=&quot;s2&quot;&gt;&quot;listen&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;0.0.0.0&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;sniffing&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;enabled&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;destOverride&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;http&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;tls&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
       &lt;span class=&quot;s2&quot;&gt;&quot;settings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
         &lt;span class=&quot;s2&quot;&gt;&quot;network&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;tcp,udp&quot;&lt;/span&gt;,
         &lt;span class=&quot;s2&quot;&gt;&quot;followRedirect&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt; 
       &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;protocol&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;dokodemo-door&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;listen&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;0.0.0.0&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: 5354,
      &lt;span class=&quot;s2&quot;&gt;&quot;settings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;address&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;8.8.8.8&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: 53,
        &lt;span class=&quot;s2&quot;&gt;&quot;network&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;udp&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;timeout&quot;&lt;/span&gt;: 0,
        &lt;span class=&quot;s2&quot;&gt;&quot;followRedirect&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;protocol&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;dokodemo-door&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;listen&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;0.0.0.0&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: 5356,
      &lt;span class=&quot;s2&quot;&gt;&quot;settings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;address&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;8.8.8.8&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: 53,
        &lt;span class=&quot;s2&quot;&gt;&quot;network&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;udp&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;timeout&quot;&lt;/span&gt;: 0,
        &lt;span class=&quot;s2&quot;&gt;&quot;followRedirect&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;protocol&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;dokodemo-door&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;listen&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;0.0.0.0&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: 5358,
      &lt;span class=&quot;s2&quot;&gt;&quot;settings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;address&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;1.1.1.1&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: 53,
        &lt;span class=&quot;s2&quot;&gt;&quot;network&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;udp&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;timeout&quot;&lt;/span&gt;: 0,
        &lt;span class=&quot;s2&quot;&gt;&quot;followRedirect&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;protocol&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;dokodemo-door&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;listen&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;0.0.0.0&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: 5360,
      &lt;span class=&quot;s2&quot;&gt;&quot;settings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;address&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;8.8.4.4&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: 53,
        &lt;span class=&quot;s2&quot;&gt;&quot;network&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;udp&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;timeout&quot;&lt;/span&gt;: 0,
        &lt;span class=&quot;s2&quot;&gt;&quot;followRedirect&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;outbounds&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;protocol&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;vless&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;tag&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;proxy&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;settings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;vnext&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
          &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;s2&quot;&gt;&quot;address&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;xxx.com&quot;&lt;/span&gt;, &lt;span class=&quot;c&quot;&gt;#需改为实际网址&lt;/span&gt;
            &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: 443,
            &lt;span class=&quot;s2&quot;&gt;&quot;users&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
              &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;s2&quot;&gt;&quot;id&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;UUID&quot;&lt;/span&gt;, &lt;span class=&quot;c&quot;&gt;#需改为实际UUID&lt;/span&gt;
                &lt;span class=&quot;s2&quot;&gt;&quot;encryption&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;none&quot;&lt;/span&gt;
              &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
          &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;streamSettings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;network&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;ws&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;security&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;tls&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;wsSettings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;s2&quot;&gt;&quot;path&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;/path&quot;&lt;/span&gt;  &lt;span class=&quot;c&quot;&gt;#需改为实际路径&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;tcpSettings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;s2&quot;&gt;&quot;allowInsecureCiphers&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;


&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;参考：
1.chatgpt
2.https://www.abcde.im/archives/112.html&lt;/p&gt;
</content>
 </entry>
 
 <entry>
   <title>openwrt路由部署wireguard实现两地组网</title>
   <link href="https://jibenfa.github.io/openwrt/2024/12/19/openwrtE8B7AFE794B1E9A3A8E7BDB2wireguardE5AE9EE78EE7B8AEE4B8A4E59C84E7BB84E7BD91/"/>
   <updated>2024-12-19T06:12:12+00:00</updated>
   <id>https://jibenfa.github.io/openwrt/2024/12/19/openwrtE8B7AFE794B1E9A3A8E7BDB2wireguardE5AE9EE78EE7B8AEE4B8A4E59C84E7BB84E7BD91</id>
   <content type="html">&lt;p&gt;很久没升级路由了，最近openwrt和openvpn又更新版本了，导致之前的openwrt路由下opevpn互联配置出了些问题，连同Windows下tap模式访问局域网也失效了，配了半天都未成功，只能使用tun模式。&lt;/p&gt;

&lt;p&gt;然后研究了一下wireguard，发现配置比openvpn简单太多了。于是决定用wireguard。&lt;/p&gt;

&lt;p&gt;配置方法记录一下备忘：&lt;/p&gt;

&lt;p&gt;两个路由：&lt;/p&gt;

&lt;p&gt;路由A：具有外网ip和动态域名，内网网段172.24.1.0/24&lt;/p&gt;

&lt;p&gt;路由B：无外网ip，内网网段172.24.8.0/24&lt;/p&gt;

&lt;p&gt;1.两台路由均执行以下操作：&lt;/p&gt;

&lt;p&gt;1）安装wireguard，这里使用的是openwrt 23.05.5版本&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
opkg update
opkg &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;luci-app-wireguard kmod-wireguard wireguard-tools

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2）生成公私钥对&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
wg genkey | &lt;span class=&quot;nb&quot;&gt;tee &lt;/span&gt;privatekey | wg pubkey &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; publickey

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3）调整防火墙（/etc/config/firewall），在末尾增加：&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
config zone
        option name &lt;span class=&quot;s1&quot;&gt;&apos;wg&apos;&lt;/span&gt;
        option input &lt;span class=&quot;s1&quot;&gt;&apos;ACCEPT&apos;&lt;/span&gt;
        option forward &lt;span class=&quot;s1&quot;&gt;&apos;ACCEPT&apos;&lt;/span&gt;
        option output &lt;span class=&quot;s1&quot;&gt;&apos;ACCEPT&apos;&lt;/span&gt;
        option masq &lt;span class=&quot;s1&quot;&gt;&apos;1&apos;&lt;/span&gt;
        option mtu_fix &lt;span class=&quot;s1&quot;&gt;&apos;1&apos;&lt;/span&gt;
        list network &lt;span class=&quot;s1&quot;&gt;&apos;wg0&apos;&lt;/span&gt;

config forwarding
        option src &lt;span class=&quot;s1&quot;&gt;&apos;wg&apos;&lt;/span&gt;
        option dest &lt;span class=&quot;s1&quot;&gt;&apos;lan&apos;&lt;/span&gt;

config forwarding
        option src &lt;span class=&quot;s1&quot;&gt;&apos;lan&apos;&lt;/span&gt;
        option dest &lt;span class=&quot;s1&quot;&gt;&apos;wg&apos;&lt;/span&gt;

config forwarding
        option src &lt;span class=&quot;s1&quot;&gt;&apos;wg&apos;&lt;/span&gt;
        option dest &lt;span class=&quot;s1&quot;&gt;&apos;lan&apos;&lt;/span&gt;

config rule
        option name &lt;span class=&quot;s1&quot;&gt;&apos;wireguard&apos;&lt;/span&gt;
        option src &lt;span class=&quot;s1&quot;&gt;&apos;wan&apos;&lt;/span&gt;
        option dest &lt;span class=&quot;s1&quot;&gt;&apos;*&apos;&lt;/span&gt;
        option dest_port &lt;span class=&quot;s1&quot;&gt;&apos;51820&apos;&lt;/span&gt;
        option target &lt;span class=&quot;s1&quot;&gt;&apos;ACCEPT&apos;&lt;/span&gt;


&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2.在路由A上设置网络接口（/etc/config/network），在最后增加：&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
config interface &lt;span class=&quot;s1&quot;&gt;&apos;wg0&apos;&lt;/span&gt;
        option proto &lt;span class=&quot;s1&quot;&gt;&apos;wireguard&apos;&lt;/span&gt;
        option private_key &lt;span class=&quot;s1&quot;&gt;&apos;路由A私钥&apos;&lt;/span&gt;
        list addresses &lt;span class=&quot;s1&quot;&gt;&apos;10.168.10.1/24&apos;&lt;/span&gt;
        option listen_port &lt;span class=&quot;s1&quot;&gt;&apos;51820&apos;&lt;/span&gt;

config wireguard_wg0
        option description &lt;span class=&quot;s1&quot;&gt;&apos;router&apos;&lt;/span&gt;
        option public_key &lt;span class=&quot;s1&quot;&gt;&apos;路由B公钥&apos;&lt;/span&gt;
        option persistent_keepalive &lt;span class=&quot;s1&quot;&gt;&apos;25&apos;&lt;/span&gt;
        list allowed_ips &lt;span class=&quot;s1&quot;&gt;&apos;10.168.10.3/32&apos;&lt;/span&gt;
        list allowed_ips &lt;span class=&quot;s1&quot;&gt;&apos;172.24.8.0/24&apos;&lt;/span&gt;

config route
        option interface &lt;span class=&quot;s1&quot;&gt;&apos;wg0&apos;&lt;/span&gt;
        option target &lt;span class=&quot;s1&quot;&gt;&apos;172.24.8.0/24&apos;&lt;/span&gt;
        option gateway &lt;span class=&quot;s1&quot;&gt;&apos;10.168.10.1&apos;&lt;/span&gt;
        option metric &lt;span class=&quot;s1&quot;&gt;&apos;1&apos;&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3.在路由B上设置网络接口（/etc/config/network），在最后增加：&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
config interface &lt;span class=&quot;s1&quot;&gt;&apos;wg0&apos;&lt;/span&gt;
        option proto &lt;span class=&quot;s1&quot;&gt;&apos;wireguard&apos;&lt;/span&gt;
        option private_key &lt;span class=&quot;s1&quot;&gt;&apos;路由B私钥&apos;&lt;/span&gt;
        list addresses &lt;span class=&quot;s1&quot;&gt;&apos;10.168.10.3/24&apos;&lt;/span&gt;
        option listen_port &lt;span class=&quot;s1&quot;&gt;&apos;51820&apos;&lt;/span&gt;

config wireguard_wg0
        option description &lt;span class=&quot;s1&quot;&gt;&apos;router_client1&apos;&lt;/span&gt;
        option public_key &lt;span class=&quot;s1&quot;&gt;&apos;路由A公钥&apos;&lt;/span&gt;
        option endpoint_host &lt;span class=&quot;s1&quot;&gt;&apos;路由A的ddns域名&apos;&lt;/span&gt;
        option endpoint_port &lt;span class=&quot;s1&quot;&gt;&apos;51820&apos;&lt;/span&gt;
        option persistent_keepalive &lt;span class=&quot;s1&quot;&gt;&apos;25&apos;&lt;/span&gt;
        list allowed_ips &lt;span class=&quot;s1&quot;&gt;&apos;10.168.10.1/32&apos;&lt;/span&gt;
        list allowed_ips &lt;span class=&quot;s1&quot;&gt;&apos;172.24.1.0/24&apos;&lt;/span&gt;

config route
        option interface &lt;span class=&quot;s1&quot;&gt;&apos;wg0&apos;&lt;/span&gt;
        option target &lt;span class=&quot;s1&quot;&gt;&apos;172.24.1.0/24&apos;&lt;/span&gt;
        option gateway &lt;span class=&quot;s1&quot;&gt;&apos;10.168.10.3&apos;&lt;/span&gt;
        option metric &lt;span class=&quot;s1&quot;&gt;&apos;1&apos;&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;4.最后重启路由A和路由B，两个路由间的局域网就可以互相访问了&lt;/p&gt;

&lt;p&gt;参考：&lt;/p&gt;

&lt;p&gt;1.https://www.knightli.com/2022/04/14/openwrt-wireguard-connect-two-network/&lt;/p&gt;

&lt;p&gt;2.chatgpt&lt;/p&gt;
</content>
 </entry>
 
 <entry>
   <title>openwrt下解决dnsmasq cannot access directory 的问题</title>
   <link href="https://jibenfa.github.io/openwrt/2024/12/18/openwrtE4B88BE8A7A3E586B3dnsmasq20cannot20access20directory20E79A84E997AEE9A298/"/>
   <updated>2024-12-18T09:39:31+00:00</updated>
   <id>https://jibenfa.github.io/openwrt/2024/12/18/openwrtE4B88BE8A7A3E586B3dnsmasq20cannot20access20directory20E79A84E997AEE9A298</id>
   <content type="html">&lt;p&gt;最近更新了openwrt版本，结果设置dnsmasq-full的时候发现无法启动dnsmasq，查日志发现有个报错：&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
daemon.crit dnsmasq[1]: cannot access directory /etc/dnsmasq.d: No such file or directory

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;明明已经设置该文件夹为777权限了，还是有这个问题，后来查阅资料发现openwrt 22.03.0版本后，限制了dnsmasq的文件夹访问权限。&lt;/p&gt;

&lt;p&gt;处理方式是：&lt;/p&gt;

&lt;p&gt;1.将/etc/dnsmasq.conf下的配置注释掉或者删掉：&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;c&quot;&gt;#conf-dir=/etc/dnsmasq.d&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;2.在/etc/config/dhcp的配置文件中的dnsmasq配置中增加一条：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
config dnsmasq
	...
 	option confdir &lt;span class=&quot;s1&quot;&gt;&apos;/etc/dnsmasq.d&apos;&lt;/span&gt;
	...

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;3.重启dnsmasq服务即可。&lt;/p&gt;

&lt;p&gt;参考：&lt;/p&gt;

&lt;p&gt;1.https://github.com/openwrt/openwrt/issues/10625&lt;/p&gt;
</content>
 </entry>
 
 <entry>
   <title>openwrt下新版openvpn设置</title>
   <link href="https://jibenfa.github.io/openwrt/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/2021/05/07/openwrtE4B88BE696B0E78988openvpnE8AEBEE7BDAE/"/>
   <updated>2021-05-07T22:39:31+00:00</updated>
   <id>https://jibenfa.github.io/openwrt/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/2021/05/07/openwrtE4B88BE696B0E78988openvpnE8AEBEE7BDAE</id>
   <content type="html">&lt;p&gt;最近更新了openvpn版本，一些命令和设置跟以前不一样了。现记录一下：&lt;/p&gt;

&lt;p&gt;1.生成证书&lt;/p&gt;

&lt;p&gt;1）编辑/etc/easy-rsa/vars，修改部分内容&lt;/p&gt;

&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# Choose &lt;span class=&quot;k&quot;&gt;a&lt;/span&gt; size &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; bits &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; your keypairs&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt; The recommended value &lt;span class=&quot;k&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2048&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;  Using
# &lt;span class=&quot;m&quot;&gt;2048&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;bit &lt;span class=&quot;nb&quot;&gt;keys&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;is&lt;/span&gt; considered &lt;span class=&quot;nb&quot;&gt;more&lt;/span&gt; than sufficient &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; many years into the
# future&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt; Larger keysizes will slow down TLS negotiation &lt;span class=&quot;nb&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;make&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;key&lt;/span&gt;/DH param
# generation take much longer&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt; Values &lt;span class=&quot;k&quot;&gt;up&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;4096&lt;/span&gt; should be accepted by most
# software&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt; Only used when the crypto alg &lt;span class=&quot;k&quot;&gt;is&lt;/span&gt; rsa &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;see below&lt;span class=&quot;p&quot;&gt;.)&lt;/span&gt;

set_var EASYRSA_KEY_SIZE	&lt;span class=&quot;m&quot;&gt;4096&lt;/span&gt;

# In how many days should the root CA &lt;span class=&quot;nb&quot;&gt;key&lt;/span&gt; expire?

set_var EASYRSA_CA_EXPIRE	&lt;span class=&quot;m&quot;&gt;3650&lt;/span&gt;

# In how many days should certificates expire?

set_var EASYRSA_CERT_EXPIRE	&lt;span class=&quot;m&quot;&gt;3650&lt;/span&gt;

# These are the default &lt;span class=&quot;nb&quot;&gt;values&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; fields
# which will be placed &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; the certificate&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;
# Don&apos;&lt;span class=&quot;k&quot;&gt;t&lt;/span&gt; leave any of these fields blank&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;export&lt;/span&gt; KEY_COUNTRY&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;xx&quot;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;export&lt;/span&gt; KEY_PROVINCE&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;xx&quot;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;export&lt;/span&gt; KEY_CITY&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;xxxx&quot;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;export&lt;/span&gt; KEY_ORG&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;XXxxxx&quot;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;export&lt;/span&gt; KEY_EMAIL&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;xxxxxx@gmail.com&quot;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;export&lt;/span&gt; KEY_OU&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;XXxxxxxx&quot;&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2）接着生成证书和diffie-hellman key：&lt;br /&gt;
手工清空/etc/easy-rsa/下的key目录或者运行：&lt;/p&gt;
&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
easyrsa clean&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;all&lt;/span&gt;  
easyrsa init&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;pki

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;生成ca证书&lt;/p&gt;
&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
easyrsa build&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;ca&lt;/span&gt; nopass 

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;生成dh密钥&lt;/p&gt;
&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
easyrsa gen&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;dh  

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;服务器证书&lt;/p&gt;
&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
easyrsa build&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;server&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;full server nopass

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;客户端证书给coffeecat&lt;/p&gt;
&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
easyrsa build&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;client&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;full coffeecat nopass

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;生成ta.key&lt;/p&gt;
&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
openvpn &lt;span class=&quot;p&quot;&gt;--&lt;/span&gt;genkey &lt;span class=&quot;p&quot;&gt;--&lt;/span&gt;secret &lt;span class=&quot;k&quot;&gt;ta&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;key&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3）拷贝到服务器目录下：&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; /etc/easy-rsa/keys/
&lt;span class=&quot;nb&quot;&gt;cp &lt;/span&gt;ca.crt ca.key dh4096.pem server.key server.crt ta.key /etc/openvpn/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;4）将以下文件拷贝到客户端或者将文件的内容贴在客户端配置文件中（移动设备）：&lt;br /&gt;
ca.crt dh4096.pem coffeecat.key coffeecat.crt ta.key&lt;/p&gt;

&lt;p&gt;5）然后就是最关键的配置openvpn服务器端和客户端了：&lt;br /&gt;
路由器服务器端：&lt;br /&gt;
编辑/etc/config/openvpn :&lt;/p&gt;

&lt;p&gt;&lt;em&gt;注意：172.24.1.1为路由器的lan ip，10.1.1.0/24是为vpn客户端分配的ip段，一定要和路由器为lan dhcp的ip段错开。&lt;/em&gt;&lt;/p&gt;

&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;

config openvpn &lt;span class=&quot;s1&quot;&gt;&apos;tun_cert&apos;&lt;/span&gt;
	option port &lt;span class=&quot;s1&quot;&gt;&apos;3366&apos;&lt;/span&gt;
	option proto &lt;span class=&quot;s1&quot;&gt;&apos;tcp4&apos;&lt;/span&gt;
	option dev &lt;span class=&quot;s1&quot;&gt;&apos;tun0&apos;&lt;/span&gt;
	option &lt;span class=&quot;k&quot;&gt;ca&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;/etc/openvpn/ca.crt&apos;&lt;/span&gt;
	option cert &lt;span class=&quot;s1&quot;&gt;&apos;/etc/openvpn/server.crt&apos;&lt;/span&gt;
	option &lt;span class=&quot;nb&quot;&gt;key&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;/etc/openvpn/server.key&apos;&lt;/span&gt;
	option dh &lt;span class=&quot;s1&quot;&gt;&apos;/etc/openvpn/dh4096.pem&apos;&lt;/span&gt;
  	option tls_auth &lt;span class=&quot;s1&quot;&gt;&apos;/etc/openvpn/ta.key 0&apos;&lt;/span&gt;
	option server &lt;span class=&quot;s1&quot;&gt;&apos;10.1.1.0 255.255.255.0&apos;&lt;/span&gt;
	option client_config_dir &lt;span class=&quot;s1&quot;&gt;&apos;/etc/openvpn/tunstatic&apos;&lt;/span&gt;
	option ccd_exclusive &lt;span class=&quot;s1&quot;&gt;&apos;1&apos;&lt;/span&gt;
	option cipher &lt;span class=&quot;s1&quot;&gt;&apos;AES-256-CBC&apos;&lt;/span&gt;
	option ifconfig_pool_persist &lt;span class=&quot;s1&quot;&gt;&apos;/tmp/ipp2.txt&apos;&lt;/span&gt;
	option duplicate_cn &lt;span class=&quot;s1&quot;&gt;&apos;1&apos;&lt;/span&gt;
	option client_to_client &lt;span class=&quot;s1&quot;&gt;&apos;1&apos;&lt;/span&gt;
	option keepalive &lt;span class=&quot;s1&quot;&gt;&apos;10 120&apos;&lt;/span&gt;
	option compress &lt;span class=&quot;s1&quot;&gt;&apos;lzo&apos;&lt;/span&gt;
	option persist_key &lt;span class=&quot;s1&quot;&gt;&apos;1&apos;&lt;/span&gt;
	option persist_tun &lt;span class=&quot;s1&quot;&gt;&apos;1&apos;&lt;/span&gt;
	option status &lt;span class=&quot;s1&quot;&gt;&apos;/tmp/openvpn-status2.log&apos;&lt;/span&gt;
	option &lt;span class=&quot;k&quot;&gt;verb&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;3&apos;&lt;/span&gt;
	option topology &lt;span class=&quot;s1&quot;&gt;&apos;subnet&apos;&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;list&lt;/span&gt; push &lt;span class=&quot;s1&quot;&gt;&apos;dhcp-option DNS 172.24.1.1&apos;&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;list&lt;/span&gt; push &lt;span class=&quot;s1&quot;&gt;&apos;redirect-gateway def1 local&apos;&lt;/span&gt;
	option enabled &lt;span class=&quot;s1&quot;&gt;&apos;1&apos;&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;在/etc/openvpn/tunstatic文件夹下创建名为coffeecat的文件，内容为：&lt;/p&gt;

&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
ifconfig&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;push &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;7&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;255&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;255&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;255&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;然后在luci或者命令行启动openvpn：&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;/etc/init.d/openvpn restart
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ps一下有进程就对了&lt;/p&gt;

&lt;p&gt;openvpn客户端配置client.ovpn,此处设置为单文件模式：&lt;/p&gt;
&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
client
dev tun
proto tcp4
connect&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;retry&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;max&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;
connect&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;retry &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;


remote 你的服务器地址 &lt;span class=&quot;m&quot;&gt;3366&lt;/span&gt;
resolv&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;retry infinite
nobind
float
persist&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;key&lt;/span&gt;
persist&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;tun
remote&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;cert&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;tls server
&lt;span class=&quot;k&quot;&gt;comp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;lzo
&lt;span class=&quot;k&quot;&gt;verb&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;
cipher		AES&lt;span class=&quot;m&quot;&gt;-256&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;CBC
tun&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;mtu		&lt;span class=&quot;m&quot;&gt;1500&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;direction &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;

&lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;tls&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;auth&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;
#
# &lt;span class=&quot;m&quot;&gt;2048&lt;/span&gt; bit OpenVPN static &lt;span class=&quot;nb&quot;&gt;key&lt;/span&gt;
#
&lt;span class=&quot;p&quot;&gt;-----&lt;/span&gt;BEGIN OpenVPN Static &lt;span class=&quot;nb&quot;&gt;key&lt;/span&gt; V1&lt;span class=&quot;p&quot;&gt;-----&lt;/span&gt;
此处省略。。。。。
&lt;span class=&quot;p&quot;&gt;-----&lt;/span&gt;END OpenVPN Static &lt;span class=&quot;nb&quot;&gt;key&lt;/span&gt; V1&lt;span class=&quot;p&quot;&gt;-----&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;/tls&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;auth&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;

&lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;ca&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;-----&lt;/span&gt;BEGIN CERTIFICATE&lt;span class=&quot;p&quot;&gt;-----&lt;/span&gt;
此处省略。。。。。
&lt;span class=&quot;p&quot;&gt;-----&lt;/span&gt;END CERTIFICATE&lt;span class=&quot;p&quot;&gt;-----&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;/&lt;span class=&quot;k&quot;&gt;ca&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;

&lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;cert&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;-----&lt;/span&gt;BEGIN CERTIFICATE&lt;span class=&quot;p&quot;&gt;-----&lt;/span&gt;
此处省略。。。。。
&lt;span class=&quot;p&quot;&gt;-----&lt;/span&gt;END CERTIFICATE&lt;span class=&quot;p&quot;&gt;-----&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;/cert&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;

&lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;-----&lt;/span&gt;BEGIN PRIVATE KEY&lt;span class=&quot;p&quot;&gt;-----&lt;/span&gt;
此处省略。。。。。
&lt;span class=&quot;p&quot;&gt;-----&lt;/span&gt;END PRIVATE KEY&lt;span class=&quot;p&quot;&gt;-----&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;/&lt;span class=&quot;nb&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;


&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;特别要注意的是，server配置文件中的：&lt;/p&gt;
&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
option tls_auth &lt;span class=&quot;s1&quot;&gt;&apos;/etc/openvpn/ta.key 0&apos;&lt;/span&gt;


&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;要和client配置文件中的：&lt;/p&gt;
&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;nb&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;direction &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;tls&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;auth&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;
#
# &lt;span class=&quot;m&quot;&gt;2048&lt;/span&gt; bit OpenVPN static &lt;span class=&quot;nb&quot;&gt;key&lt;/span&gt;
#
&lt;span class=&quot;p&quot;&gt;-----&lt;/span&gt;BEGIN OpenVPN Static &lt;span class=&quot;nb&quot;&gt;key&lt;/span&gt; V1&lt;span class=&quot;p&quot;&gt;-----&lt;/span&gt;
此处省略。。。。。
&lt;span class=&quot;p&quot;&gt;-----&lt;/span&gt;END OpenVPN Static &lt;span class=&quot;nb&quot;&gt;key&lt;/span&gt; V1&lt;span class=&quot;p&quot;&gt;-----&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;/tls&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;auth&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;


&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;对应，否则无法连通。&lt;/p&gt;

</content>
 </entry>
 
 <entry>
   <title>openwrt下基于DNSPOD的DDNS脚本</title>
   <link href="https://jibenfa.github.io/openwrt/%E7%BC%96%E7%A8%8B/2021/02/10/openwrte4b88be59fbae4ba8eDNSPODe79a84DDNSe8849ae69cac/"/>
   <updated>2021-02-10T07:25:57+00:00</updated>
   <id>https://jibenfa.github.io/openwrt/%E7%BC%96%E7%A8%8B/2021/02/10/openwrte4b88be59fbae4ba8eDNSPODe79a84DDNSe8849ae69cac</id>
   <content type="html">&lt;p&gt;换dns供应商了，撸了一个openwrt下基于dnspod api的ddns脚本：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;c&quot;&gt;#!/bin/sh&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;TOKEN&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;xxx,xxxxxxxxxxxxxxx&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;DOMAIN_ID&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;xxxxxxxxx&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;SUB_DOMAIN&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;xxxx&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;MAIN_DOMAIN&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;xxxx&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;DOMAIN&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;SUB_DOMAIN&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;.&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;MAIN_DOMAIN&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;RECORD_ID&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;xxxxxx&quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#record_id is binding with sub_domain and main_domain, using following command to get record_id&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#curl -X POST https://dnsapi.cn/Record.List -d &apos;login_token=${TOKEN}&amp;amp;format=json&amp;amp;domain_id=${DOMAIN_ID}&amp;amp;offset=0&amp;amp;length=3&apos;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;#get domain ip from common dns&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;IP&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;dig &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;DOMAIN&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; @114.114.114.114 | &lt;span class=&quot;nb&quot;&gt;awk&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-F&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[ ]+&quot;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;/IN/{print $1}&apos;&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;awk&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;NR==2 {print $5}&apos;&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Ip of &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;DOMAIN&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; is ---&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;IP&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;---&quot;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;#get local ip from wan port&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;LIP&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;ifconfig pppoe-wan|awk &lt;span class=&quot;nt&quot;&gt;-F&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[: ]+&quot;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;/inet addr/{print $4}&apos;&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Local Ip is ---&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;LIP&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;---&quot;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;#if domain ip and local ip are identical, dns is ok&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;LIP&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;IP&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
   &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Doman IP not changed.&quot;&lt;/span&gt;
   &lt;span class=&quot;nb&quot;&gt;exit
&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;#if not identical, check dns record from ddns service provider&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;check dnspod dns record of &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;DOMAIN&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;query_cmd&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;curl -X POST https://dnsapi.cn/Record.Info -d &apos;login_token=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TOKEN&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;amp;format=json&amp;amp;domain_id=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;DOMAIN_ID&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;amp;record_id=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;RECORD_ID&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&apos;&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;query_result&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;eval&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;query_cmd&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;query_result_sub_str&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;query_result&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;grep&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;LIP&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;#if dns record is ok, there is no need to update&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${#&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;query_result_sub_str&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-gt&lt;/span&gt; 6 &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
   &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;IP record is OK, waiting for dns spread&quot;&lt;/span&gt;
   &lt;span class=&quot;nb&quot;&gt;exit
&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;#if dns record is not ok, start ddns refresh&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;start ddns refresh&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;refresh_cmd&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;curl -X POST https://dnsapi.cn/Record.Ddns -d &apos;login_token=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TOKEN&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;amp;format=json&amp;amp;domain_id=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;DOMAIN_ID&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;amp;record_id=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;RECORD_ID&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;amp;record_line_id=0&amp;amp;value=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;LIP&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;amp;sub_domain=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;SUB_DOMAIN&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&apos;&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;refreah_result&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;eval&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;refresh_cmd&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;refreah_result&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
</content>
 </entry>
 
 <entry>
   <title>v2ray的ws模式在openwrt上的全局和白名单的优化配置</title>
   <link href="https://jibenfa.github.io/openwrt/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/2020/03/24/v2rayE79A84wsE6A8A1E5BC8FE59CA8openwrtE4B88AE79A84E585A8E5B180E5928CE799BDE5908DE58D95E79A84E4BC98E58C96E9858DE7BDAE/"/>
   <updated>2020-03-24T14:25:57+00:00</updated>
   <id>https://jibenfa.github.io/openwrt/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/2020/03/24/v2rayE79A84wsE6A8A1E5BC8FE59CA8openwrtE4B88AE79A84E585A8E5B180E5928CE799BDE5908DE58D95E79A84E4BC98E58C96E9858DE7BDAE</id>
   <content type="html">&lt;p&gt;一、简介&lt;/p&gt;

&lt;p&gt;随着v2ray的ws+tls+cdn成为标配，openwrt上对应的透明代理的配置一般有两种模式：&lt;/p&gt;

&lt;p&gt;1.白名单代理模式。&lt;/p&gt;

&lt;p&gt;优点是：网页加载速度较全局模式快&lt;/p&gt;

&lt;p&gt;缺点是：不加入gfwlist且被墙的网站打不开，需要手动加白名单&lt;/p&gt;

&lt;p&gt;2.境外全局代理模式。&lt;/p&gt;

&lt;p&gt;优点是：所有被墙的网站都能打开，不用维护复杂的gfwlist&lt;/p&gt;

&lt;p&gt;缺点是：网页加载速度较白名单代理模式慢一些&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;二、为什么要优化&lt;/p&gt;

&lt;p&gt;所谓的优化配置，主要是解决几个问题：&lt;/p&gt;

&lt;p&gt;1.简化v2ray的配置，尽量不使用sniffing嗅探、geoip、geosite等，一方面提升v2ray的速度和稳定性，一方面可以减少路由空间的占用（可以使用空库的geoip和geosite，只需共用chinadns的数据文件）&lt;/p&gt;

&lt;p&gt;2.简化firewall规则配置，尽量减少ipset条目，不影响境内网站的访问速度，同时保证可以访问外网。&lt;/p&gt;

&lt;p&gt;3.使用chinadns解决dns污染问题，保证ping外网的时候能正确获得ip，且利用apnic的网址列表来区分境内外。&lt;/p&gt;

&lt;p&gt;4.通过自定义luci页面，实现全局和白名单模式灵活切换&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;三、怎么进行优化&lt;/p&gt;

&lt;p&gt;下面以ws+tls+cdn为例：&lt;/p&gt;

&lt;p&gt;1.v2ray服务器端配置参考：&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://wallsee.org/2019/06/14/v2ray2bLetsEncrypt2bcdne983a8e7bdb2.html&quot;&gt;配置的一至三小节&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;2.chinadns在openwrt的配置参考：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
config chinadns
	option chnroute &lt;span class=&quot;s1&quot;&gt;&apos;/etc/chinadns_chnroute.txt&apos;&lt;/span&gt;
	option addr &lt;span class=&quot;s1&quot;&gt;&apos;0.0.0.0&apos;&lt;/span&gt;
	option &lt;span class=&quot;nb&quot;&gt;enable&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;1&apos;&lt;/span&gt;
	option port &lt;span class=&quot;s1&quot;&gt;&apos;5454&apos;&lt;/span&gt;
	option server &lt;span class=&quot;s1&quot;&gt;&apos;114.114.114.114,127.0.0.1:5354&apos;&lt;/span&gt;
	option bidirectional &lt;span class=&quot;s1&quot;&gt;&apos;0&apos;&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3.v2ray在openwrt客户端的配置为：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;inbounds&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;    
        &lt;span class=&quot;s2&quot;&gt;&quot;protocol&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;dokodemo-door&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: 1060,
        &lt;span class=&quot;s2&quot;&gt;&quot;listen&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;0.0.0.0&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;sniffing&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;s2&quot;&gt;&quot;enabled&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;destOverride&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;http&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;tls&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
         &lt;span class=&quot;s2&quot;&gt;&quot;settings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
           &lt;span class=&quot;s2&quot;&gt;&quot;network&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;tcp,udp&quot;&lt;/span&gt;,
           &lt;span class=&quot;s2&quot;&gt;&quot;followRedirect&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt; 
         &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
         &lt;span class=&quot;s2&quot;&gt;&quot;streamSettings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
              &lt;span class=&quot;s2&quot;&gt;&quot;sockopt&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
              &lt;span class=&quot;s2&quot;&gt;&quot;tproxy&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;redirect&quot;&lt;/span&gt; 
             &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
         &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
      &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;protocol&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;dokodemo-door&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;listen&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;0.0.0.0&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: 5354,
        &lt;span class=&quot;s2&quot;&gt;&quot;settings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;s2&quot;&gt;&quot;address&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;8.8.8.8&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: 53,
          &lt;span class=&quot;s2&quot;&gt;&quot;network&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;udp&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;timeout&quot;&lt;/span&gt;: 0,
          &lt;span class=&quot;s2&quot;&gt;&quot;followRedirect&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
      &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;protocol&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;dokodemo-door&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;listen&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;0.0.0.0&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: 5355,
        &lt;span class=&quot;s2&quot;&gt;&quot;settings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;s2&quot;&gt;&quot;address&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;8.8.8.8&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: 53,
          &lt;span class=&quot;s2&quot;&gt;&quot;network&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;udp&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;timeout&quot;&lt;/span&gt;: 0,
          &lt;span class=&quot;s2&quot;&gt;&quot;followRedirect&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
      &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;protocol&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;dokodemo-door&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;listen&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;0.0.0.0&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: 5356,
        &lt;span class=&quot;s2&quot;&gt;&quot;settings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;s2&quot;&gt;&quot;address&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;1.1.1.1&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: 53,
          &lt;span class=&quot;s2&quot;&gt;&quot;network&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;udp&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;timeout&quot;&lt;/span&gt;: 0,
          &lt;span class=&quot;s2&quot;&gt;&quot;followRedirect&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
      &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;protocol&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;dokodemo-door&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;listen&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;0.0.0.0&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: 5357,
        &lt;span class=&quot;s2&quot;&gt;&quot;settings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;s2&quot;&gt;&quot;address&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;8.8.4.4&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: 53,
          &lt;span class=&quot;s2&quot;&gt;&quot;network&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;udp&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;timeout&quot;&lt;/span&gt;: 0,
          &lt;span class=&quot;s2&quot;&gt;&quot;followRedirect&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;outbounds&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;protocol&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;vmess&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;tag&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;proxy&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;settings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;s2&quot;&gt;&quot;vnext&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
              &lt;span class=&quot;s2&quot;&gt;&quot;address&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;你的vps域名&quot;&lt;/span&gt;,
              &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: 443,
              &lt;span class=&quot;s2&quot;&gt;&quot;users&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
                &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                  &lt;span class=&quot;s2&quot;&gt;&quot;id&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;你的uuid&quot;&lt;/span&gt;,
                  &lt;span class=&quot;s2&quot;&gt;&quot;alterId&quot;&lt;/span&gt;: 64,
                  &lt;span class=&quot;s2&quot;&gt;&quot;testsEnabled&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;VMessAEAD&quot;&lt;/span&gt;
                &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
              &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
          &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;streamSettings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;s2&quot;&gt;&quot;network&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;ws&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;security&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;tls&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;wsSettings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;s2&quot;&gt;&quot;path&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;你的路径&quot;&lt;/span&gt;
          &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;tcpSettings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;s2&quot;&gt;&quot;allowInsecureCiphers&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;
          &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
  
  
  

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;4.新建luci菜单配置v2ray：&lt;/p&gt;

&lt;p&gt;(1).新建/etc/config/advancedconfig，内容为：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;

config arguments

config rules
	option v2raymode &lt;span class=&quot;s1&quot;&gt;&apos;gfwlist&apos;&lt;/span&gt;


&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;(2)新建/usr/lib/lua/luci/controller/advancedconfig.lua，内容为：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;

&lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;/usr/lib/lua/luci/controller/advancedconfig.lua
module&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;luci.controller.advancedconfig&quot;&lt;/span&gt;, package.seeall&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;function &lt;/span&gt;index&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if &lt;/span&gt;not nixio.fs.access&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/etc/config/advancedconfig&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
                return
        &lt;/span&gt;end
        page &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; entry&lt;span class=&quot;o&quot;&gt;({&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;admin&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;services&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;advancedconfig&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
		cbi&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;advancedconfig&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;,
		_&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;高级设置&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;, 70&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
	page.dependent &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;true
	&lt;/span&gt;page.acl_depends &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;luci-app-firewall&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
end


&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;(3).新建/usr/lib/lua/luci/model/cbi/advancedconfig.lua，内容为：&lt;/p&gt;

&lt;div class=&quot;language-lua highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;--/usr/lib/lua/luci/model/cbi/advancedconfig.lua&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;local&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;nixio.fs&quot;&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;advancedconfig&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;translate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;高级设置&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;translate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;各类服务内置脚本文档的直接编辑，要求必须提前安装v2ray，chinadns，dnsmasq-full，否则功能会不正常&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;section&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TypedSection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;arguments&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;addremove&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;anonymous&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;


&lt;span class=&quot;c1&quot;&gt;--配置1开始&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nixio&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;access&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/etc/dnsmasq.d/custom.conf&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tab&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;config1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;translate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;编辑gfwlist自定义解析文件&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;translate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&amp;lt;p&amp;gt;本页是编辑/etc/dnsmasq.d/custom.conf的内容，gfwlist中的固定网站已经添加，此文件是额外的自定义解析文件，示例：&amp;lt;p&amp;gt; 1.在gfwlist白名单模式下，如要添加xxx.com网站走代理，则增加两行：&amp;lt;p&amp;gt; server=/xxx.com/127.0.0.1#5353 &amp;lt;p&amp;gt; ipset=/xxx.com/gfwlist &amp;lt;p&amp;gt;（其中5353是chinadns上游服务器的监听端口）。&amp;lt;p&amp;gt; 2.在gfwlist白名单模式下，如果要添加333.com 直连不走代理，则增加一行：&amp;lt;p&amp;gt; server=/333.com/114.114.114.114 &amp;lt;p&amp;gt;3.在任何一种模式下如需防止bbb.com的dns查询泄露，则增加一行：&amp;lt;p&amp;gt; server=/bbb.com/127.0.0.1#5353 &amp;lt;p&amp;gt;（其中5353是chinadns上游服务器的监听端口）。&amp;lt;p&amp;gt; &quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;view_cfg1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;taboption&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;config1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TextValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;editconf1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;translate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;每行开头的符号（＃）被视为注释；删除（#）启用指定选项。&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;view_cfg1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rmempty&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;view_cfg1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rows&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;30&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;view_cfg1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;cfgvalue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;section&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nixio&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;readfile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/etc/dnsmasq.d/custom.conf&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;or&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;view_cfg1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;write&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;section&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\r\n?&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	      &lt;span class=&quot;kd&quot;&gt;local&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;old_value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nixio&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;readfile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/etc/dnsmasq.d/custom.conf&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;old_value&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;
		       &lt;span class=&quot;n&quot;&gt;nixio&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;writefile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/etc/dnsmasq.d/custom.conf&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
           &lt;span class=&quot;n&quot;&gt;luci&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sys&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/etc/init.d/dnsmasq restart &amp;gt;/dev/null&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;--配置1结束&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;--配置2开始&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nixio&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;access&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/etc/config/v2ray.json&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tab&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;config2&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;translate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;编辑v2ray配置文件&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;translate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&amp;lt;p&amp;gt;本页是编辑/etc/config/v2ray.json的内容。&amp;lt;p&amp;gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;view_cfg2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;taboption&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;config2&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TextValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;editconf2&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;translate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;每行开头的符号（＃）被视为注释；删除（#）启用指定选项。&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;view_cfg2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rmempty&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;view_cfg2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rows&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;30&lt;/span&gt;


&lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;view_cfg2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;cfgvalue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;section&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nixio&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;readfile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/etc/config/v2ray.json&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;or&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;view_cfg2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;write&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;section&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\r\n?&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	      &lt;span class=&quot;kd&quot;&gt;local&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;old_value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nixio&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;readfile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/etc/config/v2ray.json&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;old_value&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;
		       &lt;span class=&quot;n&quot;&gt;nixio&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;writefile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/etc/config/v2ray.json&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
           &lt;span class=&quot;n&quot;&gt;luci&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sys&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/etc/init.d/v2ray restart &amp;gt;/dev/null&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;--配置2结束&lt;/span&gt;


&lt;span class=&quot;n&quot;&gt;s2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;section&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TypedSection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;rules&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;s2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;addremove&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;s2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;anonymous&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;s2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tab&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;config3&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;translate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;选择v2ray的运行模式&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;translate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&amp;lt;p&amp;gt;本模块是选择v2ray的运行模式，支持三种模式：白名单模式，境外全局代理模式，墙内上网模式。&amp;lt;p&amp;gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;taboption&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;config3&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ListValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;v2raymode&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;translate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;代理模式：白名单模式速度较快，但未添加的被墙网站打不开，境外全局代理模式速度较慢，但所有网站都能打开&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;gfwlist&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;translate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;白名单模式&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;outlands&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;translate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;境外全局模式&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;ingfw&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;translate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;墙内上网模式&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;gfwlist&quot;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;write&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;section&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;   
    &lt;span class=&quot;n&quot;&gt;ListValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;write&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;section&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;nixio&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;writefile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/tmp/v2raymode.txt&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;ingfw&quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;luci&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sys&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/etc/init.d/v2ray restart &amp;gt;/dev/null&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;luci&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sys&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/etc/init.d/v2ray stop &amp;gt;/dev/null&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;重头戏来了~~~~&lt;/p&gt;

&lt;p&gt;5.在openwrt上修改/etc/init.d/v2ray，（注意要提前安装好：chinadns,v2ray,dnsmasq-full,coreutils-nohup），内容为：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;c&quot;&gt;#!/bin/sh /etc/rc.common&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# This is free software, licensed under the GNU General Public License v3.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# See /LICENSE for more information.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# To use this file, install chinadns,v2ray,dnsmasq-full,coreutils-nohup first&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;START&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;90

&lt;span class=&quot;nv&quot;&gt;USE_PROCD&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1
&lt;span class=&quot;nv&quot;&gt;LimitNOFILE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1048576
&lt;span class=&quot;nv&quot;&gt;LimitNPROC&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;512

&lt;span class=&quot;nv&quot;&gt;DOMAIN&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;v2ray的vps的ip&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;domestic_dns_1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;114.114.114.114&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;domestic_dns_2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;119.29.29.29&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;domestic_dns_3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;223.5.5.5&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;domestic_dns_4&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;180.76.76.76&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;localip&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;127.0.0.1&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;chinadns_port_2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5555&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;chinadns_port_3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5656&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;chinadns_port_4&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5757&quot;&lt;/span&gt;

set_multi_domestic_dns&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;current_dns_list&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;uci get dhcp.@dnsmasq[0].server 2&amp;gt;/dev/null&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; x&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;domestic_dns_1&lt;/span&gt;:0:15&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; x&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;current_dns_list&lt;/span&gt;:0:15&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
        &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;setting domestic dns&quot;&lt;/span&gt; 
        uci &lt;span class=&quot;nt&quot;&gt;-q&lt;/span&gt; delete dhcp.@dnsmasq[0].server
        uci add_list dhcp.@dnsmasq[0].server&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;domestic_dns_1&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
        uci add_list dhcp.@dnsmasq[0].server&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;domestic_dns_2&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
        uci add_list dhcp.@dnsmasq[0].server&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;domestic_dns_3&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
        uci add_list dhcp.@dnsmasq[0].server&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;domestic_dns_4&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
        uci &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;dhcp.@dnsmasq[0].noresolv&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0
        uci &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;dhcp.@dnsmasq[0].nohosts&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0
        uci commit dhcp
        /etc/init.d/dnsmasq restart 1&amp;gt;/dev/null 2&amp;gt;&amp;amp;1
        &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;done&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

set_multi_foreign_dns&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;current_dns_list&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;uci get dhcp.@dnsmasq[0].server 2&amp;gt;/dev/null&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; x&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;localip&lt;/span&gt;:0:9&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; x&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;current_dns_list&lt;/span&gt;:0:9&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
        &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;setting foreign dns&quot;&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;chinadns_port&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;uci get chinadns.@chinadns[0].port 2&amp;gt;/dev/null&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;chinadns_listen_ipport&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;localip&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;#&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;chinadns_port&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
        uci &lt;span class=&quot;nt&quot;&gt;-q&lt;/span&gt; delete dhcp.@dnsmasq[0].server
        uci add_list dhcp.@dnsmasq[0].server&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;chinadns_listen_ipport&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
        uci add_list dhcp.@dnsmasq[0].server&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;localip&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;chinadns_port_2&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
        uci add_list dhcp.@dnsmasq[0].server&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;localip&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;chinadns_port_3&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
        uci add_list dhcp.@dnsmasq[0].server&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;localip&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;chinadns_port_4&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
        uci &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;dhcp.@dnsmasq[0].noresolv&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1
        uci &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;dhcp.@dnsmasq[0].nohosts&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1
        uci commit dhcp
        /etc/init.d/dnsmasq restart 1&amp;gt;/dev/null 2&amp;gt;&amp;amp;1
        &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;done&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

create_bypasslist&lt;span class=&quot;o&quot;&gt;(){&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;##########################################################################################################  &lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;bypasscount&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;ipset list bypasslist | &lt;span class=&quot;nb&quot;&gt;wc&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-l&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;    
      
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$bypasscount&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-le&lt;/span&gt; 1 &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;#create ipset list&lt;/span&gt;
        ipset create bypasslist &lt;span class=&quot;nb&quot;&gt;hash&lt;/span&gt;:net family inet hashsize 1024 maxelem 65535
          
        &lt;span class=&quot;c&quot;&gt;#add private address&lt;/span&gt;
        ipset add bypasslist 0.0.0.0/8
        ipset add bypasslist 10.0.0.0/8
        ipset add bypasslist 127.0.0.0/8
        ipset add bypasslist 169.254.0.0/16
        ipset add bypasslist 172.16.0.0/12
        ipset add bypasslist 192.168.0.0/16
        ipset add bypasslist 224.0.0.0/4
        ipset add bypasslist 240.0.0.0/4
          
        &lt;span class=&quot;c&quot;&gt;#add china ip list from apnic&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;line &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /etc/chinadns_chnroute.txt&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;do
            &lt;/span&gt;ipset add bypasslist &lt;span class=&quot;nv&quot;&gt;$line&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;done
    fi&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;#by pass vps server ip&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;sleep &lt;/span&gt;1
    &lt;span class=&quot;c&quot;&gt;#SIP=` ping ${DOMAIN} -c 1 |awk &apos;NR==2 {print $4}&apos; |awk -F &apos;:&apos; &apos;{print $1}&apos;`&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;SIP&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;dig +short &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;DOMAIN&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; @&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;domestic_dns_1&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; x&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;SIP&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; x &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
        for &lt;/span&gt;eachip &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;SIP&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
            &lt;span class=&quot;c&quot;&gt;#echo &quot;${eachip}&quot;&lt;/span&gt;
            ipset add bypasslist &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;eachip&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;done
    fi&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;##########################################################################################################&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

create_gfwlist&lt;span class=&quot;o&quot;&gt;(){&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;##########################################################################################################&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;gfcount&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;ipset list gfwlist | &lt;span class=&quot;nb&quot;&gt;wc&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-l&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;    
      
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$gfcount&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-le&lt;/span&gt; 1 &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
        &lt;/span&gt;ipset &lt;span class=&quot;nt&quot;&gt;-N&lt;/span&gt; gfwlist iphash
         
        &lt;span class=&quot;c&quot;&gt;#add telegram server&lt;/span&gt;
        ipset add gfwlist 93.119.240.0/24
        ipset add gfwlist 93.119.241.0/24
        ipset add gfwlist 93.119.242.0/24
        ipset add gfwlist 93.119.243.0/24
        ipset add gfwlist 93.119.244.0/24
        ipset add gfwlist 93.119.245.0/24
        ipset add gfwlist 93.119.246.0/24
        ipset add gfwlist 93.119.247.0/24
        ipset add gfwlist 93.119.248.0/24
        ipset add gfwlist 93.119.249.0/24
        ipset add gfwlist 93.119.250.0/24
        ipset add gfwlist 93.119.251.0/24
        ipset add gfwlist 93.119.252.0/24
        ipset add gfwlist 93.119.253.0/24
        ipset add gfwlist 93.119.254.0/24
        ipset add gfwlist 93.119.255.0/24
        ipset add gfwlist 149.154.172.0/22
        ipset add gfwlist 91.108.12.0/22
        ipset add gfwlist 149.154.160.0/20
        ipset add gfwlist 149.154.164.0/22
        ipset add gfwlist 91.108.4.0/22
        ipset add gfwlist 91.108.56.0/22
        ipset add gfwlist 91.108.8.0/22
        
    &lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;########################################################################################################&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

enable_bypasslist_firewall_rules&lt;span class=&quot;o&quot;&gt;(){&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;########################################################################################################&lt;/span&gt;
    iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; PREROUTING &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; tcp &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--match-set&lt;/span&gt; bypasslist dst &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; REDIRECT &lt;span class=&quot;nt&quot;&gt;--to-port&lt;/span&gt; 1060 1&amp;gt;/dev/null 2&amp;gt;&amp;amp;1
    iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; OUTPUT &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; tcp &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--match-set&lt;/span&gt; bypasslist dst &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; REDIRECT &lt;span class=&quot;nt&quot;&gt;--to-port&lt;/span&gt; 1060 1&amp;gt;/dev/null 2&amp;gt;&amp;amp;1
    &lt;span class=&quot;c&quot;&gt;########################################################################################################&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

disable_bypasslist_firewall_rules&lt;span class=&quot;o&quot;&gt;(){&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;########################################################################################################&lt;/span&gt;
    iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-D&lt;/span&gt; PREROUTING &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; tcp &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--match-set&lt;/span&gt; bypasslist dst &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; REDIRECT &lt;span class=&quot;nt&quot;&gt;--to-port&lt;/span&gt; 1060 1&amp;gt;/dev/null 2&amp;gt;&amp;amp;1
    iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-D&lt;/span&gt; OUTPUT &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; tcp &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--match-set&lt;/span&gt; bypasslist dst &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; REDIRECT &lt;span class=&quot;nt&quot;&gt;--to-port&lt;/span&gt; 1060 1&amp;gt;/dev/null 2&amp;gt;&amp;amp;1
    &lt;span class=&quot;c&quot;&gt;########################################################################################################&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

enable_gfwlist_firewall_rules&lt;span class=&quot;o&quot;&gt;(){&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;########################################################################################################&lt;/span&gt;
    iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; PREROUTING &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; tcp &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--match-set&lt;/span&gt; gfwlist dst &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; REDIRECT &lt;span class=&quot;nt&quot;&gt;--to-port&lt;/span&gt; 1060 1&amp;gt;/dev/null 2&amp;gt;&amp;amp;1
    iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; OUTPUT &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; tcp &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--match-set&lt;/span&gt; gfwlist dst &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; REDIRECT &lt;span class=&quot;nt&quot;&gt;--to-port&lt;/span&gt; 1060 1&amp;gt;/dev/null 2&amp;gt;&amp;amp;1
    &lt;span class=&quot;c&quot;&gt;########################################################################################################&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

disable_gfwlist_firewall_rules&lt;span class=&quot;o&quot;&gt;(){&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;########################################################################################################&lt;/span&gt;
    iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-D&lt;/span&gt; PREROUTING &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; tcp &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--match-set&lt;/span&gt; gfwlist dst &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; REDIRECT &lt;span class=&quot;nt&quot;&gt;--to-port&lt;/span&gt; 1060 1&amp;gt;/dev/null 2&amp;gt;&amp;amp;1
    iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-D&lt;/span&gt; OUTPUT &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; tcp &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--match-set&lt;/span&gt; gfwlist dst &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; REDIRECT &lt;span class=&quot;nt&quot;&gt;--to-port&lt;/span&gt; 1060 1&amp;gt;/dev/null 2&amp;gt;&amp;amp;1
    &lt;span class=&quot;c&quot;&gt;########################################################################################################&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

disable_v2ray_rules&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;########################################################################################################&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;v2_mode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /tmp/v2raymode.txt 2&amp;gt;/dev/null&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
    disable_gfwlist_firewall_rules
    disable_bypasslist_firewall_rules
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;v2_mode&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;ingfw&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
        &lt;/span&gt;set_multi_domestic_dns
    &lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;########################################################################################################&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

stop_service&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;stopping v2ray service&quot;&lt;/span&gt;
    disable_v2ray_rules
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

enable_v2ray_rules&lt;span class=&quot;o&quot;&gt;(){&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;########################################################################################################&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;v2ray_mode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /tmp/v2raymode.txt 2&amp;gt;/dev/null&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; x&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;v2ray_mode&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; x &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
        &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;v2ray_mode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;uci get advancedconfig.@rules[0].v2raymode 2&amp;gt;/dev/null&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;setting &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;v2ray_mode&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; mode&quot;&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;v2ray_mode&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /tmp/v2raymode.txt
    &lt;span class=&quot;k&quot;&gt;fi
    if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;v2ray_mode&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;outlands&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
        &lt;/span&gt;create_bypasslist
        disable_gfwlist_firewall_rules
        enable_bypasslist_firewall_rules
        set_multi_foreign_dns
    &lt;span class=&quot;k&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;v2ray_mode&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;gfwlist&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
        &lt;/span&gt;create_gfwlist
        disable_bypasslist_firewall_rules
        enable_gfwlist_firewall_rules
        set_multi_foreign_dns
    &lt;span class=&quot;k&quot;&gt;else
        &lt;/span&gt;stop
    &lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;########################################################################################################&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

start_service&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;starting v2ray service&quot;&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;mkdir&lt;/span&gt; /var/log/v2ray &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /dev/null 2&amp;gt;&amp;amp;1
    &lt;span class=&quot;nb&quot;&gt;ulimit&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-n&lt;/span&gt; 99999
    procd_open_instance
    procd_set_param respawn
&lt;span class=&quot;c&quot;&gt;#    procd_set_param command /usr/bin/v2ray -config /etc/config/v2ray.json&lt;/span&gt;
    procd_set_param &lt;span class=&quot;nb&quot;&gt;command&lt;/span&gt; /usr/bin/v2rayx64/v2ray &lt;span class=&quot;nt&quot;&gt;-config&lt;/span&gt; /etc/config/v2ray.json
    procd_set_param file /etc/config/v2ray.json
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_set_param pidfile /var/run/v2ray.pid
    enable_v2ray_rules
    procd_close_instance
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

service_triggers&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
	procd_add_reload_trigger &lt;span class=&quot;s2&quot;&gt;&quot;advancedconfig&quot;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;


&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;两种模式都可以使用同一个v2ray的openwrt客户端配置，其中境外全局模式的防火墙配置非常简洁，看起来很舒服。。。&lt;/p&gt;

&lt;p&gt;6.最后设置一个多进程的chinadns启动脚本，start_multi_chinadns.sh，内容为：&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;c&quot;&gt;#!/bin/sh&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# To use this file, install chinadns,v2ray,dnsmasq-full,coreutils-nohup first&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;domestic_dns_1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;114.114.114.114&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;domestic_dns_2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;119.29.29.29&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;domestic_dns_3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;223.5.5.5&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;domestic_dns_4&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;180.76.76.76&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;localip&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;127.0.0.1&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;chinadns_port_2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5555&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;chinadns_port_3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5656&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;chinadns_port_4&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5757&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;v2_dns_port_2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5355&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;v2_dns_port_3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5356&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;v2_dns_port_4&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5357&quot;&lt;/span&gt;
killall chinadns
/etc/init.d/chinadns restart
&lt;span class=&quot;nb&quot;&gt;sleep &lt;/span&gt;1
&lt;span class=&quot;nb&quot;&gt;nohup&lt;/span&gt; /usr/bin/chinadns &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-b&lt;/span&gt; 0.0.0.0 &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;chinadns_port_2&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;domestic_dns_2&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;,&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;localip&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;:&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;v2_dns_port_2&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; /etc/chinadns_chnroute.txt 1&amp;gt;/dev/null 2&amp;gt;&amp;amp;1 &amp;amp;
&lt;span class=&quot;nb&quot;&gt;sleep &lt;/span&gt;1
&lt;span class=&quot;nb&quot;&gt;nohup&lt;/span&gt; /usr/bin/chinadns &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-b&lt;/span&gt; 0.0.0.0 &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;chinadns_port_3&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;domestic_dns_3&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;,&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;localip&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;:&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;v2_dns_port_3&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; /etc/chinadns_chnroute.txt 1&amp;gt;/dev/null 2&amp;gt;&amp;amp;1 &amp;amp;
&lt;span class=&quot;nb&quot;&gt;sleep &lt;/span&gt;1
&lt;span class=&quot;nb&quot;&gt;nohup&lt;/span&gt; /usr/bin/chinadns &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-b&lt;/span&gt; 0.0.0.0 &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;chinadns_port_4&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;domestic_dns_4&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;,&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;localip&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;:&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;v2_dns_port_4&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; /etc/chinadns_chnroute.txt 1&amp;gt;/dev/null 2&amp;gt;&amp;amp;1 &amp;amp;


&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;设置在rc.local中作为启动项，即可在openwrt启动的时候带起4个进程的chinadns。&lt;/p&gt;

&lt;p&gt;附：luci的效果图如下：&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://jibenfa.github.io/uploads/2020/03/screencapture-2020-03-29-20_27_10.png&quot; width=&quot;900&quot; height=&quot;1100&quot; alt=&quot;AltText&quot; /&gt;&lt;/p&gt;
</content>
 </entry>
 
 <entry>
   <title>定制esxi6.7镜像文件</title>
   <link href="https://jibenfa.github.io/%E8%99%9A%E6%8B%9F%E5%8C%96/2020/01/20/e5ae9ae588b6esxi6.7e9959ce5838fe69687e4bbb6/"/>
   <updated>2020-01-20T08:25:57+00:00</updated>
   <id>https://jibenfa.github.io/%E8%99%9A%E6%8B%9F%E5%8C%96/2020/01/20/e5ae9ae588b6esxi6.7e9959ce5838fe69687e4bbb6</id>
   <content type="html">&lt;p&gt;最近升级了服务器，使用了x550万兆网卡，于是想在esxi6.7中集成最新的1.8.7的网卡驱动，折腾了3个小时，终于搞定：&lt;/p&gt;

&lt;p&gt;1.下载并安装VMware-PowerCLI-6.5.0和ESXi-Customizer-PS封装工具&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;

VMware-PowerCLI-6.5.0-4624819

ESXi-Customizer-PS-v2.6.0.ps1（绿色版）


&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2.下载ESXI6.7 offline bundle&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;

ESXi670-201912001.zip 放到和ESXi-Customizer同一个文件夹下


&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3.升级powershell至3.0版本以上（win10自带的是5.1，无需升级）&lt;/p&gt;

&lt;p&gt;4.下载网卡驱动&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;

VMware ESXi 6.7 ixgben 1.8.7 NIC Driver &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;Intel Ethernet Controllers 82599, x520, x540, x550, x552 and x553 family

https://my.vmware.com/web/vmware/details?productId&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;742&amp;amp;downloadGroup&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;ESXI67U3B#drivers_tools


&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;解压驱动到D:\vmware67u3b\vib\&lt;/p&gt;

&lt;p&gt;5.用管理员权限打开powershell，切换至ESXi-Customizer所在文件夹，执行以下命令：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;

1&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;.Powershell中默认禁止执行脚本，所以先修改策略允许执行

Set-ExecutionPolicy Unrestricted

2&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;.禁止签名校验需修改2个参数&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;环境参数中nosignaturecheck改成true，另外打包命令后增加-nsc&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;$DeployNoSignatureCheck&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$true&lt;/span&gt;

 .&lt;span class=&quot;se&quot;&gt;\E&lt;/span&gt;SXi-Customizer-PS-v2.6.0.ps1 &lt;span class=&quot;nt&quot;&gt;-izip&lt;/span&gt; .&lt;span class=&quot;se&quot;&gt;\E&lt;/span&gt;SXi670-201912001.zip &lt;span class=&quot;nt&quot;&gt;-pkgDir&lt;/span&gt; D:&lt;span class=&quot;se&quot;&gt;\v&lt;/span&gt;mware67u3b&lt;span class=&quot;se&quot;&gt;\v&lt;/span&gt;ib&lt;span class=&quot;se&quot;&gt;\ &lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-nsc&lt;/span&gt;
 

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;如果出现了all done,就表示成功了，可以在上述文件夹下找到ESXi-6.7.0-20191204001-standard-customized.iso&lt;/p&gt;
</content>
 </entry>
 
 <entry>
   <title>perl使用mime发送带附件的邮件</title>
   <link href="https://jibenfa.github.io/%E7%BC%96%E7%A8%8B/2019/08/24/perle4bdbfe794a8mimee58f91e98081e5b8a6e99984e4bbb6e79a84e982aee4bbb6/"/>
   <updated>2019-08-24T11:38:57+00:00</updated>
   <id>https://jibenfa.github.io/%E7%BC%96%E7%A8%8B/2019/08/24/perle4bdbfe794a8mimee58f91e98081e5b8a6e99984e4bbb6e79a84e982aee4bbb6</id>
   <content type="html">&lt;p&gt;好久不用perl脚本写东西了，今天突发奇想，需要自动发送带附件的邮件，网上找了很多资料，修改了一下，就是这样了，先用ppm安装MIME::Lite和Authen::SASL包&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;c&quot;&gt;#!/usr/bin/perl -w&lt;/span&gt;
use strict&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
use warnings&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
use MIME::Lite&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
use MIME::Base64&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
use Authen::SASL&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
 
  my &lt;span class=&quot;nv&quot;&gt;$from&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;发件人邮箱&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  my &lt;span class=&quot;nv&quot;&gt;$passwd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;发件人邮箱密码&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  my &lt;span class=&quot;nv&quot;&gt;$to&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;收件人邮箱&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  my &lt;span class=&quot;nv&quot;&gt;$subject&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;标题&quot;&lt;/span&gt;
  my &lt;span class=&quot;nv&quot;&gt;$content&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;正文内容&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  my &lt;span class=&quot;nv&quot;&gt;$fileone&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;z:\\123.png&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  my &lt;span class=&quot;nv&quot;&gt;$filetwo&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;z:\\456.png&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  my &lt;span class=&quot;nv&quot;&gt;$msg&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; MIME::Lite-&amp;gt;new&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;
      From     &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;  &lt;span class=&quot;nv&quot;&gt;$from&lt;/span&gt;,
      To       &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;  &lt;span class=&quot;nv&quot;&gt;$to&lt;/span&gt;,
      Subject  &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;  &lt;span class=&quot;nv&quot;&gt;$subject&lt;/span&gt;,
      Type     &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;  &lt;span class=&quot;s1&quot;&gt;&apos;TEXT&apos;&lt;/span&gt;,
      Data     &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;  &lt;span class=&quot;nv&quot;&gt;$content&lt;/span&gt;,
  &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;$msg&lt;/span&gt;-&amp;gt;attach &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;
   Type        &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;AUTO&apos;&lt;/span&gt;,
   Path        &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$fileone&lt;/span&gt;,
   Filename    &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;1111.png&quot;&lt;/span&gt;,
   Disposition &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;attachment&apos;&lt;/span&gt;
   &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; or die &lt;span class=&quot;s2&quot;&gt;&quot;Error adding &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$fileone&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;: &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$!&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
   &lt;span class=&quot;nv&quot;&gt;$msg&lt;/span&gt;-&amp;gt;attach &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;
   Type        &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;AUTO&apos;&lt;/span&gt;,
   Path        &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$filetwo&lt;/span&gt;,
   Filename    &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;2222.png&quot;&lt;/span&gt;,
   Disposition &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;attachment&apos;&lt;/span&gt;
   &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; or die &lt;span class=&quot;s2&quot;&gt;&quot;Error adding &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$filetwo&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;: &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$!&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  
  
  MIME::Lite-&amp;gt;send&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;smtp&apos;&lt;/span&gt;,&lt;span class=&quot;s1&quot;&gt;&apos;smtp邮箱服务器&apos;&lt;/span&gt;,
      Debug   &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;0&apos;&lt;/span&gt;,
      &lt;span class=&quot;nv&quot;&gt;AuthUser&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$from&lt;/span&gt;,
      &lt;span class=&quot;nv&quot;&gt;AuthPass&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$passwd&lt;/span&gt;,
  &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;$msg&lt;/span&gt;-&amp;gt;send&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
</content>
 </entry>
 
 <entry>
   <title>v2ray+LetsEncrypt+cdn部署</title>
   <link href="https://jibenfa.github.io/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/2019/06/14/v2ray2bLetsEncrypt2bcdne983a8e7bdb2/"/>
   <updated>2019-06-14T14:46:57+00:00</updated>
   <id>https://jibenfa.github.io/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/2019/06/14/v2ray2bLetsEncrypt2bcdne983a8e7bdb2</id>
   <content type="html">&lt;p&gt;为了拯救被墙的ip，参考了一些资料，最终实现了v2ray+LetsEncrypt+cdn部署。
首先是申请一个域名，example.com&lt;/p&gt;

&lt;p&gt;一、vps部署Nginx和LetsEncrypt&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
apt update
apt &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;nginx &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt;
apt-get update
apt-get &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;software-properties-common
add-apt-repository universe
add-apt-repository ppa：certbot/certbot
apt-get update
apt-get &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;certbot python-certbot-nginx 

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;自动安装Nginx证书：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
certbot &lt;span class=&quot;nt&quot;&gt;--nginx&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;然后crontab -e增加计划任务，自动更新https证书&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
certbot renew &lt;span class=&quot;nt&quot;&gt;--dry-run&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;二、vps配置Nginx和安装配置v2ray&lt;/p&gt;

&lt;p&gt;设置/etc/nginx/sites-enabled/default为：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
server &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;

        &lt;span class=&quot;c&quot;&gt;#index index.html index.htm index.nginx-debian.html;&lt;/span&gt;
        server_name example.com&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# managed by Certbot&lt;/span&gt;


        location /test
        &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
           proxy_redirect off&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
           proxy_pass http://127.0.0.1:23456&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
           proxy_http_version 1.1&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
           proxy_set_header Upgrade &lt;span class=&quot;nv&quot;&gt;$http_upgrade&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
           proxy_set_header Connection &lt;span class=&quot;s2&quot;&gt;&quot;upgrade&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
           proxy_set_header Host &lt;span class=&quot;nv&quot;&gt;$http_host&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;



    listen &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;::]:443 ssl &lt;span class=&quot;nv&quot;&gt;ipv6only&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;on&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# managed by Certbot&lt;/span&gt;
    listen 443 ssl&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# managed by Certbot&lt;/span&gt;
    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# managed by Certbot&lt;/span&gt;
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# managed by Certbot&lt;/span&gt;
    include /etc/letsencrypt/options-ssl-nginx.conf&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# managed by Certbot&lt;/span&gt;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# managed by Certbot&lt;/span&gt;
    ssl on&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;搞完以后，执行：&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
service nginx restart

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;安装v2ray就不说了，服务端配置文件如下：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;inbounds&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: 123456,
      &lt;span class=&quot;s2&quot;&gt;&quot;listen&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;127.0.0.1&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;protocol&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;vmess&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;settings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;clients&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
          &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;s2&quot;&gt;&quot;id&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;你的id&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;alterId&quot;&lt;/span&gt;: 64
          &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;streamSettings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;network&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;ws&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;wsSettings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;path&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;/test&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;outbounds&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;protocol&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;freedom&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;settings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;搞完以后，执行：&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
service v2ray restart

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;三、在cloudflare上配置cdn
不提了，说多泪，主要是:&lt;/p&gt;

&lt;p&gt;1)在dns里面，将解析域名example.com指向被墙ip&lt;/p&gt;

&lt;p&gt;2)将ns server设置为cloudflare的ns&lt;/p&gt;

&lt;p&gt;3）在crypto菜单里面讲ssl设置为full，将“Always Use HTTPS”设置为ON！！！&lt;/p&gt;

&lt;p&gt;四、客户端配置v2ray&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;c&quot;&gt;#这个配置项是结合chinadns使用的&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;inbound&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;protocol&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;dokodemo-door&quot;&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;listen&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;0.0.0.0&quot;&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: 5353,
    &lt;span class=&quot;s2&quot;&gt;&quot;settings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;address&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;8.8.8.8&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: 53,
      &lt;span class=&quot;s2&quot;&gt;&quot;network&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;udp&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;timeout&quot;&lt;/span&gt;: 0,
      &lt;span class=&quot;s2&quot;&gt;&quot;followRedirect&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;inboundDetour&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
       &lt;span class=&quot;s2&quot;&gt;&quot;domainOverride&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;http&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;tls&quot;&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;protocol&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;dokodemo-door&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: 1080,
      &lt;span class=&quot;s2&quot;&gt;&quot;listen&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;0.0.0.0&quot;&lt;/span&gt;,
      
      &lt;span class=&quot;s2&quot;&gt;&quot;settings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;network&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;tcp&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;timeout&quot;&lt;/span&gt;: 30,
        &lt;span class=&quot;s2&quot;&gt;&quot;followRedirect&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;outbounds&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;protocol&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;vmess&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;tag&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;proxy&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;settings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;vnext&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
          &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;s2&quot;&gt;&quot;address&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;你的网址&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: 443,
            &lt;span class=&quot;s2&quot;&gt;&quot;users&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
              &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;s2&quot;&gt;&quot;id&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;你的key&quot;&lt;/span&gt;,
                &lt;span class=&quot;s2&quot;&gt;&quot;alterId&quot;&lt;/span&gt;: 64
              &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
          &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;streamSettings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;network&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;ws&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;security&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;tls&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;wsSettings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;s2&quot;&gt;&quot;path&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;/test&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;outboundDetour&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;protocol&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;freedom&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;settings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{}&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;tag&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;direct&quot;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;,
  
  &lt;span class=&quot;s2&quot;&gt;&quot;routing&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;strategy&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;rules&quot;&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;settings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;domainStrategy&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;IPIfNonMatch&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;rules&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
          &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
           &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;field&quot;&lt;/span&gt;,
           &lt;span class=&quot;s2&quot;&gt;&quot;ip&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
             &lt;span class=&quot;s2&quot;&gt;&quot;8.8.8.8/32&quot;&lt;/span&gt;,
             &lt;span class=&quot;s2&quot;&gt;&quot;8.8.4.4/32&quot;&lt;/span&gt;,
             &lt;span class=&quot;s2&quot;&gt;&quot;91.108.56.0/22&quot;&lt;/span&gt;,
             &lt;span class=&quot;s2&quot;&gt;&quot;91.108.4.0/22&quot;&lt;/span&gt;,
             &lt;span class=&quot;s2&quot;&gt;&quot;109.239.140.0/24&quot;&lt;/span&gt;,
             &lt;span class=&quot;s2&quot;&gt;&quot;149.154.164.0/22&quot;&lt;/span&gt;,
             &lt;span class=&quot;s2&quot;&gt;&quot;91.108.56.0/23&quot;&lt;/span&gt;,
             &lt;span class=&quot;s2&quot;&gt;&quot;67.198.55.0/24&quot;&lt;/span&gt;,
             &lt;span class=&quot;s2&quot;&gt;&quot;149.154.168.0/22&quot;&lt;/span&gt;,
             &lt;span class=&quot;s2&quot;&gt;&quot;149.154.172.0/22&quot;&lt;/span&gt;
           &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;,
           &lt;span class=&quot;s2&quot;&gt;&quot;outboundTag&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;proxy&quot;&lt;/span&gt;
         &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
         &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;field&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;domain&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
            &lt;span class=&quot;s2&quot;&gt;&quot;googleapis.cn&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;google.cn&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;googleapis&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;google&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;domain:facebook.com&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;domain:github.com&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;domain:githubusercontent.com&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;youtube&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;twitter&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;instagram&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;gmail&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;v2ray.com&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;github.io&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;domain:twimg.com&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;domain:t.co&quot;&lt;/span&gt;
          &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;outboundTag&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;proxy&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
        &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
           &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;field&quot;&lt;/span&gt;,           
           &lt;span class=&quot;s2&quot;&gt;&quot;domain&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
                &lt;span class=&quot;s2&quot;&gt;&quot;ext:h2y.dat:gfw&quot;&lt;/span&gt;   &lt;span class=&quot;c&quot;&gt;#这个文件可以从https://github.com/ToutyRater/V2Ray-SiteDAT/tree/master/geofiles下载&lt;/span&gt;
           &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;,
           &lt;span class=&quot;s2&quot;&gt;&quot;outboundTag&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;proxy&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
        &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;field&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;domain&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
            &lt;span class=&quot;s2&quot;&gt;&quot;geosite:cn&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;domain:你的网址&quot;&lt;/span&gt;
          &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;outboundTag&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;direct&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
        &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;field&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;ip&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
            &lt;span class=&quot;s2&quot;&gt;&quot;0.0.0.0/8&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;10.0.0.0/8&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;100.64.0.0/10&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;127.0.0.0/8&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;169.254.0.0/16&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;172.16.0.0/12&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;192.0.0.0/24&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;192.0.2.0/24&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;192.168.0.0/16&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;198.18.0.0/15&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;198.51.100.0/24&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;203.0.113.0/24&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;::1/128&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;fc00::/7&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;fe80::/10&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;geoip:cn&quot;&lt;/span&gt;
          &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;outboundTag&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;direct&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
   &lt;span class=&quot;s2&quot;&gt;&quot;transport&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;tcpSettings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;connectionReuse&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;五、openwrt上配置防火墙&lt;/p&gt;

&lt;p&gt;参考上一篇文章
&lt;a href=&quot;https://jibenfa.github.io/openwrt/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/2019/06/09/v2raye59ca8openwrte4b88be79a84e5ae89e8a385e983a8e7bdb2/&quot;&gt;配置&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;参考资料：&lt;/p&gt;

&lt;p&gt;1).https://certbot.eff.org/lets-encrypt/ubuntubionic-nginx&lt;/p&gt;

&lt;p&gt;2).https://zorz.cc/post/v2ray-cdn.html&lt;/p&gt;
</content>
 </entry>
 
 <entry>
   <title>v2ray在openwrt下的安装部署</title>
   <link href="https://jibenfa.github.io/openwrt/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/2019/06/09/v2raye59ca8openwrte4b88be79a84e5ae89e8a385e983a8e7bdb2/"/>
   <updated>2019-06-09T09:44:57+00:00</updated>
   <id>https://jibenfa.github.io/openwrt/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/2019/06/09/v2raye59ca8openwrte4b88be79a84e5ae89e8a385e983a8e7bdb2</id>
   <content type="html">&lt;p&gt;从本月开始，ss扶墙的服务器全灭，最夸张的是新建一个灭一个，活不过2小时。不得不寻找新的解决方案，终于，花了几天时间搞定了。那就是迁移到v2ray。&lt;/p&gt;

&lt;p&gt;一、性能&lt;/p&gt;

&lt;p&gt;v2ray比ss强大很多，但是对路由的性能要求高很多，经过测试，发现如果要完整安装v2ray-core，路由本身至少需要256M ROM，32M RAM，这样的话，市面大多数跑得动ss路由都被淘汰了，目前mips路由，我只在MT7621AT上测试成功，使用的是联想newifi3 d2，但是想跑满带宽还是建议使用x86软路由，100M vmess跑满的话，i3 4代大约占用13~24%。&lt;/p&gt;

&lt;p&gt;二、安装&lt;/p&gt;

&lt;p&gt;1.服务器端&lt;/p&gt;

&lt;p&gt;1).首先是找一台墙外的vps，linux就行，推荐debian和ubuntu，根据v2ray官方文档，命令行执行：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
bash &amp;lt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; https://install.direct/go.sh&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2).配置服务器端配置文件/etc/v2ray/config.json (v2ray安装完成后此文件就已经存在了，保留id，编辑其他部分)：&lt;/p&gt;

&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;

  &lt;span class=&quot;c&quot;&gt;&quot;inbound&quot;: {&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;&quot;port&quot;: 11111,&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;&quot;protocol&quot;: &quot;vmess&quot;,&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;&quot;settings&quot;: {&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;clients&quot;: [&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;c&quot;&gt;&quot;id&quot;: &quot;你的ID&quot;,&lt;/span&gt;
          &lt;span class=&quot;c&quot;&gt;&quot;level&quot;: 1,&lt;/span&gt;
          &lt;span class=&quot;c&quot;&gt;&quot;alterId&quot;: 64&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;detour&quot;:{&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;to&quot;:&quot;dynamicPort&quot;&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;&quot;streamSettings&quot;:{&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;network&quot;:&quot;kcp&quot;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;c&quot;&gt;&quot;inboundDetour&quot;:[&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;protocol&quot;: &quot;vmess&quot;,&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;port&quot;: &quot;10000-50000&quot;,&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;tag&quot;: &quot;dynamicPort&quot;,&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;settings&quot;: {&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;default&quot;: {&lt;/span&gt;
          &lt;span class=&quot;c&quot;&gt;&quot;level&quot;: 1,&lt;/span&gt;
          &lt;span class=&quot;c&quot;&gt;&quot;alterId&quot;: 64&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;allocate&quot;: {&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;strategy&quot;: &quot;random&quot;,&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;concurrency&quot;: 4,&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;refresh&quot;: 300&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;streamSettings&quot;: {&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;&quot;network&quot;: &quot;kcp&quot;&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
  &lt;span class=&quot;c&quot;&gt;&quot;outbound&quot;: {&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;&quot;protocol&quot;: &quot;freedom&quot;,&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;&quot;settings&quot;: {}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;c&quot;&gt;&quot;outboundDetour&quot;: [&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;protocol&quot;: &quot;blackhole&quot;,&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;settings&quot;: {},&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;tag&quot;: &quot;blocked&quot;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
 &lt;span class=&quot;c&quot;&gt;&quot;transport&quot;:{&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&quot;kcpSettings&quot;:{&lt;/span&gt;
         &lt;span class=&quot;c&quot;&gt;&quot;mtu&quot;:1350,&lt;/span&gt;
         &lt;span class=&quot;c&quot;&gt;&quot;tti&quot;:50,&lt;/span&gt;
         &lt;span class=&quot;c&quot;&gt;&quot;uplinkCapacity&quot;:100,&lt;/span&gt;
         &lt;span class=&quot;c&quot;&gt;&quot;downlinkCapacity&quot;:200,&lt;/span&gt;
         &lt;span class=&quot;c&quot;&gt;&quot;congestion&quot;:true,&lt;/span&gt;
         &lt;span class=&quot;c&quot;&gt;&quot;readBufferSize&quot;:2,&lt;/span&gt;
         &lt;span class=&quot;c&quot;&gt;&quot;writeBufferSize&quot;:2,&lt;/span&gt;
         &lt;span class=&quot;c&quot;&gt;&quot;header&quot;:{&lt;/span&gt;
            &lt;span class=&quot;c&quot;&gt;&quot;type&quot;:&quot;wechat-video&quot;&lt;/span&gt;
         &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
   &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3).运行：&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
service v2ray restart

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ps查看进程如果出现&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
/usr/bin/v2ray &lt;span class=&quot;nt&quot;&gt;-config&lt;/span&gt; /etc/v2ray/config.json

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;即成功了。&lt;/p&gt;

&lt;p&gt;2.本地路由安装&lt;/p&gt;

&lt;p&gt;1).校准时间&lt;/p&gt;

&lt;p&gt;由于v2ray dynamic port对时间要求很高，所以，首先是校准时间，可以在启动项里面添加&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;nb&quot;&gt;sleep &lt;/span&gt;10
ntpd &lt;span class=&quot;nt&quot;&gt;-q&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-n&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; 1.openwrt.pool.ntp.org
ntpd &lt;span class=&quot;nt&quot;&gt;-q&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-n&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt;  ntp1.aliyun.com

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;计划任务里面添加&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
10 &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; ntpd &lt;span class=&quot;nt&quot;&gt;-q&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-n&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; 1.openwrt.pool.ntp.org
10 &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; ntpd &lt;span class=&quot;nt&quot;&gt;-q&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-n&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt;  ntp1.aliyun.com

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2).安装v2ray-core, kuoruan 大神的github仓库里面有release的版本，可以直接去下载合适的架构，我这里下载的是：&lt;/p&gt;

&lt;p&gt;https://github.com/kuoruan/openwrt-v2ray/releases/download/v4.19.1-2/v2ray-core_4.19.1-2_x86_64.ipk&lt;/p&gt;

&lt;p&gt;尝试自己编译了一下，报错了没有成功，就用了现成的。&lt;/p&gt;

&lt;p&gt;ps:其实x86的openwrt装v2ray linux x64原版的也行，直接解压拷贝到openwrt某个目录下chmod就行了，这2个版本都要求装ca-certificates。&lt;/p&gt;

&lt;p&gt;opkg直接安装，建议先opkg update一下，如果有关联的package就一起装了。&lt;/p&gt;

&lt;p&gt;3)配置v2ray，可以放在/etc/config/v2ray.json&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;

  &lt;span class=&quot;s2&quot;&gt;&quot;outbound&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;protocol&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;vmess&quot;&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;tag&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;proxy&quot;&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;settings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;vnext&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;s2&quot;&gt;&quot;address&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;VPS的ip地址&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: 11111,
          &lt;span class=&quot;s2&quot;&gt;&quot;users&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
              &lt;span class=&quot;s2&quot;&gt;&quot;id&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;你的id&quot;&lt;/span&gt;,
              &lt;span class=&quot;s2&quot;&gt;&quot;level&quot;&lt;/span&gt;: 1,
              &lt;span class=&quot;s2&quot;&gt;&quot;alterId&quot;&lt;/span&gt;: 64
            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
          &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;streamSettings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;network&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;kcp&quot;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;mux&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;#不建议打开，否则会断流&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;enabled&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;outboundDetour&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;protocol&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;freedom&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;settings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{}&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;tag&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;direct&quot;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;inbound&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;protocol&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;dokodemo-door&quot;&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;listen&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;127.0.0.1&quot;&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: 5353,
    &lt;span class=&quot;s2&quot;&gt;&quot;settings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;address&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;8.8.8.8&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: 53,
      &lt;span class=&quot;s2&quot;&gt;&quot;network&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;udp&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;timeout&quot;&lt;/span&gt;: 0,
      &lt;span class=&quot;s2&quot;&gt;&quot;followRedirect&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;inboundDetour&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;#如果使用chinadns，这个参数可以不要&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;sniffing&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;enabled&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;destOverride&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;http&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;tls&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;protocol&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;dokodemo-door&quot;&lt;/span&gt;,
       &lt;span class=&quot;s2&quot;&gt;&quot;listen&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;网关的lan ip例如192.168.1.1，如果不指定仅监听lan，会有安全性问题&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: 1060,
      &lt;span class=&quot;s2&quot;&gt;&quot;settings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;network&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;tcp&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;timeout&quot;&lt;/span&gt;: 30,
        &lt;span class=&quot;s2&quot;&gt;&quot;followRedirect&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;dns&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;servers&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
       &lt;span class=&quot;s2&quot;&gt;&quot;localhost&quot;&lt;/span&gt;,
       &lt;span class=&quot;s2&quot;&gt;&quot;8.8.8.8&quot;&lt;/span&gt;,
       &lt;span class=&quot;s2&quot;&gt;&quot;1.1.1.1&quot;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;routing&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;strategy&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;rules&quot;&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;settings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;domainStrategy&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;IPIfNonMatch&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;rules&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
          &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
           &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;field&quot;&lt;/span&gt;,
           &lt;span class=&quot;s2&quot;&gt;&quot;ip&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
             &lt;span class=&quot;s2&quot;&gt;&quot;8.8.8.8/32&quot;&lt;/span&gt;,
             &lt;span class=&quot;s2&quot;&gt;&quot;8.8.4.4/32&quot;&lt;/span&gt;,
             &lt;span class=&quot;s2&quot;&gt;&quot;91.108.56.0/22&quot;&lt;/span&gt;,
             &lt;span class=&quot;s2&quot;&gt;&quot;91.108.4.0/22&quot;&lt;/span&gt;,
             &lt;span class=&quot;s2&quot;&gt;&quot;109.239.140.0/24&quot;&lt;/span&gt;,
             &lt;span class=&quot;s2&quot;&gt;&quot;149.154.164.0/22&quot;&lt;/span&gt;,
             &lt;span class=&quot;s2&quot;&gt;&quot;91.108.56.0/23&quot;&lt;/span&gt;,
             &lt;span class=&quot;s2&quot;&gt;&quot;67.198.55.0/24&quot;&lt;/span&gt;,
             &lt;span class=&quot;s2&quot;&gt;&quot;149.154.168.0/22&quot;&lt;/span&gt;,
             &lt;span class=&quot;s2&quot;&gt;&quot;149.154.172.0/22&quot;&lt;/span&gt;
           &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;,
           &lt;span class=&quot;s2&quot;&gt;&quot;outboundTag&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;proxy&quot;&lt;/span&gt;
         &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
         &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;field&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;domain&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
            &lt;span class=&quot;s2&quot;&gt;&quot;googleapis.cn&quot;&lt;/span&gt;,
    	    &lt;span class=&quot;s2&quot;&gt;&quot;google.cn&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;googleapis&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;google&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;facebook&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;youtube&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;twitter&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;instagram&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;gmail&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;domain:twimg.com&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;domain:t.co&quot;&lt;/span&gt;
          &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;outboundTag&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;proxy&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
        &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;field&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;domain&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
            &lt;span class=&quot;s2&quot;&gt;&quot;geosite:cn&quot;&lt;/span&gt;
          &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;outboundTag&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;direct&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
        &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;field&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;1-21&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;outboundTag&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;direct&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
        &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;field&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;54-79&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;outboundTag&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;direct&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
        &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;field&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;81-442&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;outboundTag&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;direct&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
        &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;field&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;444-3999&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;outboundTag&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;direct&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
        &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;field&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;4001-65535&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;outboundTag&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;direct&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
        &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;s2&quot;&gt;&quot;domain&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
            &lt;span class=&quot;s2&quot;&gt;&quot;vultr.com&quot;&lt;/span&gt;
          &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;field&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;outboundTag&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;direct&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
        &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;chinasites&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;outboundTag&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;direct&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
        &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;field&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;ip&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
            &lt;span class=&quot;s2&quot;&gt;&quot;0.0.0.0/8&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;10.0.0.0/8&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;100.64.0.0/10&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;127.0.0.0/8&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;169.254.0.0/16&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;172.16.0.0/12&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;192.0.0.0/24&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;192.0.2.0/24&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;192.168.0.0/16&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;198.18.0.0/15&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;198.51.100.0/24&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;203.0.113.0/24&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;::1/128&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;fc00::/7&quot;&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;fe80::/10&quot;&lt;/span&gt;
          &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;outboundTag&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;direct&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
        &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;chinaip&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;outboundTag&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;direct&quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;transport&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
     &lt;span class=&quot;s2&quot;&gt;&quot;tcpSettings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;connectionReuse&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;kcpSettings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;mtu&quot;&lt;/span&gt;: 1350,
      &lt;span class=&quot;s2&quot;&gt;&quot;tti&quot;&lt;/span&gt;: 50,
      &lt;span class=&quot;s2&quot;&gt;&quot;uplinkCapacity&quot;&lt;/span&gt;: 100,
      &lt;span class=&quot;s2&quot;&gt;&quot;downlinkCapacity&quot;&lt;/span&gt;: 200,
      &lt;span class=&quot;s2&quot;&gt;&quot;congestion&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;readBufferSize&quot;&lt;/span&gt;: 2,
      &lt;span class=&quot;s2&quot;&gt;&quot;writeBufferSize&quot;&lt;/span&gt;: 2,
      &lt;span class=&quot;s2&quot;&gt;&quot;header&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;wechat-video&quot;&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;4)添加文件/etc/init.d/v2ray,填写如下内容：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;c&quot;&gt;#!/bin/sh /etc/rc.common&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Copyright (C) 2017 Ian Li &amp;lt;OpenSource@ianli.xyz&amp;gt;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# This is free software, licensed under the GNU General Public License v3.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# See /LICENSE for more information.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;START&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;90

&lt;span class=&quot;nv&quot;&gt;USE_PROCD&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1
&lt;span class=&quot;nv&quot;&gt;LimitNOFILE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1048576
&lt;span class=&quot;nv&quot;&gt;LimitNPROC&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;512

start_service&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;mkdir&lt;/span&gt; /var/log/v2ray &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /dev/null 2&amp;gt;&amp;amp;1
        &lt;span class=&quot;nb&quot;&gt;ulimit&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-n&lt;/span&gt; 99999
        procd_open_instance
        procd_set_param respawn
        procd_set_param &lt;span class=&quot;nb&quot;&gt;command&lt;/span&gt; /usr/bin/v2ray &lt;span class=&quot;nt&quot;&gt;-config&lt;/span&gt; /etc/config/v2ray.json
        procd_set_param file /etc/config/v2ray.json
        procd_set_param stdout 1
        procd_set_param stderr 1
        procd_set_param pidfile /var/run/v2ray.pid
        procd_close_instance
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;


&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;5)添加服务，开机自动运行，并运行：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;nb&quot;&gt;chmod&lt;/span&gt; +x /etc/init.d/v2ray
/etc/init.d/v2ray &lt;span class=&quot;nb&quot;&gt;enable
&lt;/span&gt;service v2ray start

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ps查看进程，如果存在，即正常启动。&lt;/p&gt;

&lt;p&gt;6)两种模式，任选一种：&lt;/p&gt;

&lt;p&gt;a) 境外全局模式，所有境外网站均挂代理&lt;/p&gt;

&lt;p&gt;添加防火墙规则(直接添加到/etc/firewall.user 或者luci界面 网络-&amp;gt;防火墙 编辑)：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-N&lt;/span&gt; V2RAY
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; V2RAY &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; VPS地址 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; V2RAY &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 0.0.0.0/8 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; V2RAY &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 10.0.0.0/8 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; V2RAY &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 127.0.0.0/8 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; V2RAY &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 169.254.0.0/16 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; V2RAY &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 172.16.0.0/12 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; V2RAY &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 192.168.0.0/16 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; V2RAY &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 224.0.0.0/4 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; V2RAY &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 240.0.0.0/4 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; V2RAY &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; 内网ip段，例如192.168.1.0/24 &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; tcp &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; REDIRECT &lt;span class=&quot;nt&quot;&gt;--to-ports&lt;/span&gt; 1060
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; PREROUTING &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; tcp &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; V2RAY
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; OUTPUT &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; tcp &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; V2RAY

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;b) gwflist模式，仅对gfwlist挂代理，此方法可以提升路由国内网站访问性能（建议删除v2ray配置文件中的 “routing”路由部分）还能避免p2p下载时影响路由性能&lt;/p&gt;

&lt;p&gt;先安装dnsmasq_full&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
opkg update
opkg &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;dnsmasq_full
opkg remove dnsmasq

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;添加防火墙规则(直接添加到/etc/firewall.user 或者luci界面 网络-&amp;gt;防火墙 编辑)：&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
ipset &lt;span class=&quot;nt&quot;&gt;-N&lt;/span&gt; gfwlist iphash
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; PREROUTING &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; tcp &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--match-set&lt;/span&gt; gfwlist dst &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; REDIRECT &lt;span class=&quot;nt&quot;&gt;--to-port&lt;/span&gt; 1060
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; OUTPUT &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; tcp &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--match-set&lt;/span&gt; gfwlist dst &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; REDIRECT &lt;span class=&quot;nt&quot;&gt;--to-port&lt;/span&gt; 1060
&lt;span class=&quot;c&quot;&gt;#add telegram server&lt;/span&gt;
ipset add gfwlist 93.119.240.0/24
ipset add gfwlist 93.119.241.0/24
ipset add gfwlist 93.119.242.0/24
ipset add gfwlist 93.119.243.0/24
ipset add gfwlist 93.119.244.0/24
ipset add gfwlist 93.119.245.0/24
ipset add gfwlist 93.119.246.0/24
ipset add gfwlist 93.119.247.0/24
ipset add gfwlist 93.119.248.0/24
ipset add gfwlist 93.119.249.0/24
ipset add gfwlist 93.119.250.0/24
ipset add gfwlist 93.119.251.0/24
ipset add gfwlist 93.119.252.0/24
ipset add gfwlist 93.119.253.0/24
ipset add gfwlist 93.119.254.0/24
ipset add gfwlist 93.119.255.0/24
ipset add gfwlist 149.154.172.0/22
ipset add gfwlist 91.108.12.0/22
ipset add gfwlist 149.154.160.0/20
ipset add gfwlist 149.154.164.0/22
ipset add gfwlist 91.108.4.0/22
ipset add gfwlist 91.108.56.0/22
ipset add gfwlist 91.108.8.0/22

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;编辑/etc/dnsmasq.conf，github上有很多脚本自动将gfwlist转换为dnsmasq.conf，也可以下个现成的，例如：&lt;/p&gt;

&lt;p&gt;https://cokebar.github.io/gfwlist2dnsmasq/dnsmasq_gfwlist_ipset.conf&lt;/p&gt;

&lt;p&gt;其中部分内容（规则）为：&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;nv&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/030buy.com/127.0.0.1#5353
&lt;span class=&quot;nv&quot;&gt;ipset&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/030buy.com/gfwlist
&lt;span class=&quot;nv&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/0rz.tw/127.0.0.1#5353
&lt;span class=&quot;nv&quot;&gt;ipset&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/0rz.tw/gfwlist
……

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;7)配置/etc/dnsmasq.conf，防止dns查询泄露：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;nv&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/google.com/127.0.0.1#5353
&lt;span class=&quot;nv&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/google.com.hk/127.0.0.1#5353
&lt;span class=&quot;nv&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/google.com.tw/127.0.0.1#5353
&lt;span class=&quot;nv&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/google.com.sg/127.0.0.1#5353
&lt;span class=&quot;nv&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/google.co.jp/127.0.0.1#5353
&lt;span class=&quot;nv&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/google.co.kr/127.0.0.1#5353
&lt;span class=&quot;nv&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/freeweibo.com/127.0.0.1#5353
&lt;span class=&quot;nv&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/twitter.com/127.0.0.1#5353
&lt;span class=&quot;nv&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/facebook.com/127.0.0.1#5353
&lt;span class=&quot;nv&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/instagram.com/127.0.0.1#5353

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;运行：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
/etc/init.d/dnsmasq restart

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;8）安装和配置chinadns&lt;/p&gt;

&lt;p&gt;虽然v2ray也有dns配置，但：&lt;/p&gt;

&lt;p&gt;a.不支持固定端口的dns国内外分流（domainoverride或sniffing确实可以防止污染，但是偶尔会有reset的问题）&lt;/p&gt;

&lt;p&gt;b.ip地址库过于庞大&lt;/p&gt;

&lt;p&gt;c.被墙网站能上但ping不通（对于dns污染的网址，子网拿不到真实ip）&lt;/p&gt;

&lt;p&gt;因此还是使用chinadns。&lt;/p&gt;

&lt;p&gt;首先安装chinadns (直接去github下载对应安装包)：&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
opkg update
opkg &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;chinadns

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;其次登陆luci界面：&lt;/p&gt;

&lt;p&gt;a.服务-&amp;gt;chinadns设置&lt;/p&gt;

&lt;p&gt;‘启用压缩指针’勾打上，&lt;/p&gt;

&lt;p&gt;‘启用双向过滤’勾去掉，&lt;/p&gt;

&lt;p&gt;‘上游服务器’改成114.114.114.114,127.0.0.1:5353，&lt;/p&gt;

&lt;p&gt;注：5353也可以改成dns forward监听端口，这样走tcp查dns&lt;/p&gt;

&lt;p&gt;chinadns的监听端口为5454，打勾启用&lt;/p&gt;

&lt;p&gt;监听地址为127.0.0.1&lt;/p&gt;

&lt;p&gt;b.网络-&amp;gt;dhcp/dns设置&lt;/p&gt;

&lt;p&gt;基本设置-&amp;gt;dns转发 里面设置为&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
127.0.0.1#5454
127.0.0.1#5454
127.0.0.1#5454
127.0.0.1#5454

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;填4个是为了保证稳定性，否则经常会出现解析失败导致网页无法打开&lt;/p&gt;

&lt;p&gt;c.基本设置-&amp;gt;host和解析文件&lt;/p&gt;

&lt;p&gt;忽略解析文件 打钩&lt;/p&gt;

&lt;p&gt;忽略HOSTS文件 打钩&lt;/p&gt;

&lt;p&gt;9)重启防火墙/路由即可&lt;/p&gt;

&lt;p&gt;注意：如果之前配置过ss+dnsforwarder+chinadns，建议重新刷机或者删除所有配置后重新配置，否则会有冲突。
另外建议在/etc/sysctl.conf增加：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
fs.file-max&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;90000

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;之前貌似运行时间一久，会出现 too many open files 的提示，用上述办法（包括/etc/init.d/v2ray 的参数/命令设置）后没有出现此类问题。&lt;/p&gt;

&lt;p&gt;此外国内部分运营商对kcp有qos，症状是每隔一段时间，会出现断流，也就是十几或几十分钟后，间歇出现不能上外网的情况。。。这一点已经验证。解决方案是——用v2ray负载均衡,但不能完全解决。。。换运营商是王道。。。&lt;/p&gt;

&lt;p&gt;参考资料：&lt;/p&gt;

&lt;p&gt;1).https://blog.dreamtobe.cn/r7800-openwrt-v2ray/&lt;/p&gt;
</content>
 </entry>
 
 <entry>
   <title>在Openwrt/Lede路由上实现基于Name.com V4版本API的快速更新的DDNS</title>
   <link href="https://jibenfa.github.io/openwrt/2018/02/28/e59ca8openwrt-ledee8b7afe794b1e4b88ae5ae9ee78eb0e59fbae4ba8ename-com-v4e78988e69cacapie79a84ddns/"/>
   <updated>2018-02-28T22:21:35+00:00</updated>
   <id>https://jibenfa.github.io/openwrt/2018/02/28/e59ca8openwrt-ledee8b7afe794b1e4b88ae5ae9ee78eb0e59fbae4ba8ename-com-v4e78988e69cacapie79a84ddns</id>
   <content type="html">&lt;p&gt;之前一直用花生壳的免费DDNS，但是最近一周不知道为啥，服务老是抽风，dns更新速度明显下降，甚至达到1-2天。于是研究了一下，发现name.com最近发布了v4版本的api，看了文档以后，果断写了个脚本，一旦ip变更，新dns可以马上更新，消耗时间无限接近0。。。于是ddns更新时间只基于计划任务的间隔时间了。。。&lt;br /&gt;
使用此脚本的前提：&lt;br /&gt;
1.域名必须是由name.com购买的，并且生成一个生产的Token。&lt;br /&gt;
2.登陆账户必须没有开启二次验证，否则api会提示错误：Accout has Namesafe enabled. （注意这里account拼写还是错的。。已发ticket给name.com）。&lt;br /&gt;
3.路由上需要安装curl和ca-certificates和ca-bundle,以便解析https。&lt;br /&gt;
4.首次需要手动添加一次域名，以便获取ID号码，例如为www.examle.com添加第一个dns记录：&lt;br /&gt;
&lt;!--more--&gt;&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;YOUR_USER_NAME:YOUR_API_TOKEN&apos;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;https://api.name.com/v4/domains/example.com/records&apos;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-X&lt;/span&gt; POST &lt;span class=&quot;nt&quot;&gt;--data&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;{&quot;host&quot;:&quot;www&quot;,&quot;type&quot;:&quot;A&quot;,&quot;answer&quot;:&quot;YOUR_IP&quot;,&quot;ttl&quot;:300}&apos;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;从返回的json里面记录下id，json格式为：&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;id&quot;&lt;/span&gt;: 12345,
    &lt;span class=&quot;s2&quot;&gt;&quot;domainName&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;example.org&quot;&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;host&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;www&quot;&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;fqdn&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;www.example.org&quot;&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;A&quot;&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;answer&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;10.0.0.1&quot;&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;ttl&quot;&lt;/span&gt;: 300
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;此id要写入脚本。&lt;/p&gt;

&lt;p&gt;后续就可以通过如下脚本更新dns了。&lt;br /&gt;
脚本如下：&lt;/p&gt;

&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;#&lt;span class=&quot;p&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt;/bin/&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;sh&lt;/span&gt;

USER&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;YOUR_USER_NAME&quot;&lt;/span&gt;
TOKEN&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;YOUR_API_TOKEN&quot;&lt;/span&gt;
ID&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;YOUR_URL_ID&quot;&lt;/span&gt;
HOST&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;www&quot;&lt;/span&gt;
DOMAIN&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;example.com&quot;&lt;/span&gt;
URL&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;$&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;HOST&lt;span class=&quot;p&quot;&gt;}.&lt;/span&gt;$&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;DOMAIN&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
IP&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;`ping $&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;URL&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;awk &lt;span class=&quot;s1&quot;&gt;&apos;NR==2 {print $4}&apos;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;awk &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;F &lt;span class=&quot;s1&quot;&gt;&apos;:&apos;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;{print $1}&apos;&lt;/span&gt;`
#如果安装了dig也可以这样
#IP&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;`&lt;span class=&quot;k&quot;&gt;dig&lt;/span&gt; $&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;DOMAIN&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; @&lt;span class=&quot;m&quot;&gt;114&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;114&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;114&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;114&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; awk &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;F &lt;span class=&quot;s2&quot;&gt;&quot;[ ]+&quot;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;/IN/{print $1}&apos;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; awk &lt;span class=&quot;s1&quot;&gt;&apos;NR==2 {print $5}&apos;&lt;/span&gt;`
echo &lt;span class=&quot;s2&quot;&gt;&quot;Ip of ${URL} is ${IP}&quot;&lt;/span&gt;
LIP&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;`ifconfig pppoe&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;wan&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;awk &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;F &lt;span class=&quot;s2&quot;&gt;&quot;[: ]+&quot;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;/inet addr/{print $4}&apos;&lt;/span&gt;`
echo &lt;span class=&quot;s2&quot;&gt;&quot;Local Ip is ---${LIP}---&quot;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;${LIP}&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;${IP}&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;; then
   &lt;span class=&quot;k&quot;&gt;exit&lt;/span&gt;
fi

echo &lt;span class=&quot;s2&quot;&gt;&quot;start ddns refresh&quot;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;${LIP}&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;; then
   curl &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;u&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;$&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;USER&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;:&apos;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;$&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;TOKEN&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;&apos;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;https://api.name.com/v4/domains/&apos;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;$&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;DOMAIN&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;/records/&apos;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;$&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;ID&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;&apos;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;X PUT &lt;span class=&quot;p&quot;&gt;--&lt;/span&gt;data &lt;span class=&quot;s1&quot;&gt;&apos;{&quot;host&quot;:&quot;&apos;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;$&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;HOST&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;&quot;,&quot;type&quot;:&quot;A&quot;,&quot;answer&quot;:&quot;&apos;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;$&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;LIP&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;&quot;,&quot;ttl&quot;:300}&apos;&lt;/span&gt;
   echo $&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;LIP&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/tmp/&lt;/span&gt;ddnsResult
fi
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;参考资料：&lt;br /&gt;
1.https://www.name.com/api-docs/&lt;/p&gt;
</content>
 </entry>
 
 <entry>
   <title>使用LEDE/OPENWRT 路由器自动发送邮件</title>
   <link href="https://jibenfa.github.io/openwrt/2018/01/30/e4bdbfe794a8ledeopenwrt-e8b7afe794b1e599a8e887aae58aa8e58f91e98081e982aee4bbb6/"/>
   <updated>2018-01-30T22:32:10+00:00</updated>
   <id>https://jibenfa.github.io/openwrt/2018/01/30/e4bdbfe794a8ledeopenwrt-e8b7afe794b1e599a8e887aae58aa8e58f91e98081e982aee4bbb6</id>
   <content type="html">&lt;p&gt;今天研究实现了手动或者定时自动通过LEDE/openwrt路由对外发送邮件的功能。&lt;br /&gt;
1.安装软件包。&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;opkg update
opkg &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;mutt ssmtp ca-certificates ca-bundle
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2.配置ssmtp&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;vi /etc/ssmtp/ssmtp.conf

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;内容为：&lt;br /&gt;
&lt;!--more--&gt;&lt;/p&gt;

&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;#
# &lt;span class=&quot;sr&quot;&gt;/etc/&lt;/span&gt;ssmtp&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;conf&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;--&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;a&lt;/span&gt; config &lt;span class=&quot;k&quot;&gt;file&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; sSMTP sendmail&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;
#

# The person who gets &lt;span class=&quot;k&quot;&gt;all&lt;/span&gt; mail &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; userids &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1000&lt;/span&gt;
# Make this &lt;span class=&quot;nb&quot;&gt;empty&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;to&lt;/span&gt; disable rewriting&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;
root&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;MY@TEST&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;com&lt;/span&gt;

# The place where the mail goes&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt; The actual machine name &lt;span class=&quot;k&quot;&gt;is&lt;/span&gt; required
# no MX records are consulted&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt; Commonly mailhosts are named mail&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;domain&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;com&lt;/span&gt;
# The example will fit &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; you are &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; domain&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;com&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;and&lt;/span&gt; your mailhub &lt;span class=&quot;k&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;so&lt;/span&gt; named&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;
# 不同邮箱供应商的配置不同，需查阅供应商手册
mailhub&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;smtp&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;TEST&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;com&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;465&lt;/span&gt;

# Example &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; SMTP port &lt;span class=&quot;k&quot;&gt;number&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2525&lt;/span&gt;
# mailhub&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;mail&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;your&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;domain&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2525&lt;/span&gt;
# Example &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; SMTP port &lt;span class=&quot;k&quot;&gt;number&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;25&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Standard/RFC&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
# mailhub&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;mail&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;your&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;domain
# Example &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; SSL encrypted connection
# mailhub&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;mail&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;your&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;domain&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;465&lt;/span&gt;

# Where will the mail seem &lt;span class=&quot;k&quot;&gt;to&lt;/span&gt; come from?
rewriteDomain&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;TEST&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;com&lt;/span&gt;

# The full &lt;span class=&quot;nb&quot;&gt;hostname&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;hostname&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;TEST&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;com&lt;/span&gt;

# Set this &lt;span class=&quot;k&quot;&gt;to&lt;/span&gt; never rewrite the &lt;span class=&quot;s2&quot;&gt;&quot;From:&quot;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;line&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;unless not given&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;to&lt;/span&gt;
# use that address &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; the &lt;span class=&quot;s2&quot;&gt;&quot;from line&quot;&lt;/span&gt; of the envelope&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;
FromLineOverride&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;YES

# Use SSL/TLS &lt;span class=&quot;k&quot;&gt;to&lt;/span&gt; send &lt;span class=&quot;nb&quot;&gt;secure&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;messages&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;to&lt;/span&gt; server&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;
UseTLS&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;YES

# Use SSL/TLS certificate &lt;span class=&quot;k&quot;&gt;to&lt;/span&gt; authenticate against smtp host&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;
#UseTLSCert&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;YES

# Use this RSA certificate&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;
#TLSCert&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt;/etc/&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;ssl&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt;/certs/&lt;/span&gt;ssmtp&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;pem

# Get enhanced &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;*really* enhanced&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; debugging information &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; the logs
# If you want &lt;span class=&quot;k&quot;&gt;to&lt;/span&gt; have debugging of the config &lt;span class=&quot;k&quot;&gt;file&lt;/span&gt; parsing&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;move&lt;/span&gt; this option
# &lt;span class=&quot;k&quot;&gt;to&lt;/span&gt; the &lt;span class=&quot;nb&quot;&gt;top&lt;/span&gt; of the config &lt;span class=&quot;k&quot;&gt;file&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;and&lt;/span&gt; uncomment
#Debug&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;YES

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;然后：&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;vi /etc/ssmtp/revaliases
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;内容为：&lt;/p&gt;

&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# sSMTP aliases
#
# Format&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;       local_account&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;outgoing_address&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;mailhub
#
# Example&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; root&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;your_login@your&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;domain&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;mailhub&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;your&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;domain&lt;span class=&quot;p&quot;&gt;[:&lt;/span&gt;port&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
# where &lt;span class=&quot;p&quot;&gt;[:&lt;/span&gt;port&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;is&lt;/span&gt; an optional port &lt;span class=&quot;k&quot;&gt;number&lt;/span&gt; that defaults &lt;span class=&quot;k&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;25&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;
root&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;MY@TEST&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;com&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;smtp&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;TEST&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;com&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;465&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3.配置mutt&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;vi ~/.muttrc
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;内容为：&lt;/p&gt;

&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mailboxes &lt;span class=&quot;sr&quot;&gt;/tmp/&lt;/span&gt;mail
&lt;span class=&quot;k&quot;&gt;set&lt;/span&gt; sendmail&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;ssmtp -v -auMY@TEST.com -apMYPASSWORD&quot;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;set&lt;/span&gt; from&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;MY@TEST.com&quot;&lt;/span&gt;
# Mail folder setup&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;set&lt;/span&gt; folder&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt;/tmp/&lt;/span&gt;mail
&lt;span class=&quot;k&quot;&gt;set&lt;/span&gt; mbox_type&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;mbox
&lt;span class=&quot;k&quot;&gt;set&lt;/span&gt; spoolfile&lt;span class=&quot;p&quot;&gt;=+&lt;/span&gt;inbox
&lt;span class=&quot;k&quot;&gt;set&lt;/span&gt; mbox&lt;span class=&quot;p&quot;&gt;=+&lt;/span&gt;received
&lt;span class=&quot;k&quot;&gt;set&lt;/span&gt; postponed&lt;span class=&quot;p&quot;&gt;=+&lt;/span&gt;postponed
&lt;span class=&quot;k&quot;&gt;set&lt;/span&gt; record&lt;span class=&quot;p&quot;&gt;=+&lt;/span&gt;sent
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;4.编写脚本sendmail.sh&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;vi ./sendmail.sh
&lt;span class=&quot;nb&quot;&gt;chmod&lt;/span&gt; +x ./sendmail.sh
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;内容为：&lt;/p&gt;

&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;mkdir&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/tmp/&lt;/span&gt;mail
&lt;span class=&quot;k&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/tmp/&lt;/span&gt;sysinfo/model &lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; mutt  &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;s &lt;span class=&quot;s2&quot;&gt;&quot;Mail from Router of Coffeecat&quot;&lt;/span&gt;  receiver@TEST&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;com&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;attachment.txt&apos;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;然后运行：&lt;br /&gt;
./sendmail.sh&lt;br /&gt;
就可以看到结果了（如果是从vip.qq.com发送的话）：&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&amp;lt;-] 220 smtp.qq.com Esmtp QQ Mail Server
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;] EHLO vip.qq.com
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&amp;lt;-] 250 8BITMIME
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;] AUTH LOGIN
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&amp;lt;-] 334 XXYlcm5hbDF6
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;] Z2FyACDDbTT4dBB2aXAucWSuY29t
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&amp;lt;-] 334 REWzc3dverH6
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&amp;lt;-] 235 Authentication successful
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;] MAIL FROM:&amp;lt;MY@TEST.com&amp;gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&amp;lt;-] 250 Ok
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;] RCPT TO:&amp;lt;reciever@TEST.com&amp;gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&amp;lt;-] 250 Ok
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;] DATA
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&amp;lt;-] 354 End data with &amp;lt;CR&amp;gt;&amp;lt;LF&amp;gt;.&amp;lt;CR&amp;gt;&amp;lt;LF&amp;gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;] Received: by vip.qq.com &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;sSMTP sendmail emulation&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; Tue, 30 Jan 2018 22:25:31 +0800
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;] Date: Tue, 30 Jan 2018 22:25:31 +0800
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;] From: root &amp;lt;MY@TEST.com&amp;gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;] To: reciever@TEST.com
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;] Subject: Mail from Router of Coffeecat
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;] Message-ID: &amp;lt;20180130142531.GA1968@Exciting.lan&amp;gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;] MIME-Version: 1.0
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;] Content-Type: multipart/mixed&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;boundary&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Nq2Wo0NMKNjxTN9z&quot;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;] Content-Disposition: inline
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;] User-Agent: Mutt/1.9.2 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;2017-12-15&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;]
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;]
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;] &lt;span class=&quot;nt&quot;&gt;--Nq2Wo0NMKNjxTN9z&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;] Content-Type: text/plain&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;charset&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;us-ascii
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;] Content-Disposition: inline
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;]
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;] HiWiFi HC5962
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;]
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;] &lt;span class=&quot;nt&quot;&gt;--Nq2Wo0NMKNjxTN9z&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;] Content-Type: text/plain&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;charset&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;us-ascii
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;] Content-Disposition: attachment&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;filename&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;maclist.txt&quot;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;] .......
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;]
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;] &lt;span class=&quot;nt&quot;&gt;--Nq2Wo0NMKNjxTN9z--&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;] &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&amp;lt;-] 250 Ok: queued as
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-&amp;gt;] QUIT
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&amp;lt;-] 221 Bye
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
</content>
 </entry>
 
 <entry>
   <title>开关openwrt/lede路由上的usb设备电源</title>
   <link href="https://jibenfa.github.io/openwrt/2017/10/11/e5bc80e585b3openwrtledee8b7afe794b1e4b88ae79a84usbe8aebee5a487e794b5e6ba90/"/>
   <updated>2017-10-11T22:25:43+00:00</updated>
   <id>https://jibenfa.github.io/openwrt/2017/10/11/e5bc80e585b3openwrtledee8b7afe794b1e4b88ae79a84usbe8aebee5a487e794b5e6ba90</id>
   <content type="html">&lt;p&gt;最近搞了个华为的usb无线网卡E8372插在lede路由上，但是想实现程序控制其供电，查阅资料后发现可以这样实现：&lt;br /&gt;
首先：&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; /sys/class/gpio/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;export&lt;/span&gt;      gpiochip32  unexport    usb3power
gpiochip0   gpiochip64  usb2power
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;由于网卡是插在usb3的口上。&lt;br /&gt;
于是：&lt;br /&gt;
要打开网卡电源：&lt;br /&gt;
echo 1 &amp;gt; /sys/class/gpio/usb3power/value&lt;br /&gt;
要关闭网卡电源：&lt;br /&gt;
echo 0 &amp;gt; /sys/class/gpio/usb3power/value&lt;/p&gt;

&lt;p&gt;上述方法可以利用网卡断电重启来解决因开机时网卡启动慢于路由启动，导致eth1 interface不能正常up的问题。&lt;/p&gt;

&lt;p&gt;参考资料：&lt;br /&gt;
https://wiki.openwrt.org/doc/howto/usb.overview&lt;/p&gt;
</content>
 </entry>
 
 <entry>
   <title>LEDE/Openwrt 挂载USB无线网卡当AP</title>
   <link href="https://jibenfa.github.io/openwrt/2017/08/20/ledeopenwrt-e68c82e8bdbdusbe697a0e7babfe7bd91e58da1e5bd93ap/"/>
   <updated>2017-08-20T12:42:57+00:00</updated>
   <id>https://jibenfa.github.io/openwrt/2017/08/20/ledeopenwrt-e68c82e8bdbdusbe697a0e7babfe7bd91e58da1e5bd93ap</id>
   <content type="html">&lt;p&gt;由于mt7621方案中mt7603e的2.4G lede驱动非常不稳定，导致我买的newifi d1、zbt wg3526、极路由4（HC5962）刷机后的2.4G基本都成了摆设。没办法只能通过挂载USB无线网卡当AP。&lt;br /&gt;
测试的USB网卡有：&lt;br /&gt;
X东购买tplink tl-wn725n v2.0 rtl8188eu （0x0bda:0x8179）安装驱动后直接无法启动路由器。。。跟作者发了邮件，回复说不支持。&lt;br /&gt;
X宝购买RT3070 杂牌网卡，安装驱动后直接无法开启ap模式，只能使用client模式。。。网上查询据说是最新的几版的驱动有问题，op老版本据说没问题，未测试。&lt;br /&gt;
X东购买磊科（netcore）NW362，rtl8192cu，安装驱动后完美ap模式。&lt;br /&gt;
以前买的tplink tl-wn821n v2.0，ar9170，安装kmod-carl9170驱动后，完美ap模式。&lt;/p&gt;
</content>
 </entry>
 
 <entry>
   <title>直插SIM卡全网五模便携LEDE路由（5200mAh）</title>
   <link href="https://jibenfa.github.io/openwrt/2017/03/19/e79bb4e68f92sime58da1e585a8e7bd91e4ba94e6a8a1e4bebfe690baledee8b7afe794b1efbc885200mahefbc89/"/>
   <updated>2017-03-19T11:42:02+00:00</updated>
   <id>https://jibenfa.github.io/openwrt/2017/03/19/e79bb4e68f92sime58da1e585a8e7bd91e4ba94e6a8a1e4bebfe690baledee8b7afe794b1efbc885200mahefbc89</id>
   <content type="html">&lt;p&gt;之前买了个ZTE Q7便携路由，也可以刷op，但是不能直接插sim卡，携带不是很方便，最近在网上逛了逛，发现了一个神器，配置为 mt7620a ROM 16M/RAM 128M 5200mAh，花了一周时间，适配了LEDE 17.07.0 正式版本系统，目前实现了几个功能：&lt;br /&gt;
1.直插sim卡上网，目前测试了移动3g和联通3g，使用的是上海移远EC20-C 4g mini pcie模块（注意经研究该模块有很多个批次，需要芯片为高通MDM9215才行，pid 05c6 vid 9215），参数为：&lt;br /&gt;
EC20-C&lt;/p&gt;

&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;FDD LTE&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; B1&lt;span class=&quot;sr&quot;&gt;/B3/&lt;/span&gt;B8
TDD LTE&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; B38&lt;span class=&quot;sr&quot;&gt;/B39/&lt;/span&gt;B40/B41
TDSCDMA&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; B34/B39
UMTS&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; B1/B8
GSM&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;900&lt;/span&gt;/&lt;span class=&quot;m&quot;&gt;1800&lt;/span&gt;MHz
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;!--more--&gt;

&lt;p&gt;&lt;br /&gt;
 &lt;img src=&quot;https://jibenfa.github.io/uploads/2017/03/IMG_20170319_104102.jpg&quot; width=&quot;1000&quot; height=&quot;618&quot; alt=&quot;AltText&quot; /&gt;
 &lt;br /&gt;&lt;/p&gt;

&lt;p&gt;参数是支持（移动4g 3g 2g，联通4g 3g 2g，电信4g）&lt;br /&gt;
原厂OP可以支持EC20-CE（高通MDM9215，pid 05c6 vid 9215，注意此CE支持电信3g）但不支持EC20-CE（高通MDM9x07，pid 2c7c vid 0125）&lt;br /&gt;
EC20-CE&lt;/p&gt;

&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;FDD LTE&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; B1/B3 
TDD LTE&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; B38&lt;span class=&quot;sr&quot;&gt;/B39/&lt;/span&gt;B40/B41 
TDSCDMA&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; B34/B39 
WCDMA&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; B1 
CDMA2000 &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;x&lt;/span&gt;/EVDO&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; BC0 
GSM&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;900&lt;/span&gt;/&lt;span class=&quot;m&quot;&gt;1800&lt;/span&gt;MHz 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;目前LEDE 17.07是4.4的kernel，开源驱动仅支持EC20-C 4g模块（芯片为高通MDM9215，pid 05c6 vid 9215），查阅linux kernel qmi_wwan.c源代码，4.10可以支持EC20-CE（高通MDM9x07，pid 2c7c vid 0125），但目前LEDE还不行。&lt;br /&gt;
2.直插SD卡，但是根据原厂说明，usb仅限对外充电，不支持外挂U盘&lt;br /&gt;
3.LEDE/OPENWRT的其他功能，例如ss等&lt;/p&gt;

&lt;p&gt;适配采用修改ZTE-Q7代码来实现（led在系统启动的时候是不亮的，启动成功后显示蓝色，囧）：&lt;br /&gt;
1.修改target/linux/ramips/base-files/etc/board.d/01_leds&lt;/p&gt;

&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;zte&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;q7&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	ucidef_set_led_default &lt;span class=&quot;s2&quot;&gt;&quot;power&quot;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;power&quot;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;$board:green:sys&quot;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;0&quot;&lt;/span&gt;
	;;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2.修改target/linux/ramips/base-files/etc/diag.sh&lt;/p&gt;

&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;zte&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;q7&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		status_led&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;$board:green:wifi&quot;&lt;/span&gt;
		;;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3.修改target/linux/ramips/dts/ZTE-Q7.dts&lt;/p&gt;

&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;sr&quot;&gt;/dts-v1/&lt;/span&gt;;

#&lt;span class=&quot;nb&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;mt7620a.dtsi&quot;&lt;/span&gt;

#&lt;span class=&quot;nb&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;dt&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;bindings&lt;span class=&quot;sr&quot;&gt;/input/&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;input&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;h&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;

/ &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;nb&quot;&gt;compatible&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;ZTE-Q7&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;ralink,mt7620a-soc&quot;&lt;/span&gt;;
	model &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;ZTE Q7&quot;&lt;/span&gt;;

	gpio&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;leds &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;nb&quot;&gt;compatible&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;gpio-leds&quot;&lt;/span&gt;;

		usb &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			label &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;zte-q7:usb&quot;&lt;/span&gt;;
			gpios &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&amp;amp;gpio0 &lt;span class=&quot;m&quot;&gt;11&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;;
		sys &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			label &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;zte-q7:sys&quot;&lt;/span&gt;;
			gpios &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&amp;amp;gpio1 &lt;span class=&quot;m&quot;&gt;14&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;;
		wlan &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			label &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;zte-q7:wlan&quot;&lt;/span&gt;;
			gpios &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&amp;amp;gpio3 &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;;
		wps &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			label &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;zte-q7:wps&quot;&lt;/span&gt;;
			gpios &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&amp;amp;gpio1 &lt;span class=&quot;m&quot;&gt;15&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;;

	gpio&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;keys&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;polled &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;nb&quot;&gt;compatible&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;gpio-keys-polled&quot;&lt;/span&gt;;
		#address&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;cells &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;;
		#size&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;cells &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;;
		poll&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;interval &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;;

		reset &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			label &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;reset&quot;&lt;/span&gt;;
			gpios &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&amp;amp;gpio0 &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;;
			linux&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;code &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;x198&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;;

&amp;amp;gpio0 &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	status &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;okay&quot;&lt;/span&gt;;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;;

&amp;amp;gpio1 &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	status &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;okay&quot;&lt;/span&gt;;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;;

&amp;amp;gpio3 &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	status &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;okay&quot;&lt;/span&gt;;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;;

&amp;amp;spi0 &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	status &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;okay&quot;&lt;/span&gt;;

	en25q128@&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		#address&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;cells &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;;
		#size&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;cells &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;;
		&lt;span class=&quot;nb&quot;&gt;compatible&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;w25q128&quot;&lt;/span&gt;;
		&lt;span class=&quot;k&quot;&gt;reg&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;;
		linux&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;modalias &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;m25p80&quot;&lt;/span&gt;;
		spi&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;frequency &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10000000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;;

		partition@&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			label &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;u-boot&quot;&lt;/span&gt;;
			&lt;span class=&quot;k&quot;&gt;reg&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;x0 &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;x30000&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;;
			&lt;span class=&quot;k&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;only&lt;/span&gt;;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;;

		partition@&lt;span class=&quot;m&quot;&gt;30000&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			label &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;u-boot-env&quot;&lt;/span&gt;;
			&lt;span class=&quot;k&quot;&gt;reg&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;x30000 &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;x10000&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;;
			&lt;span class=&quot;k&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;only&lt;/span&gt;;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;;

		factory&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; partition@&lt;span class=&quot;m&quot;&gt;40000&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			label &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;factory&quot;&lt;/span&gt;;
			&lt;span class=&quot;k&quot;&gt;reg&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;x40000 &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;x10000&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;;
			&lt;span class=&quot;k&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;only&lt;/span&gt;;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;;

		partition@&lt;span class=&quot;m&quot;&gt;50000&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			label &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;firmware&quot;&lt;/span&gt;;
			&lt;span class=&quot;k&quot;&gt;reg&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;x50000 &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;xfb0000&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;;

&amp;amp;pinctrl &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	state_default&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; pinctrl0 &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		gpio &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
				ralink&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;group &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;i2c&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;uartf&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;wled&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;spi refclk&quot;&lt;/span&gt;;
				ralink&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;gpio&quot;&lt;/span&gt;;
			&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;;
                        &lt;span class=&quot;k&quot;&gt;pa&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                                ralink&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;group &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;pa&quot;&lt;/span&gt;;
                                ralink&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;pa&quot;&lt;/span&gt;;
                        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;;

&amp;amp;ethernet &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	pinctrl&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;names &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;default&quot;&lt;/span&gt;;
	pinctrl&lt;span class=&quot;m&quot;&gt;-0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&amp;amp;ephy_pins&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;;
	mtd&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;mac&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;address &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&amp;amp;factory &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;x4&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;;
	mediatek&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;portmap &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;wllll&quot;&lt;/span&gt;;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;;

&amp;amp;wmac &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	ralink&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;mtd&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;eeprom &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&amp;amp;factory &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;;

&amp;amp;sdhci &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	status &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;okay&quot;&lt;/span&gt;;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;;

&amp;amp;ehci &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	status &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;okay&quot;&lt;/span&gt;;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;;

&amp;amp;ohci &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	status &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;okay&quot;&lt;/span&gt;;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;;

&amp;amp;pcie &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	status &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;okay&quot;&lt;/span&gt;;

	&lt;span class=&quot;nb&quot;&gt;compatible&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;ralink,mt7620a-pci&quot;&lt;/span&gt;;
		&lt;span class=&quot;k&quot;&gt;reg&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;x10140000 &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;x100
			&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;x10142000 &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;x100&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;;

		resets &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&amp;amp;rstctrl &lt;span class=&quot;m&quot;&gt;26&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;;
		reset&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;names &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;pcie0&quot;&lt;/span&gt;;

		&lt;span class=&quot;nb&quot;&gt;interrupt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;parent &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&amp;amp;cpuintc&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;;
		interrupts &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;;



&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;最后编译的时候，选择&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;git clone https://git.lede-project.org/source.git
git fetch &lt;span class=&quot;nt&quot;&gt;--tags&lt;/span&gt;
git tag &lt;span class=&quot;nt&quot;&gt;-l&lt;/span&gt;
git checkout v17.01.0
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;参考：&lt;br /&gt;
1.http://lists.infradead.org/pipermail/lede-commits/2016-September/000876.html&lt;br /&gt;
2.https://lists.openwrt.org/pipermail/openwrt-devel/2015-March/032268.html&lt;br /&gt;
3.http://lxr.free-electrons.com/source/drivers/net/usb/qmi_wwan.c&lt;/p&gt;
</content>
 </entry>
 
 <entry>
   <title>利用Openwrt路由部署Openvpn进行两地组网</title>
   <link href="https://jibenfa.github.io/openwrt/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/2017/03/07/e588a9e794a8openwrte8b7afe794b1e983a8e7bdb2openvpne8bf9be8a18ce4b8a4e59cb0e7bb84e7bd91/"/>
   <updated>2017-03-07T08:42:43+00:00</updated>
   <id>https://jibenfa.github.io/openwrt/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/2017/03/07/e588a9e794a8openwrte8b7afe794b1e983a8e7bdb2openvpne8bf9be8a18ce4b8a4e59cb0e7bb84e7bd91</id>
   <content type="html">&lt;p&gt;最近实践了一下利用Openwrt路由部署Openvpn进行两地组网，目标是实现两个局域网互相访问。&lt;br /&gt;
配置：&lt;br /&gt;
1.Openvpn服务端（内部局域网段172.24.1.0/24）：&lt;br /&gt;
首先/etc/config/network配置加一个interface：&lt;/p&gt;

&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;config interface &lt;span class=&quot;s1&quot;&gt;&apos;vpn1&apos;&lt;/span&gt;
    option proto &lt;span class=&quot;s1&quot;&gt;&apos;none&apos;&lt;/span&gt;
    option ifname &lt;span class=&quot;s1&quot;&gt;&apos;tun1&apos;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;/etc/config/openvpn文件增加内容：&lt;br /&gt;
&lt;!--more--&gt;&lt;/p&gt;

&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; 
config openvpn &lt;span class=&quot;s1&quot;&gt;&apos;tun_router&apos;&lt;/span&gt;
        option port &lt;span class=&quot;s1&quot;&gt;&apos;3377&apos;&lt;/span&gt;
        option proto &lt;span class=&quot;s1&quot;&gt;&apos;tcp&apos;&lt;/span&gt;
        option dev &lt;span class=&quot;s1&quot;&gt;&apos;tun1&apos;&lt;/span&gt;
        option &lt;span class=&quot;k&quot;&gt;ca&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;/etc/openvpn/ca.crt&apos;&lt;/span&gt;
        option cert &lt;span class=&quot;s1&quot;&gt;&apos;/etc/openvpn/server.crt&apos;&lt;/span&gt;
        option &lt;span class=&quot;nb&quot;&gt;key&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;/etc/openvpn/server.key&apos;&lt;/span&gt;
        option dh &lt;span class=&quot;s1&quot;&gt;&apos;/etc/openvpn/dh2048.pem&apos;&lt;/span&gt;
        option server &lt;span class=&quot;s1&quot;&gt;&apos;10.0.1.0 255.255.255.0&apos;&lt;/span&gt;
        option client_config_dir &lt;span class=&quot;s1&quot;&gt;&apos;/etc/openvpn/ccd&apos;&lt;/span&gt;
        option ccd_exclusive &lt;span class=&quot;s1&quot;&gt;&apos;1&apos;&lt;/span&gt;
        option ifconfig_pool_persist &lt;span class=&quot;s1&quot;&gt;&apos;/tmp/ipp3.txt&apos;&lt;/span&gt;
        option client_to_client &lt;span class=&quot;s1&quot;&gt;&apos;1&apos;&lt;/span&gt;
        option keepalive &lt;span class=&quot;s1&quot;&gt;&apos;10 120&apos;&lt;/span&gt;
        option compress &lt;span class=&quot;s1&quot;&gt;&apos;lzo&apos;&lt;/span&gt;
        option persist_key &lt;span class=&quot;s1&quot;&gt;&apos;1&apos;&lt;/span&gt;
        option persist_tun &lt;span class=&quot;s1&quot;&gt;&apos;1&apos;&lt;/span&gt;
        option status &lt;span class=&quot;s1&quot;&gt;&apos;/tmp/openvpn-status3.log&apos;&lt;/span&gt;
        option &lt;span class=&quot;k&quot;&gt;verb&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;3&apos;&lt;/span&gt;
        option enabled &lt;span class=&quot;s1&quot;&gt;&apos;1&apos;&lt;/span&gt;
        option topology &lt;span class=&quot;s1&quot;&gt;&apos;subnet&apos;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;list&lt;/span&gt; push &lt;span class=&quot;s1&quot;&gt;&apos;route 172.24.1.0 255.255.255.0&apos;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;list&lt;/span&gt; route &lt;span class=&quot;s1&quot;&gt;&apos;172.24.8.0 255.255.255.0&apos;&lt;/span&gt;


&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;/etc/openvpn/ccd文件夹内增加一个文件，文件名为客户端证书的common name，例如tbjj，内容为：&lt;/p&gt;

&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ifconfig&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;push &lt;span class=&quot;s2&quot;&gt;&quot;10.0.1.6 255.255.255.0&quot;&lt;/span&gt;
iroute &lt;span class=&quot;m&quot;&gt;172&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;255&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;255&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;255&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;然后在防火墙自定义规则里面添加：&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;iptables &lt;span class=&quot;nt&quot;&gt;-I&lt;/span&gt; INPUT 1 &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; tcp &lt;span class=&quot;nt&quot;&gt;--dport&lt;/span&gt; 3377 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; ACCEPT
iptables &lt;span class=&quot;nt&quot;&gt;-I&lt;/span&gt; INPUT 1 &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; udp &lt;span class=&quot;nt&quot;&gt;--dport&lt;/span&gt; 3377 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; ACCEPT
iptables &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; FORWARD &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; tun1 &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; 10.0.1.0/24 &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 172.24.1.0/24 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; ACCEPT
iptables &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; FORWARD &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; tun1 &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; 172.24.8.0/24 &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 172.24.1.0/24 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; ACCEPT
iptables &lt;span class=&quot;nt&quot;&gt;-I&lt;/span&gt; INPUT &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; tun1 &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; 172.24.8.0/24 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; ACCEPT
iptables &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; FORWARD &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; tun1 &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; 172.24.1.0/24 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; ACCEPT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2.Openvpn客户端（内部局域网段172.24.8.0/24）：&lt;br /&gt;
首先/etc/config/network配置加一个interface：&lt;/p&gt;

&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;config interface &lt;span class=&quot;s1&quot;&gt;&apos;vpn1&apos;&lt;/span&gt;
    option proto &lt;span class=&quot;s1&quot;&gt;&apos;none&apos;&lt;/span&gt;
    option ifname &lt;span class=&quot;s1&quot;&gt;&apos;tun1&apos;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;/etc/config/openvpn文件增加内容：&lt;/p&gt;

&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
config openvpn &lt;span class=&quot;s1&quot;&gt;&apos;vpn_client&apos;&lt;/span&gt;
        option client &lt;span class=&quot;s1&quot;&gt;&apos;1&apos;&lt;/span&gt;
        option dev &lt;span class=&quot;s1&quot;&gt;&apos;tun1&apos;&lt;/span&gt;
        option proto &lt;span class=&quot;s1&quot;&gt;&apos;tcp&apos;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;list&lt;/span&gt; remote &lt;span class=&quot;s1&quot;&gt;&apos;远端地址 3377&apos;&lt;/span&gt;
        option remote_cert_tls &lt;span class=&quot;s1&quot;&gt;&apos;server&apos;&lt;/span&gt;
        option remote_random &lt;span class=&quot;s1&quot;&gt;&apos;1&apos;&lt;/span&gt;
        option resolv_retry &lt;span class=&quot;s1&quot;&gt;&apos;infinite&apos;&lt;/span&gt;
        option persist_key &lt;span class=&quot;s1&quot;&gt;&apos;1&apos;&lt;/span&gt;
        option persist_tun &lt;span class=&quot;s1&quot;&gt;&apos;1&apos;&lt;/span&gt;
        option &lt;span class=&quot;k&quot;&gt;ca&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;/etc/openvpn/ca.crt&apos;&lt;/span&gt;
        option cert &lt;span class=&quot;s1&quot;&gt;&apos;/etc/openvpn/tbjj.crt&apos;&lt;/span&gt;
        option &lt;span class=&quot;nb&quot;&gt;key&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;/etc/openvpn/tbjj.key&apos;&lt;/span&gt;
        option compress &lt;span class=&quot;s1&quot;&gt;&apos;lzo&apos;&lt;/span&gt;
        option &lt;span class=&quot;k&quot;&gt;verb&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;3&apos;&lt;/span&gt;
        option enabled &lt;span class=&quot;s1&quot;&gt;&apos;1&apos;&lt;/span&gt;
        option nobind &lt;span class=&quot;s1&quot;&gt;&apos;1&apos;&lt;/span&gt;
        option auth_nocache &lt;span class=&quot;s1&quot;&gt;&apos;1&apos;&lt;/span&gt;

        
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;然后防火墙自定义规则添加：&lt;/p&gt;

&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;iptables &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;I INPUT &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;p&lt;/span&gt; tcp &lt;span class=&quot;p&quot;&gt;--&lt;/span&gt;dport &lt;span class=&quot;m&quot;&gt;1195&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;j&lt;/span&gt; ACCEPT
iptables &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;I INPUT &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;p&lt;/span&gt; udp &lt;span class=&quot;p&quot;&gt;--&lt;/span&gt;dport &lt;span class=&quot;m&quot;&gt;1195&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;j&lt;/span&gt; ACCEPT
iptables &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;A FORWARD &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;i&lt;/span&gt; tun1 &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;s &lt;span class=&quot;m&quot;&gt;172&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt;/24 -d 172.24.8.0/&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;24&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;j&lt;/span&gt; ACCEPT
iptables &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;I INPUT &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;i&lt;/span&gt; tun1 &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;s &lt;span class=&quot;m&quot;&gt;172&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;/&lt;span class=&quot;m&quot;&gt;24&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;j&lt;/span&gt; ACCEPT
iptables &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;A FORWARD &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;i&lt;/span&gt; tun1 &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;s &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt;/24 -d 172.24.8.0/&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;24&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;j&lt;/span&gt; ACCEPT
iptables &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;A FORWARD &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;o&lt;/span&gt; tun1 &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;s &lt;span class=&quot;m&quot;&gt;172&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;/&lt;span class=&quot;m&quot;&gt;24&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;j&lt;/span&gt; ACCEPT
 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3.最后重启两个路由，2个局域网就可以互相访问了。&lt;/p&gt;

&lt;p&gt;参考资料：&lt;br /&gt;
1.http://blog.ltns.info/linux/connect_two_home_networks_using_openvpn_and_openwrt/&lt;/p&gt;
</content>
 </entry>
 

</feed>
